import React, { useState, useEffect, useRef } from "react";
import { calculateSaju } from '@fullstackfamily/manseryeok';

// ============================================================
// ê¸°ì´ˆ ë°ì´í„°
// ============================================================
const ì²œê°„=['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
const ì§€ì§€=['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
const ì²œê°„í•œ=['ê°‘','ì„','ë³‘','ì •','ë¬´','ê¸°','ê²½','ì‹ ','ì„','ê³„'];
const ì§€ì§€í•œ=['ì','ì¶•','ì¸','ë¬˜','ì§„','ì‚¬','ì˜¤','ë¯¸','ì‹ ','ìœ ','ìˆ ','í•´'];
const ì²œê°„ì˜¤í–‰={'ç”²':'ëª©','ä¹™':'ëª©','ä¸™':'í™”','ä¸':'í™”','æˆŠ':'í† ','å·±':'í† ','åºš':'ê¸ˆ','è¾›':'ê¸ˆ','å£¬':'ìˆ˜','ç™¸':'ìˆ˜'};
const ì§€ì§€ì˜¤í–‰={'å­':'ìˆ˜','ä¸‘':'í† ','å¯…':'ëª©','å¯':'ëª©','è¾°':'í† ','å·³':'í™”','åˆ':'í™”','æœª':'í† ','ç”³':'ê¸ˆ','é…‰':'ê¸ˆ','æˆŒ':'í† ','äº¥':'ìˆ˜'};
const ì²œê°„ìŒì–‘={'ç”²':'ì–‘','ä¹™':'ìŒ','ä¸™':'ì–‘','ä¸':'ìŒ','æˆŠ':'ì–‘','å·±':'ìŒ','åºš':'ì–‘','è¾›':'ìŒ','å£¬':'ì–‘','ç™¸':'ìŒ'};
const ì˜¤í–‰ìƒ‰={'ëª©':'#4a8a4a','í™”':'#c44040','í† ':'#b48c50','ê¸ˆ':'#8a8a8a','ìˆ˜':'#4a6a9a'};
const ìƒìƒ={'ëª©':'í™”','í™”':'í† ','í† ':'ê¸ˆ','ê¸ˆ':'ìˆ˜','ìˆ˜':'ëª©'};
const ìƒê·¹={'ëª©':'í† ','í† ':'ìˆ˜','ìˆ˜':'í™”','í™”':'ê¸ˆ','ê¸ˆ':'ëª©'};
const ì •ê¸°T={'å­':'ç™¸','ä¸‘':'å·±','å¯…':'ç”²','å¯':'ä¹™','è¾°':'æˆŠ','å·³':'ä¸™','åˆ':'ä¸','æœª':'å·±','ç”³':'åºš','é…‰':'è¾›','æˆŒ':'æˆŠ','äº¥':'å£¬'};
const ì§€ì¥ê°„T={'å­':['å£¬','ç™¸'],'ä¸‘':['ç™¸','è¾›','å·±'],'å¯…':['æˆŠ','ä¸™','ç”²'],'å¯':['ç”²','ä¹™'],'è¾°':['ä¹™','ç™¸','æˆŠ'],'å·³':['æˆŠ','åºš','ä¸™'],'åˆ':['ä¸™','å·±','ä¸'],'æœª':['ä¸','ä¹™','å·±'],'ç”³':['å·±','å£¬','åºš'],'é…‰':['åºš','è¾›'],'æˆŒ':['è¾›','ä¸','æˆŠ'],'äº¥':['æˆŠ','ç”²','å£¬']};

function ì‹­ì„±(ì¼ê°„,ëŒ€ìƒ){
  const a=ì²œê°„ì˜¤í–‰[ì¼ê°„],b=ì²œê°„ì˜¤í–‰[ëŒ€ìƒ],s=ì²œê°„ìŒì–‘[ì¼ê°„]===ì²œê°„ìŒì–‘[ëŒ€ìƒ];
  if(a===b)return s?'ë¹„ê²¬':'ê²ì¬';if(ìƒìƒ[a]===b)return s?'ì‹ì‹ ':'ìƒê´€';if(ìƒê·¹[a]===b)return s?'í¸ì¬':'ì •ì¬';
  if(ìƒê·¹[b]===a)return s?'í¸ê´€':'ì •ê´€';if(ìƒìƒ[b]===a)return s?'í¸ì¸':'ì •ì¸';return'';
}

// ============================================================
// ë§Œì„¸ë ¥ ë³€í™˜ (@fullstackfamily/manseryeok ë¼ì´ë¸ŒëŸ¬ë¦¬)
// ============================================================
const CITIES=[
  {v:127,l:'ì„œìš¸ (-32ë¶„)'},{v:126.7,l:'ì¸ì²œ (-33ë¶„)'},{v:127.4,l:'ëŒ€ì „ (-30ë¶„)'},
  {v:126.9,l:'ê´‘ì£¼ (-32ë¶„)'},{v:128.6,l:'ëŒ€êµ¬ (-26ë¶„)'},{v:129,l:'ë¶€ì‚° (-24ë¶„)'},
  {v:129,l:'ìš¸ì‚° (-24ë¶„)'},{v:127,l:'ìˆ˜ì› (-32ë¶„)'},{v:126.7,l:'ì„¸ì¢… (-33ë¶„)'},
  {v:128.9,l:'ê°•ë¦‰ (-24ë¶„)'},{v:126.5,l:'ì œì£¼ (-34ë¶„)'},{v:126.9,l:'ì „ì£¼ (-32ë¶„)'},
  {v:129,l:'í¬í•­ (-24ë¶„)'},{v:128.1,l:'ì¶˜ì²œ (-28ë¶„)'},{v:127.2,l:'ì²­ì£¼ (-31ë¶„)'},
  {v:135,l:'ë³´ì •ì—†ìŒ (í•´ì™¸ ë“±)'}
];

function birthToSaju(year,month,day,hour,gender,longitude){
  // ì‹œ ëª¨ë¦„ì´ë©´ ì‹œì£¼ ì—†ì´ ê³„ì‚°
  if(hour<0){
    const s=calculateSaju(year,month,day,undefined,undefined,{longitude:longitude||127,applyTimeCorrection:!!longitude});
    return{yg:s.yearPillarHanja[0],yj:s.yearPillarHanja[1],mg:s.monthPillarHanja[0],mj:s.monthPillarHanja[1],dg:s.dayPillarHanja[0],dj:s.dayPillarHanja[1],hg:'?',hj:'?',gender:gender||'ë‚¨'};
  }
  const s=calculateSaju(year,month,day,hour,0,{longitude:longitude||127,applyTimeCorrection:true});
  return{yg:s.yearPillarHanja[0],yj:s.yearPillarHanja[1],mg:s.monthPillarHanja[0],mj:s.monthPillarHanja[1],dg:s.dayPillarHanja[0],dj:s.dayPillarHanja[1],hg:s.hourPillarHanja[0],hj:s.hourPillarHanja[1],gender:gender||'ë‚¨'};
}

// ë°”ë¦¬ë§Œì‹  ë§íˆ¬ ë³€í™˜ (ì¡´ëŒ“ë§â†’ë¬´ë‹¹ì²´)
function toMansin(t){
  if(!t||typeof t!=='string')return t;
  t=t.replace(/ê°€ëŠ¥í•©ë‹ˆë‹¤/g,'ê°€ëŠ¥í•˜ë‹ˆë¼');
  t=t.replace(/ìˆìŠµë‹ˆë‹¤/g,'ìˆëŠë‹ˆë¼');
  t=t.replace(/ì—†ìŠµë‹ˆë‹¤/g,'ì—†ëŠë‹ˆë¼');
  t=t.replace(/ë©ë‹ˆë‹¤/g,'ë˜ëŠë‹ˆë¼');
  t=t.replace(/ì…ë‹ˆë‹¤/g,'ì´ë‹ˆë¼');
  t=t.replace(/í•©ë‹ˆë‹¤/g,'í•˜ëŠë‹ˆë¼');
  t=t.replace(/ìŠµë‹ˆë‹¤/g,'ëŠë‹ˆë¼');
  t=t.replace(/í•˜ì„¸ìš”/g,'í•˜ê±°ë¼');
  t=t.replace(/ì„¸ìš”\./g,'ê±°ë¼.');
  t=t.replace(/ë³´ì„¸ìš”/g,'ë³´ê±°ë¼');
  t=t.replace(/ì‹­ì‹œì˜¤/g,'ê±°ë¼');
  t=t.replace(/ê² ì§€ë§Œ/g,'ê² ìœ¼ë‚˜');
  t=t.replace(/ìˆ˜ ìˆìœ¼ë‹ˆ/g,'ìˆ˜ ìˆìœ¼ë‹ˆ');
  return t;
}

// ============================================================
// ë¶„ì„ ì—”ì§„
// ============================================================
function analyze(s){
  const G=[s.yg,s.mg,s.dg,s.hg], Z=[s.yj,s.mj,s.dj,s.hj];
  const ì¼ê°„=s.dg, ì¼ì§€=s.dj, gender=s.gender;
  
  // ì˜¤í–‰ ë¶„í¬
  const ì˜¤í–‰ì¹´ìš´íŠ¸={ëª©:0,í™”:0,í† :0,ê¸ˆ:0,ìˆ˜:0};
  G.forEach(g=>{if(ì²œê°„ì˜¤í–‰[g])ì˜¤í–‰ì¹´ìš´íŠ¸[ì²œê°„ì˜¤í–‰[g]]++;});
  Z.forEach(z=>{if(ì§€ì§€ì˜¤í–‰[z])ì˜¤í–‰ì¹´ìš´íŠ¸[ì§€ì§€ì˜¤í–‰[z]]++;});
  const ì „ë¬´=Object.keys(ì˜¤í–‰ì¹´ìš´íŠ¸).filter(k=>ì˜¤í–‰ì¹´ìš´íŠ¸[k]===0);
  const ê³¼ë‹¤=Object.keys(ì˜¤í–‰ì¹´ìš´íŠ¸).filter(k=>ì˜¤í–‰ì¹´ìš´íŠ¸[k]>=3);
  const total=Object.values(ì˜¤í–‰ì¹´ìš´íŠ¸).reduce((a,b)=>a+b,0);
  
  // ì‹­ì„± ê³„ì‚° (8ì ì „ì²´)
  const ì‹­ì„±ë“¤=[];
  const ì‹­ì„±ì¹´ìš´íŠ¸={ë¹„ê²¬:0,ê²ì¬:0,ì‹ì‹ :0,ìƒê´€:0,í¸ì¬:0,ì •ì¬:0,í¸ê´€:0,ì •ê´€:0,í¸ì¸:0,ì •ì¸:0};
  [...G,...Z].forEach(ch=>{
    if(ch==='?')return;
    const oh=ì²œê°„ì˜¤í–‰[ch]||ì²œê°„ì˜¤í–‰[ì •ê¸°T[ch]];
    const target=ì²œê°„ì˜¤í–‰[ch]?ch:ì •ê¸°T[ch];
    if(target){const ss=ì‹­ì„±(ì¼ê°„,target);if(ss){ì‹­ì„±ë“¤.push(ss);ì‹­ì„±ì¹´ìš´íŠ¸[ss]++;}}
  });
  
  // ê°•ì•½ íŒì •
  const ì•„êµ°=ì‹­ì„±ì¹´ìš´íŠ¸.ë¹„ê²¬+ì‹­ì„±ì¹´ìš´íŠ¸.ê²ì¬+ì‹­ì„±ì¹´ìš´íŠ¸.í¸ì¸+ì‹­ì„±ì¹´ìš´íŠ¸.ì •ì¸;
  const ì êµ°=ì‹­ì„±ì¹´ìš´íŠ¸.ì‹ì‹ +ì‹­ì„±ì¹´ìš´íŠ¸.ìƒê´€+ì‹­ì„±ì¹´ìš´íŠ¸.í¸ì¬+ì‹­ì„±ì¹´ìš´íŠ¸.ì •ì¬+ì‹­ì„±ì¹´ìš´íŠ¸.í¸ê´€+ì‹­ì„±ì¹´ìš´íŠ¸.ì •ê´€;
  const ê°•ì•½=ì•„êµ°>=ì êµ°?'ì‹ ê°•':'ì‹ ì•½';
  
  // ìš©ì‹ 
  let ìš©ì‹ ì˜¤í–‰;
  if(ê°•ì•½==='ì‹ ê°•'){
    ìš©ì‹ ì˜¤í–‰=Object.keys(ìƒê·¹).find(k=>ìƒê·¹[k]===ì²œê°„ì˜¤í–‰[ì¼ê°„])||'ê¸ˆ';
  } else {
    ìš©ì‹ ì˜¤í–‰=ì²œê°„ì˜¤í–‰[ì¼ê°„];
  }
  
  // ê²©êµ­
  const ì›”ì§€ì •ê¸°=ì •ê¸°T[s.mj];
  const ê²©êµ­ì‹­ì„±=ì‹­ì„±(ì¼ê°„,ì›”ì§€ì •ê¸°);
  const ê²©êµ­ì´ë¦„=ê²©êµ­ì‹­ì„±+'ê²©';
  
  // ì¶© ê°ì§€
  const ì¶©ìŒ=[['å­','åˆ'],['ä¸‘','æœª'],['å¯…','ç”³'],['å¯','é…‰'],['è¾°','æˆŒ'],['å·³','äº¥']];
  const ì¶©ëª©ë¡=[];
  const ìœ„ì¹˜=['ì—°','ì›”','ì¼','ì‹œ'];
  for(let i=0;i<4;i++)for(let j=i+1;j<4;j++){
    for(const[a,b]of ì¶©ìŒ){
      if((Z[i]===a&&Z[j]===b)||(Z[i]===b&&Z[j]===a)){
        ì¶©ëª©ë¡.push({ìœ„ì¹˜:`${ìœ„ì¹˜[i]}${ìœ„ì¹˜[j]}`,ì§€1:Z[i],ì§€2:Z[j]});
      }
    }
  }
  
  // í˜•ì‚´ ê°ì§€
  const í˜•ìŒ=[['å¯…','å·³','ç”³','ì¸ì‚¬ì‹  ì‚¼í˜•'],['ä¸‘','æˆŒ','æœª','ì¶•ìˆ ë¯¸ ì‚¼í˜•'],['å­','å¯','','ìë¬˜í˜•'],['è¾°','è¾°','','ì§„ì§„ ìí˜•'],['åˆ','åˆ','','ì˜¤ì˜¤ ìí˜•'],['é…‰','é…‰','','ìœ ìœ  ìí˜•'],['äº¥','äº¥','','í•´í•´ ìí˜•']];
  const í˜•ëª©ë¡=[];
  for(const[a,b,c,name]of í˜•ìŒ){
    const has=z=>Z.includes(z);
    if(c){if(has(a)&&has(b)&&has(c))í˜•ëª©ë¡.push(name);}
    else if(a===b){const cnt=Z.filter(z=>z===a).length;if(cnt>=2)í˜•ëª©ë¡.push(name);}
    else{if(has(a)&&has(b))í˜•ëª©ë¡.push(name);}
  }
  
  // í•© ê°ì§€
  const ìœ¡í•©ìŒ=[['å­','ä¸‘','í† '],['å¯…','äº¥','ëª©'],['å¯','æˆŒ','í™”'],['è¾°','é…‰','ê¸ˆ'],['å·³','ç”³','ìˆ˜'],['åˆ','æœª','í™”']];
  const í•©ëª©ë¡=[];
  for(const[a,b,o]of ìœ¡í•©ìŒ){
    if(Z.includes(a)&&Z.includes(b))í•©ëª©ë¡.push(`${a}${b}í•©(${o})`);
  }
  
  // ì‚¼í•©
  const ì‚¼í•©ìŒ=[['ç”³','å­','è¾°','ìˆ˜'],['å¯…','åˆ','æˆŒ','í™”'],['å·³','é…‰','ä¸‘','ê¸ˆ'],['äº¥','å¯','æœª','ëª©']];
  for(const[a,b,c,o]of ì‚¼í•©ìŒ){
    if(Z.includes(a)&&Z.includes(b)&&Z.includes(c))í•©ëª©ë¡.push(`${a}${b}${c}ì‚¼í•©(${o})`);
  }

  // ==============================
  // ì¹´í…Œê³ ë¦¬ë³„ ì ìˆ˜ ì‚°ì¶œ
  // ==============================
  
  // ê±´ê°• ì¥ê¸° ë§¤í•‘
  const ì˜¤í–‰ì¥ê¸°={ëª©:{ì¥:'ê°„',ë¶€:'ë‹´'},í™”:{ì¥:'ì‹¬ì¥',ë¶€:'ì†Œì¥'},í† :{ì¥:'ë¹„ì¥',ë¶€:'ìœ„'},ê¸ˆ:{ì¥:'í',ë¶€:'ëŒ€ì¥'},ìˆ˜:{ì¥:'ì‹ ì¥',ë¶€:'ë°©ê´‘'}};
  const ê±´ê°•ê²½ê³ =[];
  ì „ë¬´.forEach(oh=>{
    const organ=ì˜¤í–‰ì¥ê¸°[oh];
    if(organ)ê±´ê°•ê²½ê³ .push(`${organ.ì¥}[${oh}] í—ˆì•½í•˜ë‹ˆ ì£¼ì˜í•´`);
  });
  ê³¼ë‹¤.forEach(oh=>{
    const organ=ì˜¤í–‰ì¥ê¸°[oh];
    if(organ)ê±´ê°•ê²½ê³ .push(`${organ.ë¶€}[${oh}] ê³¼ë‹¤ â€” ì—´/ì—¼ì¦ ì¡°ì‹¬í•´`);
  });
  ì¶©ëª©ë¡.forEach(c=>{
    if(c.ìœ„ì¹˜==='ì¼ì‹œ')ê±´ê°•ê²½ê³ .push('ì¼ì‹œì¶© â€” ë§ë…„ì— ê±´ê°• ë³€ë™ì´ ì˜¬ ìˆ˜ ìˆì–´');
  });

  // ê´€ê³„ ì ìˆ˜ ì‚°ì¶œ í•¨ìˆ˜
  function relScore(ì‹­ì„±1, ì‹­ì„±2) {
    // í•´ë‹¹ ì‹­ì„±ì´ ì›êµ­ì— ì–¼ë§ˆë‚˜ ìˆëŠ”ì§€ + í†µê·¼ ì—¬ë¶€ë¡œ ì ìˆ˜ ì‚°ì¶œ
    const cnt1=ì‹­ì„±ì¹´ìš´íŠ¸[ì‹­ì„±1]||0, cnt2=ì‹­ì„±ì¹´ìš´íŠ¸[ì‹­ì„±2]||0;
    const base=40;
    const bonus=(cnt1+cnt2)*15;
    const ì¶©íŒ¨ë„í‹°=ì¶©ëª©ë¡.length*5;
    return Math.min(95, Math.max(15, base+bonus-ì¶©íŒ¨ë„í‹°+Math.floor(Math.random()*10)));
  }
  
  // ì¸ì—°ë„ (ì‹­ì„± ì¡´ì¬â†’ì¸ì—° ìˆìŒ)
  function ì¸ì—°(ì‹­ì„±1,ì‹­ì„±2){
    const cnt=ì‹­ì„±ì¹´ìš´íŠ¸[ì‹­ì„±1]+ì‹­ì„±ì¹´ìš´íŠ¸[ì‹­ì„±2];
    if(cnt>=2)return{ë“±ê¸‰:'ê¹Šì€ ì¸ì—°',ì ìˆ˜:80+Math.floor(Math.random()*10)};
    if(cnt===1)return{ë“±ê¸‰:'í‰ë²”í•œ ì¸ì—°',ì ìˆ˜:50+Math.floor(Math.random()*15)};
    return{ë“±ê¸‰:'ì¸ì—°ì´ ì–•ìŒ',ì ìˆ˜:25+Math.floor(Math.random()*15)};
  }
  
  // ë³µë• (í†µê·¼+í•© ì—¬ë¶€ë¡œ)
  function ë³µë•(ì‹­ì„±1,ì‹­ì„±2){
    const cnt=ì‹­ì„±ì¹´ìš´íŠ¸[ì‹­ì„±1]+ì‹­ì„±ì¹´ìš´íŠ¸[ì‹­ì„±2];
    const í•©bonus=í•©ëª©ë¡.length>0?10:0;
    if(cnt>=2)return{ë“±ê¸‰:'ë³µë• ìˆìŒ',ì ìˆ˜:70+í•©bonus};
    if(cnt===1)return{ë“±ê¸‰:'ê°ˆë“±ê³¼ ë³µë• ê³µì¡´',ì ìˆ˜:45+í•©bonus};
    return{ë“±ê¸‰:'ë³µë• ë¶€ì¡±',ì ìˆ˜:20+í•©bonus};
  }

  // ì„±ê²© ì›ë§Œì„±
  const ì„±ê²©ì ìˆ˜=(() => {
    let sc=50;
    if(ê°•ì•½==='ì‹ ê°•')sc+=5; else sc-=5;
    sc+=í•©ëª©ë¡.length*8;
    sc-=ì¶©ëª©ë¡.length*10;
    sc-=í˜•ëª©ë¡.length*8;
    if(ì „ë¬´.length>0)sc-=8;
    if(ì‹­ì„±ì¹´ìš´íŠ¸.ìƒê´€>=2)sc-=10;
    if(ì‹­ì„±ì¹´ìš´íŠ¸.ì •ì¸>=1)sc+=5;
    if(ì‹­ì„±ì¹´ìš´íŠ¸.ì‹ì‹ >=1)sc+=5;
    return Math.min(90,Math.max(15,sc));
  })();
  
  const ì„±ê²©íŠ¹ì§•=[];
  if(ì‹­ì„±ì¹´ìš´íŠ¸.ìƒê´€>=2)ì„±ê²©íŠ¹ì§•.push('ì›ë§Œí•˜ì§€ ëª»í•˜ê³  ê²°ì ë„ ë§ì•„');
  else if(ì„±ê²©ì ìˆ˜>=65)ì„±ê²©íŠ¹ì§•.push('ëŒ€ì²´ë¡œ ì›ë§Œí•˜ê³  ì‚¬êµì„±ì´ ì¢‹ì•„');
  else ì„±ê²©íŠ¹ì§•.push('ë‚´ì„±ì ì´ê³  ìê¸° ì£¼ì¥ì´ ê°•í•œ í¸ì´ì•¼');
  if(ì‹­ì„±ì¹´ìš´íŠ¸.í¸ê´€>=2)ì„±ê²©íŠ¹ì§•.push('ì™¸ê°•ë‚´ìœ , ë¦¬ë”ì‹­ì´ ê°•í•´');
  if(ì‹­ì„±ì¹´ìš´íŠ¸.ì •ì¸>=1&&ì‹­ì„±ì¹´ìš´íŠ¸.ì‹ì‹ >=1)ì„±ê²©íŠ¹ì§•.push('í•™ë¬¸ì  ì†Œì–‘ê³¼ í‘œí˜„ë ¥ì„ ê°–ì·„ì–´');

  // ê±´ê°• ì ìˆ˜
  const ê±´ê°•ì ìˆ˜=(() => {
    let sc=60;
    sc-=ì „ë¬´.length*12;
    sc-=ê³¼ë‹¤.length*8;
    sc-=ì¶©ëª©ë¡.length*8;
    sc-=í˜•ëª©ë¡.length*5;
    if(ì‹­ì„±ì¹´ìš´íŠ¸.í¸ì¸>=2)sc-=8;
    return Math.min(90,Math.max(15,sc));
  })();

  // ë¶€ëª¨: í¸ì¬/ì •ì¬â†’ì•„ë²„ì§€, í¸ì¸/ì •ì¸â†’ì–´ë¨¸ë‹ˆ
  const ì•„ë²„ì§€ì¸ì—°=ì¸ì—°('í¸ì¬','ì •ì¬');
  const ì•„ë²„ì§€ë³µë•=ë³µë•('í¸ì¬','ì •ì¬');
  const ì–´ë¨¸ë‹ˆì¸ì—°=ì¸ì—°('í¸ì¸','ì •ì¸');
  const ì–´ë¨¸ë‹ˆë³µë•=ë³µë•('í¸ì¸','ì •ì¸');
  
  // ë°°ìš°ì: ë‚¨â†’ì •ì¬/í¸ì¬, ì—¬â†’ì •ê´€/í¸ê´€
  const ë°°ìš°ìì‹­ì„±=gender==='ë‚¨'?['ì •ì¬','í¸ì¬']:['ì •ê´€','í¸ê´€'];
  const ë°°ìš°ìì¸ì—°=ì¸ì—°(...ë°°ìš°ìì‹­ì„±);
  const ë°°ìš°ìë³µë•=ë³µë•(...ë°°ìš°ìì‹­ì„±);
  
  // ìì‹: ì‹ì‹ /ìƒê´€
  const ìì‹ì¸ì—°=ì¸ì—°('ì‹ì‹ ','ìƒê´€');
  const ìì‹ë³µë•=ë³µë•('ì‹ì‹ ','ìƒê´€');
  
  // ì‚¬íšŒìƒí™œ
  const ì¬ë¬¼ì ìˆ˜=relScore('ì •ì¬','í¸ì¬');
  const ì§ì¥ì ìˆ˜=relScore('ì •ê´€','í¸ê´€');
  const í•™ë¬¸ì ìˆ˜=relScore('ì •ì¸','í¸ì¸');
  
  const ì¬ë¬¼íŠ¹ì§•=[];
  if(ì‹­ì„±ì¹´ìš´íŠ¸.í¸ì¬>=2)ì¬ë¬¼íŠ¹ì§•.push('ì¬ë¬¼ ìš•êµ¬ì™€ ê´€ì‹¬ì´ ë§¤ìš° ë§ì•„');
  if(ì‹­ì„±ì¹´ìš´íŠ¸.ì •ì¬>=1)ì¬ë¬¼íŠ¹ì§•.push('ê¾¸ì¤€í•œ ì €ì¶•í˜• ì¬ë¬¼ìš´ì´ì•¼');
  if(ì‹­ì„±ì¹´ìš´íŠ¸.ê²ì¬>=2)ì¬ë¬¼íŠ¹ì§•.push('ê²ì¬ ê³¼ë‹¤ë¼ ì¬ë¬¼ ë¶„ì‚° ì£¼ì˜í•´');
  if(ìš©ì‹ ì˜¤í–‰==='ê¸ˆ'||ìš©ì‹ ì˜¤í–‰==='ìˆ˜')ì¬ë¬¼íŠ¹ì§•.push('ìš©ì‹  ë³´ê°•í•˜ë©´ ì¬ë¬¼ìš´ì´ ì˜¬ë¼ê°€');
  if(ì¬ë¬¼íŠ¹ì§•.length===0)ì¬ë¬¼íŠ¹ì§•.push('í‰ë²”í•œ ì¬ë¬¼ìš´ì´ì•¼');
  
  const ì§ì¥íŠ¹ì§•=[];
  if(ì‹­ì„±ì¹´ìš´íŠ¸.ì •ê´€>=1)ì§ì¥íŠ¹ì§•.push('ì¶œì„¸ ìš•êµ¬ì™€ ê´€ì‹¬ì´ ì ë‹¹í•´');
  if(ì‹­ì„±ì¹´ìš´íŠ¸.í¸ê´€>=2)ì§ì¥íŠ¹ì§•.push('ê´€ì„±ì´ íŒŒê·¹ë¼ì„œ ëª¨í•¨Â·ì¢Œì²œì´ ë§ì•„');
  if(ì‹­ì„±ì¹´ìš´íŠ¸.ìƒê´€>=1&&ì‹­ì„±ì¹´ìš´íŠ¸.ì •ê´€>=1)ì§ì¥íŠ¹ì§•.push('ìƒê´€ê²¬ê´€ì´ë¼ ì§ì¥ ë³€ë™ ì£¼ì˜í•´');
  if(ì§ì¥íŠ¹ì§•.length===0)ì§ì¥íŠ¹ì§•.push('ì•ˆì •ì ì¸ ì§ì¥ìš´ì´ì•¼');

  const í•™ë¬¸íŠ¹ì§•=[];
  if(ì‹­ì„±ì¹´ìš´íŠ¸.ì •ì¸>=1)í•™ë¬¸íŠ¹ì§•.push('í•™ë¬¸ì  ìì•„ì‹¤í˜„ ìš•êµ¬ê°€ ë†’ì•„');
  if(ì‹­ì„±ì¹´ìš´íŠ¸.í¸ì¸>=2)í•™ë¬¸íŠ¹ì§•.push('ì¸ì„±ì´ íŒŒê·¹ë¼ì„œ í•™ë¬¸ì´ ì¤‘ë‹¨ë  ìˆ˜ ìˆì–´');
  if(ì „ë¬´.includes(ì²œê°„ì˜¤í–‰[ì¼ê°„]))í•™ë¬¸íŠ¹ì§•.push('ì¸ì„±ì´ ì—†ì–´ì„œ í•™ë¬¸ ë³µì´ ì•½í•´');
  if(í•™ë¬¸íŠ¹ì§•.length===0)í•™ë¬¸íŠ¹ì§•.push('ë³´í†µì˜ í•™ë¬¸ìš´ì´ì•¼');

  // íŠ¹ì´ì‚¬í•­
  const íŠ¹ì´=[];
  ì¶©ëª©ë¡.forEach(c=>íŠ¹ì´.push(`${c.ìœ„ì¹˜}ì¶©(${c.ì§€1}${c.ì§€2}) â€” ${c.ìœ„ì¹˜==='ì—°ì›”'?'ì´ˆë…„ìš´ íŒŒë€, ë¶€ëª¨ ê°ˆë“±':c.ìœ„ì¹˜==='ì›”ì¼'?'ì¤‘ë…„ ë³€ë™, ì§ì¥Â·ê²°í˜¼ ë³€í™”':c.ìœ„ì¹˜==='ì¼ì‹œ'?'ë§ë…„ íŒŒë€, ìë…€Â·ê±´ê°• ë¬¸ì œ':c.ìœ„ì¹˜==='ì—°ì¼'?'ì¡°ìƒê³¼ ë‹¨ì ˆ, ììˆ˜ì„±ê°€':c.ìœ„ì¹˜==='ì›”ì‹œ'?'ì§ì—…ê³¼ ìë…€ ê°ˆë“±':'ì´ˆë…„ê³¼ ë§ë…„ ê·¹ê³¼ê·¹'}`));
  í˜•ëª©ë¡.forEach(h=>íŠ¹ì´.push(`${h} â€” ê³ ë‚œê³¼ ì‹œë ¨ì˜ ê¸°ìš´`));
  í•©ëª©ë¡.forEach(h=>íŠ¹ì´.push(`${h} â€” ì¡°í™”ì™€ ê²°í•©ì˜ ê¸°ìš´`));
  
  // ëŒ€ìš´
  const dir=(ì²œê°„ìŒì–‘[s.yg]==='ì–‘')===(gender==='ë‚¨')?1:-1;
  let gi=ì²œê°„.indexOf(s.mg),ji=ì§€ì§€.indexOf(s.mj);
  const ëŒ€ìš´=[];
  const birthYear=2000; // placeholder, will be set from form
  for(let i=0;i<8;i++){
    gi=((gi+dir)%10+10)%10;ji=((ji+dir)%12+12)%12;
    const g=ì²œê°„[gi],j=ì§€ì§€[ji];
    ëŒ€ìš´.push({ê°„ì§€:g+j,ì²œê°„ì‹­ì„±:ì‹­ì„±(ì¼ê°„,g),ì§€ì§€ì‹­ì„±:ì‹­ì„±(ì¼ê°„,ì •ê¸°T[j])});
  }

  return{
    ì¼ê°„,ì¼ì§€,ê²©êµ­:ê²©êµ­ì´ë¦„,ê°•ì•½,ìš©ì‹ :ìš©ì‹ ì˜¤í–‰,
    ì˜¤í–‰:{ì¹´ìš´íŠ¸:ì˜¤í–‰ì¹´ìš´íŠ¸,ì „ë¬´,ê³¼ë‹¤},
    ì‹­ì„±:ì‹­ì„±ì¹´ìš´íŠ¸,
    ì„±ê²©:{ì ìˆ˜:ì„±ê²©ì ìˆ˜,íŠ¹ì§•:ì„±ê²©íŠ¹ì§•},
    ê±´ê°•:{ì ìˆ˜:ê±´ê°•ì ìˆ˜,ê²½ê³ :ê±´ê°•ê²½ê³ },
    ê°€ì¡±:{
      ì•„ë²„ì§€:{ì¸ì—°:ì•„ë²„ì§€ì¸ì—°,ë³µë•:ì•„ë²„ì§€ë³µë•},
      ì–´ë¨¸ë‹ˆ:{ì¸ì—°:ì–´ë¨¸ë‹ˆì¸ì—°,ë³µë•:ì–´ë¨¸ë‹ˆë³µë•},
      ë°°ìš°ì:{ì¸ì—°:ë°°ìš°ìì¸ì—°,ë³µë•:ë°°ìš°ìë³µë•},
      ìì‹:{ì¸ì—°:ìì‹ì¸ì—°,ë³µë•:ìì‹ë³µë•},
    },
    ì‚¬íšŒ:{
      ì¬ë¬¼:{ì ìˆ˜:ì¬ë¬¼ì ìˆ˜,íŠ¹ì§•:ì¬ë¬¼íŠ¹ì§•},
      ì§ì¥:{ì ìˆ˜:ì§ì¥ì ìˆ˜,íŠ¹ì§•:ì§ì¥íŠ¹ì§•},
      í•™ë¬¸:{ì ìˆ˜:í•™ë¬¸ì ìˆ˜,íŠ¹ì§•:í•™ë¬¸íŠ¹ì§•},
    },
    íŠ¹ì´,ì¶©:ì¶©ëª©ë¡,í•©:í•©ëª©ë¡,í˜•:í˜•ëª©ë¡,ëŒ€ìš´,dir:dir===1?'ìˆœí–‰':'ì—­í–‰',
    saju:s,G,Z,
  };
}

// ============================================================
// UI ì»´í¬ë„ŒíŠ¸
// ============================================================

// ë“€ì–¼ ë§‰ëŒ€ ê·¸ë˜í”„ (ë‚˜ìœì  â—€ â†’ â–¶ ì¢‹ì€ì )
function DualBar({score,label}){
  const good=score,bad=100-score;
  return(
    <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:2}}>
      {label&&<span style={{fontSize:11,color:'#8a7e6d',minWidth:70,textAlign:'right'}}>{label}</span>}
      <div style={{flex:1,display:'flex',height:18,borderRadius:3,overflow:'hidden',border:'1px solid rgba(180,140,80,0.1)'}}>
        <div style={{width:`${bad}%`,background:'linear-gradient(90deg,#c44040,#d4705a)',display:'flex',alignItems:'center',justifyContent:'flex-start',paddingLeft:3}}>
          {bad>=20&&<span style={{fontSize:8,color:'rgba(255,255,255,0.7)'}}>{bad}%</span>}
        </div>
        <div style={{width:`${good}%`,background:'linear-gradient(90deg,#4a8a4a,#6aaa6a)',display:'flex',alignItems:'center',justifyContent:'flex-end',paddingRight:3}}>
          {good>=20&&<span style={{fontSize:8,color:'rgba(255,255,255,0.7)'}}>{good}%</span>}
        </div>
      </div>
    </div>
  );
}

// ì„¹ì…˜ í—¤ë”
function SectionHeader({title,icon,note}){
  return(
    <div style={{marginTop:24,marginBottom:12}}>
      <div style={{display:'flex',alignItems:'center',gap:6}}>
        <span style={{fontSize:15}}>{icon}</span>
        <span style={{fontSize:15,fontWeight:700,color:'#e8d5a8',fontFamily:"'Noto Serif KR',serif"}}>{title}</span>
      </div>
      {note&&<div style={{fontSize:10,color:'#5a5040',marginTop:3,padding:'4px 8px',background:'rgba(180,140,80,0.04)',borderRadius:4,border:'1px solid rgba(180,140,80,0.06)'}}>â„¹ï¸ {note}</div>}
    </div>
  );
}

// íŠ¹ì§• ë¶ˆë¦¿
function FeatureList({items,type}){
  const colors={warn:'#c44040',info:'#b48c50',good:'#5a9a5a'};
  const icons={warn:'â—',info:'â–¸',good:'âœ“'};
  return(
    <div style={{marginTop:4}}>
      {items.map((item,i)=>(
        <div key={i} style={{display:'flex',gap:5,alignItems:'flex-start',marginBottom:3}}>
          <span style={{fontSize:10,color:colors[type||'info'],marginTop:1}}>{icons[type||'info']}</span>
          <span style={{fontSize:11.5,color:'#c0b8a0',lineHeight:1.5}}>{item}</span>
        </div>
      ))}
    </div>
  );
}

// ê´€ê³„ ì¹´ë“œ
function RelationCard({name,ì¸ì—°,ë³µë•}){
  return(
    <div style={{background:'#1a1510',borderRadius:8,padding:'10px 12px',marginBottom:6,border:'1px solid rgba(180,140,80,0.06)'}}>
      <div style={{fontSize:12,fontWeight:600,color:'#e8d5a8',marginBottom:6}}>â— {name}</div>
      <DualBar score={ì¸ì—°.ì ìˆ˜}/>
      <div style={{display:'flex',gap:12,marginTop:4}}>
        <span style={{fontSize:10.5,color:'#b48c50'}}>ã€ì¸ì—° ì¢…í•©ã€‘{ì¸ì—°.ë“±ê¸‰}</span>
        <span style={{fontSize:10.5,color:'#8a7e6d'}}>ã€ë³µë• ì¢…í•©ã€‘{ë³µë•.ë“±ê¸‰}</span>
      </div>
    </div>
  );
}

// ì‚¬ì£¼ í…Œì´ë¸”
function SajuTable({saju,ì¼ê°„}){
  const cols=[
    {label:'ì‹œì£¼',g:saju.hg,j:saju.hj},
    {label:'ì¼ì£¼',g:saju.dg,j:saju.dj},
    {label:'ì›”ì£¼',g:saju.mg,j:saju.mj},
    {label:'ì—°ì£¼',g:saju.yg,j:saju.yj},
  ];
  return(
    <div style={{display:'flex',gap:3,justifyContent:'center',margin:'16px 0'}}>
      {cols.map((c,i)=>(
        <div key={i} style={{textAlign:'center',minWidth:60,background:i===1?'rgba(180,140,80,0.08)':'#1a1510',borderRadius:8,padding:'8px 4px',border:i===1?'1px solid rgba(180,140,80,0.2)':'1px solid rgba(180,140,80,0.05)'}}>
          <div style={{fontSize:9,color:'#5a5040',marginBottom:4}}>{c.label}</div>
          <div style={{fontSize:20,fontWeight:700,color:ì˜¤í–‰ìƒ‰[ì²œê°„ì˜¤í–‰[c.g]]||'#8a7e6d',fontFamily:'serif'}}>{c.g}</div>
          <div style={{fontSize:9,color:'#5a5040',margin:'2px 0'}}>{c.g!=='?'?ì²œê°„ì˜¤í–‰[c.g]:''}</div>
          <div style={{width:'80%',height:1,background:'rgba(180,140,80,0.1)',margin:'4px auto'}}/>
          <div style={{fontSize:20,fontWeight:700,color:ì˜¤í–‰ìƒ‰[ì§€ì§€ì˜¤í–‰[c.j]]||'#8a7e6d',fontFamily:'serif'}}>{c.j}</div>
          <div style={{fontSize:9,color:'#5a5040',margin:'2px 0'}}>{c.j!=='?'?ì§€ì§€ì˜¤í–‰[c.j]:''}</div>
          {c.g!=='?'&&<div style={{fontSize:9,color:'#3a3530'}}>{ì‹­ì„±(ì¼ê°„,c.g)}</div>}
        </div>
      ))}
    </div>
  );
}

// ì˜¤í–‰ ë¶„í¬ ë°”
function OhBar({ì¹´ìš´íŠ¸}){
  const total=Object.values(ì¹´ìš´íŠ¸).reduce((a,b)=>a+b,0);
  return(
    <div style={{display:'flex',height:20,borderRadius:4,overflow:'hidden',margin:'8px 0',border:'1px solid rgba(180,140,80,0.1)'}}>
      {Object.entries(ì¹´ìš´íŠ¸).map(([oh,cnt])=>{
        const pct=total>0?Math.round(cnt/total*100):0;
        return pct>0?(
          <div key={oh} style={{width:`${pct}%`,background:ì˜¤í–‰ìƒ‰[oh],display:'flex',alignItems:'center',justifyContent:'center',transition:'width 0.5s'}}>
            <span style={{fontSize:8,color:'#fff',fontWeight:600}}>{oh}{pct}%</span>
          </div>
        ):null;
      })}
    </div>
  );
}

// ê³ ì–‘ì´ SVG (ê°„ì†Œí™”)
function CatFace({size=80}){
  return(
    <svg width={size} height={size} viewBox="0 0 100 100" style={{display:'block',overflow:'visible',border:0,outline:0,margin:'0 auto',background:'none',WebkitTapHighlightColor:'transparent'}}>
      <circle cx="50" cy="55" r="35" fill="#f0e6d0"/>
      <polygon points="22,35 18,8 38,28" fill="#f0e6d0"/>
      <polygon points="78,35 82,8 62,28" fill="#f0e6d0"/>
      <polygon points="22,35 18,8 26,15" fill="#e8a0a0"/>
      <polygon points="78,35 82,8 74,15" fill="#e8a0a0"/>
      <ellipse cx="38" cy="48" rx="5" ry="6" fill="#c8940a"/>
      <ellipse cx="62" cy="48" rx="5" ry="6" fill="#c8940a"/>
      <circle cx="38" cy="48" r="3" fill="#1a1a1a"/>
      <circle cx="62" cy="48" r="3" fill="#1a1a1a"/>
      <ellipse cx="50" cy="60" rx="3" ry="2" fill="#e8a0a0"/>
      <path d="M44,64 Q50,70 56,64" fill="none" stroke="#c4a080" strokeWidth="1.5"/>
      <line x1="18" y1="55" x2="33" y2="53" stroke="#d4c4a0" strokeWidth="0.8"/>
      <line x1="18" y1="60" x2="33" y2="59" stroke="#d4c4a0" strokeWidth="0.8"/>
      <line x1="67" y1="53" x2="82" y2="55" stroke="#d4c4a0" strokeWidth="0.8"/>
      <line x1="67" y1="59" x2="82" y2="60" stroke="#d4c4a0" strokeWidth="0.8"/>
    </svg>
  );
}

// ============================================================
// Picker ì»´í¬ë„ŒíŠ¸ (ìŠ¤í¬ë¡¤ ì„ íƒê¸°)
// ============================================================
function Picker({items,value,onChange}){
  const ref=useRef(null);
  const ITEM_H=40,VISIBLE=5,HALF=Math.floor(VISIBLE/2),PAD=HALF*ITEM_H,containerH=VISIBLE*ITEM_H;
  const idx=items.findIndex(i=>i.v===value);
  useEffect(()=>{if(ref.current&&idx>=0)ref.current.scrollTop=idx*ITEM_H;},[]);
  const handleScroll=()=>{if(!ref.current)return;const i=Math.round(ref.current.scrollTop/ITEM_H);const c=Math.max(0,Math.min(items.length-1,i));if(items[c]&&items[c].v!==value)onChange(items[c].v);};
  // ë§ˆìš°ìŠ¤ íœ : í•œ ì¹¸ì”©ë§Œ ì´ë™
  const handleWheel=(e)=>{if(!ref.current)return;e.preventDefault();var dir=e.deltaY>0?1:-1;ref.current.scrollTo({top:ref.current.scrollTop+dir*ITEM_H,behavior:'smooth'});};
  useEffect(()=>{var el=ref.current;if(!el)return;el.addEventListener('wheel',handleWheel,{passive:false});return ()=>{el.removeEventListener('wheel',handleWheel);};},[]);
  return(
    <div style={{position:'relative'}}>
      <div style={{position:'absolute',top:PAD,left:0,right:0,height:ITEM_H,background:'rgba(180,140,80,0.08)',border:'1px solid rgba(180,140,80,0.25)',borderRadius:6,boxShadow:'0 0 12px rgba(180,140,80,0.06)',pointerEvents:'none',zIndex:2}}/>
      <div style={{position:'absolute',top:0,left:0,right:0,height:PAD,background:'linear-gradient(180deg,#1a1510 10%,transparent 100%)',pointerEvents:'none',zIndex:3,borderRadius:'8px 8px 0 0'}}/>
      <div style={{position:'absolute',bottom:0,left:0,right:0,height:PAD,background:'linear-gradient(0deg,#1a1510 10%,transparent 100%)',pointerEvents:'none',zIndex:3,borderRadius:'0 0 8px 8px'}}/>
      <div ref={ref} style={{height:containerH,overflowY:'auto',position:'relative',scrollSnapType:'y mandatory',WebkitOverflowScrolling:'touch',msOverflowStyle:'none',scrollbarWidth:'none'}} onScroll={handleScroll}>
        <div style={{height:PAD}}/>
        {items.map((item,i)=>{const sel=item.v===value;return(
          <div key={i} style={{height:ITEM_H,display:'flex',alignItems:'center',justifyContent:'center',scrollSnapAlign:'center',fontSize:sel?18:13,fontWeight:sel?800:400,color:sel?'#f0e0b8':'#4a4030',textShadow:sel?'0 0 8px rgba(180,140,80,0.4)':'none',transition:'all 0.15s ease',letterSpacing:sel?0.5:0}}>{item.l}</div>
        );})}
        <div style={{height:PAD}}/>
      </div>
    </div>
  );
}

// ============================================================
// ë°”ë¦¬ë§Œì‹  SVG
// ============================================================
function BariMansin({size=80}){
  return(
    <svg width={size} height={size} viewBox="0 0 100 100" style={{display:'block',overflow:'visible',border:0,outline:0,margin:'0 auto',background:'none',WebkitTapHighlightColor:'transparent'}}>
      <defs><linearGradient id="bari" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor="#c0a0ff"/><stop offset="100%" stopColor="#6040a0"/></linearGradient></defs>
      <circle cx="50" cy="50" r="42" fill="url(#bari)" opacity="0.12"/>
      <circle cx="50" cy="55" r="28" fill="#f0e0d0"/>
      <path d="M25,40 Q30,10 50,8 Q70,10 75,40" fill="#3a2060" stroke="#5030a0" strokeWidth="0.5"/>
      <rect x="30" y="6" width="40" height="8" rx="4" fill="#c0a0ff" opacity="0.6"/>
      <circle cx="50" cy="3" r="4" fill="#ffd700" opacity="0.8"/>
      <ellipse cx="40" cy="50" rx="3.5" ry="4" fill="#1a1a1a"/>
      <ellipse cx="60" cy="50" rx="3.5" ry="4" fill="#1a1a1a"/>
      <circle cx="41" cy="49" r="1.2" fill="#fff"/><circle cx="61" cy="49" r="1.2" fill="#fff"/>
      <ellipse cx="50" cy="60" rx="2" ry="1.2" fill="#d4a0a0"/>
      <path d="M44,64 Q50,68 56,64" fill="none" stroke="#b08080" strokeWidth="1"/>
      <text x="50" y="92" textAnchor="middle" fontSize="7" fill="#8060c0" fontFamily="serif">å·« å ‚</text>
    </svg>
  );
}

// ============================================================
// í”„ë¦¬ë¯¸ì—„ ì—”ì§„ v2
// ============================================================
const OHL={ëª©:{ì¥:'ê°„(è‚)',ë¶€:'ë‹´(è†½)',ë°©:'ë™ìª½',ìƒ‰:'ì²­ìƒ‰/ë…¹ìƒ‰',ê³„:'ë´„',ì²´:'ê·¼ìœ¡/ëˆˆ'},í™”:{ì¥:'ì‹¬ì¥(å¿ƒ)',ë¶€:'ì†Œì¥(å°è…¸)',ë°©:'ë‚¨ìª½',ìƒ‰:'ì ìƒ‰',ê³„:'ì—¬ë¦„',ì²´:'í˜ˆê´€/í˜€'},í† :{ì¥:'ë¹„ì¥(è„¾)',ë¶€:'ìœ„(èƒƒ)',ë°©:'ì¤‘ì•™',ìƒ‰:'í™©ìƒ‰',ê³„:'í™˜ì ˆê¸°',ì²´:'ì‚´/ì…'},ê¸ˆ:{ì¥:'í(è‚º)',ë¶€:'ëŒ€ì¥(å¤§è…¸)',ë°©:'ì„œìª½',ìƒ‰:'ë°±ìƒ‰',ê³„:'ê°€ì„',ì²´:'ë¼ˆ/ì½”'},ìˆ˜:{ì¥:'ì‹ ì¥(è…)',ë¶€:'ë°©ê´‘(è†€èƒ±)',ë°©:'ë¶ìª½',ìƒ‰:'í‘ìƒ‰',ê³„:'ê²¨ìš¸',ì²´:'ê·€/ëª¨ë°œ'}};
const OHC={ëª©:{ì–‘:'ì§„ì·¨ì , ì¶”ì§„ë ¥â†‘, ë¦¬ë”ì‹­, ê³ ì§‘',ìŒ:'ìœ ì—°, ë°°ë ¤, ìš°ìœ ë¶€ë‹¨'},í™”:{ì–‘:'ì—´ì •ì , í™”ë ¤, ì‚¬êµì , ê¸‰í•¨',ìŒ:'ì„¬ì„¸, ì˜ˆìˆ ì , ë‚´ë©´ ëœ¨ê±°ì›€'},í† :{ì–‘:'ë“¬ì§, í¬ìš©, ì‹ ìš©, ë³€í™” ëŠë¦¼',ìŒ:'ê¼¼ê¼¼, ì‹¤ë¦¬, ì•ˆì •ì¶”êµ¬, ê±±ì •ë§ìŒ'},ê¸ˆ:{ì–‘:'ì •ì˜, ê²°ë‹¨ë ¥, ì›ì¹™, ìœµí†µì„± ë¶€ì¡±',ìŒ:'ì„¸ë ¨, ê°ê°, ì™„ë²½ì£¼ì˜, ì˜ˆë¯¼'},ìˆ˜:{ì–‘:'ì§€í˜œ, ì ì‘ë ¥, ì„ê¸°ì‘ë³€, ë³€ë•',ìŒ:'ì§ê´€, ì˜ì , ìƒìƒë ¥, ë¹„í˜„ì‹¤'}};
const OHV={ëª©:'í‚¤ í° í¸, ì´ëª©êµ¬ë¹„ ëšœë ·, ìì„¸ ê³§ìŒ',í™”:'ëˆˆ í¬ê³  ë¹›ë‚¨, í™œê¸°ì°¬ ì¸ìƒ, í”¼ë¶€ ë¶‰ì€ ê¸°',í† :'ì–¼êµ´ ë‘¥ê¸€ê³  í›„ë•, ì²´ê²© ë‹¤ë¶€ì§, ì•ˆì •ê°',ê¸ˆ:'í”¼ë¶€ í¬ê³  ê¹¨ë—, ì„¸ë ¨ëœ ì¸ìƒ, ë‚ ì¹´ë¡œì›€',ìˆ˜:'ë‘¥ê·¼ ì–¼êµ´, ìœ ì—° ì²´í˜•, ëˆˆ ê·¸ìœ½, ë¶„ìœ„ê¸°'};
const OHJ={ëª©:'êµìœ¡,ì¶œíŒ,ì˜ë¥˜,ê°€êµ¬,í•œì˜í•™',í™”:'IT,ì—ë„ˆì§€,ë¯¸ë””ì–´,ì˜ˆìˆ ,ìš”ì‹ì—…',í† :'ë¶€ë™ì‚°,ê±´ì„¤,ì¤‘ê°œ,ìœ í†µ',ê¸ˆ:'ê¸ˆìœµ,ê¸°ê³„,ìë™ì°¨,ë²•ë¥ ,ì˜ë£Œê¸°ê¸°',ìˆ˜:'ë¬´ì—­,ìˆ˜ì‚°,ê´€ê´‘,ë¬¼ë¥˜,ì—°êµ¬'};
const ì¶©í•´={ì—°ì›”:'ì´ˆë…„ ê°€ì • ë³€í™”, ë¶€ëª¨ ê°ˆë“±',ì›”ì¼:'ì¤‘ë…„ ì§ì¥/ê²°í˜¼ ë³€ë™',ì¼ì‹œ:'ë§ë…„ ê±´ê°•/ìë…€ ë¬¸ì œ',ì—°ì¼:'ììˆ˜ì„±ê°€ ìš´ëª…',ì—°ì‹œ:'ì´ˆë…„â†”ë§ë…„ ê·¹ê³¼ê·¹',ì›”ì‹œ:'ì§ì—…â†”ìë…€ ê°ˆë“±'};

function findSS(chars,ì¼ê°„,target){return chars.filter(c=>c!=='?'&&ì‹­ì„±(ì¼ê°„,c)===target);}
function findSSJ(chars,ì¼ê°„,target){return chars.filter(c=>c!=='?'&&ì‹­ì„±(ì¼ê°„,ì •ê¸°T[c])===target);}

function genPremium(a,birthYear){
  const {ì¼ê°„,ì¼ì§€,G,Z,ì‹­ì„±:ss,ê°•ì•½,ìš©ì‹ ,ì˜¤í–‰,saju}=a;
  const ì¼oh=ì²œê°„ì˜¤í–‰[ì¼ê°„], yy=ì²œê°„ìŒì–‘[ì¼ê°„], gender=saju.gender;
  const ì¬oh=ìƒê·¹[ì¼oh]; // ì¬ì„± ì˜¤í–‰
  const dir=(ì²œê°„ìŒì–‘[saju.yg]==='ì–‘')===(gender==='ë‚¨')?1:-1;
  const ì¶©ìŒ=[['å­','åˆ'],['ä¸‘','æœª'],['å¯…','ç”³'],['å¯','é…‰'],['è¾°','æˆŒ'],['å·³','äº¥']];

  // í—¬í¼: ì‹­ì„± ë¶„ì„ ë¸”ë¡
  function ssBlock(name,cnt,ganList,jiList,ohType,desc){
    const L=[];
    L.push({type:'h3',text:`â—‰ ${name}`});
    // ì„¸ë ¥
    L.push({type:'h4',text:'ì„¸ë ¥Â·ì™•ì‡ '});
    if(cnt===0){L.push({t:`${name}(${ohType})ì€ ì‚¬ì£¼ì— ì—†ì–´ í•´ë‹¹ ì—­í• ì´ ì•½í•©ë‹ˆë‹¤.`});L.push({t:`ì‚¬ì£¼ ì²œê°„ì— ${name}ì´ í•˜ë‚˜ë„ ë‚˜íƒ€ë‚˜ì§€ ì•Šì•„ ${desc}ì´ ë¯¸ì•½í•©ë‹ˆë‹¤.`,dim:1});}
    else{L.push({t:`${name}(${ohType})ì€ ì„¸ë ¥ì´ ${cnt>=2?'ì™•í•¨':'ì•½í•¨'} í¸ì— ì†í•©ë‹ˆë‹¤.`});
      if(ganList.length>0)L.push({t:`ì‚¬ì£¼ ì²œê°„ì— ${name}(${ganList.join(',')})ì´ ë‚˜íƒ€ë‚˜ ìˆì–´ ì¢‹ìŠµë‹ˆë‹¤.`,dim:1});
      if(jiList.length>0)L.push({t:`ì§€ì§€ì— ë¿Œë¦¬ê°€ ìˆì–´ ì˜í–¥ë ¥ì´ ë¯¸ì•½í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`,dim:1});
      if(ganList.length===0&&jiList.length>0)L.push({t:`ì²œê°„ì— ${name}ì´ ì—†ê³  ì§€ì§€ì—ë§Œ ì¡´ì¬í•©ë‹ˆë‹¤.(ë¿Œë¦¬ë§Œ)`,dim:1});}
    // ê°•ì•½
    L.push({type:'h4',text:'ê°•ì•½'});
    if(cnt>0&&ê°•ì•½==='ì‹ ê°•'){L.push({t:`${ê°•ì•½}í•œ ì¼ê°„ì´ ${name}ì„ ì˜ í†µì œí•˜ì—¬ ì•ˆì •ì ìœ¼ë¡œ ê´€ë¦¬ ê°€ëŠ¥í•˜ë‹ˆë¼.`});L.push({tag:'ì—­í•  ë³´í†µ',c:'blue'});}
    else if(cnt>0&&ê°•ì•½==='ì‹ ì•½'){L.push({t:`${ê°•ì•½}í•œ ì¼ê°„ì´ ${name}ì„ ê°ë‹¹í•˜ê¸° ì–´ë ¤ì›Œ ìœ ì§€ê°€ í˜ë“  ê²½í–¥ì´ ìˆëŠë‹ˆë¼.`});L.push({tag:'ì—­í•  ì ìš©',c:'red'});}
    else if(cnt===0){L.push({t:`${name}ì´ ì—†ì–´ í•´ë‹¹ ë¶„ì•¼ì˜ ì§ì ‘ì  ì˜í–¥ì´ ì•½í•©ë‹ˆë‹¤.`});}
    // íšŒê¸°
    L.push({type:'h4',text:'íšŒê¸°(å–œå¿Œ)'});
    const isHui=ìš©ì‹ ===ohType||ìƒìƒ[ì¼oh]===ohType;
    L.push({t:cnt>0?(isHui?`${name}ì€ ìš©ì‹ ê³¼ ê°™ì€ í¸ìœ¼ë¡œ ì¢‹ì€ í¬ì‹  ì—­í• ì„ í•©ë‹ˆë‹¤.`:`${name}ì€ ê¸°ì‹ ìœ¼ë¡œ ì‘ìš©í•©ë‹ˆë‹¤. ê²©êµ­ì— ë‚˜ìœ ê¸°ì‹ ìœ¼ë¡œ ì‘ìš©í•©ë‹ˆë‹¤.`):`${name}ì´ ì—†ì–´ íšŒê¸° íŒë‹¨ì´ ì–´ë µìŠµë‹ˆë‹¤.`});
    if(cnt>0)L.push({tag:isHui?'ì—­í•  ë³´í†µ':'ì—­í•  ì ìš©',c:isHui?'blue':'red'});
    // ì¢…í•©
    L.push({type:'h4',text:'ì¢…í•© ê°ì •'});
    return L;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // â‘  ì¬ë¬¼/ì‚¬ì—…ìš´
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const ì •ì¬g=findSS(G,ì¼ê°„,'ì •ì¬'),ì •ì¬j=findSSJ(Z,ì¼ê°„,'ì •ì¬'),í¸ì¬g=findSS(G,ì¼ê°„,'í¸ì¬'),í¸ì¬j=findSSJ(Z,ì¼ê°„,'í¸ì¬');
  const ì •ì¬L=ssBlock('ì •ì¬',ss.ì •ì¬,ì •ì¬g,ì •ì¬j,ì¬oh,'ì•ˆì •ì  ì†Œë“ì— ì˜í•œ ì¶•ì¬');
  if(ss.ì •ì¬>=1&&ê°•ì•½==='ì‹ ê°•')ì •ì¬L.push({t:'ì •ì¬ê°€ ì‹ ê°•í•œ ì¼ê°„ì˜ í†µì œ ì•„ë˜ ìˆì–´ ì•ˆì •ì  ì¬ë¬¼ ì¶•ì ì´ ê°€ëŠ¥í•˜ë‹ˆë¼. ì›”ê¸‰, ë¶€ë™ì‚° ë“± ê¾¸ì¤€í•œ ì†Œë“ì›ì—ì„œ ë³µì´ ìˆìŠµë‹ˆë‹¤.'});
  else if(ss.ì •ì¬>=1)ì •ì¬L.push({t:'ì •ì¬ê°€ ìˆìœ¼ë‚˜ ì¼ê°„ì´ ì•½í•´ ì¬ë¬¼ì„ ì˜¨ì „íˆ ì·¨í•˜ê¸° ì–´ë µìŠµë‹ˆë‹¤. ê³¼ë„í•œ íˆ¬ìë³´ë‹¤ ì•ˆì •ì  ìˆ˜ì…ì— ì§‘ì¤‘í•˜ì„¸ìš”.'});
  else ì •ì¬L.push({t:'ì •ì¬ê°€ ë¶€ì¬í•˜ì—¬ ì •ì§í•œ ë…¸ë ¥ì— ì˜í•œ ì¶•ì¬ê°€ ì–´ë µìŠµë‹ˆë‹¤. ëŒ€ìš´ì—ì„œ ì •ì¬ê°€ ì˜¬ ë•Œ ê¸°íšŒë¥¼ ì¡ìœ¼ì„¸ìš”.'});

  const í¸ì¬L=ssBlock('í¸ì¬',ss.í¸ì¬,í¸ì¬g,í¸ì¬j,ì¬oh,'í° íˆ¬ì/ì‚¬ì—…ì  ì¬ë¬¼ìš´');
  if(ss.í¸ì¬>=2&&ê°•ì•½==='ì‹ ê°•')í¸ì¬L.push({t:'í¸ì¬ê°€ ê°•í•˜ê³  ì¼ê°„ë„ ê°•í•˜ì—¬ í° ì¬ë¬¼ì„ ë‹¤ë£° ì—­ëŸ‰ì´ ë©ë‹ˆë‹¤. ì‚¬ì—…, íˆ¬ì, ë¬´ì—­ ë“±ì—ì„œ ë‘ê°ì„ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'});
  else if(ss.í¸ì¬>=1)í¸ì¬L.push({t:'í¸ì¬ê°€ ìˆì–´ íˆ¬ì ê°ê°ì€ ìˆìœ¼ë‚˜, ì‹ ì¤‘í•œ ì ‘ê·¼ì´ í•„ìš”í•©ë‹ˆë‹¤.'});
  else í¸ì¬L.push({t:'í¸ì¬ê°€ ì—†ì–´ í° ê·œëª¨ë³´ë‹¤ ì‹¤ë¦¬ì  ê²½ì œí™œë™ì´ ì í•©í•˜ë‹ˆë¼.'});
  if(ss.ê²ì¬>=1&&ss.í¸ì¬>=1){í¸ì¬L.push({t:'ê²ì¬ê°€ í¸ì¬ë¥¼ ê·¹í•˜ì—¬ íˆ¬ì ì†ì‹¤ì´ë‚˜ ì‚¬ê¸° í”¼í•´ ì£¼ì˜.'});í¸ì¬L.push({tag:'ì‚¬ì—… ë¶„ìŸ',c:'red'});}

  // ì„ ì²œ ì¢…í•©
  const ì¬ì =Math.min(95,Math.max(15,40+(ss.ì •ì¬*12)+(ss.í¸ì¬*10)-(ss.ê²ì¬*15)+(ss.ì‹ì‹ *8)+(ê°•ì•½==='ì‹ ê°•'?10:-5)));
  const ì„ ì²œì¬=[];
  ì„ ì²œì¬.push({type:'h4',text:'ì¬ë¬¼ ê´€ì‹¬Â·ì¸ì—°'});
  if(ss.í¸ì¬>=1)ì„ ì²œì¬.push({t:'è²¡æ˜Ÿì´ ì™•í•˜ì—¬ ì¬ë¬¼ ìš•êµ¬ì™€ ê´€ì‹¬ì´ ê°•í•˜ê³ , ì¸ìƒëª©í‘œë¥¼ ì¬ë¬¼ì— ë‘ê³  ì‚´ê²Œ ë©ë‹ˆë‹¤.'});
  if(ss.í¸ì¬>=2)ì„ ì²œì¬.push({t:'í¸ì¬ê°€ ì™•í•˜ì—¬ ì¬í…Œí¬ì— ëŠ¥í•˜ê³ , ì¼í™•ì²œê¸ˆì„ ë°”ë¼ëŠ” ê²½í–¥ì´ ìˆëŠë‹ˆë¼.'});
  if(ss.ì •ì¬>=1)ì„ ì²œì¬.push({t:'ì •ì¬ê°€ ì™•í•˜ì—¬ ì •ì§í•˜ê²Œ ì¬ë¬¼ì„ ëª¨ìœ¼ë ¤ í•©ë‹ˆë‹¤.'});
  if(ss.ì •ì¬+ss.í¸ì¬===0)ì„ ì²œì¬.push({t:'ì¬ì„±ì´ ì—†ì–´ ì¬ë¬¼ ê´€ì‹¬ì´ ì ê³ , ë‹¤ë¥¸ ê°€ì¹˜ë¥¼ ì¶”êµ¬í•©ë‹ˆë‹¤.'});
  ì„ ì²œì¬.push({type:'h4',text:'ì¬ë¬¼ ë³µ'});
  if(ss.ì‹ì‹ >=1&&(ss.ì •ì¬+ss.í¸ì¬)>=1){ì„ ì²œì¬.push({t:'ì‹ì‹ ì´ ì¬ì„±ì„ ìƒí•˜ì—¬ ì¬ë¬¼ì„ ëª¨ìë‹ˆë‹¤.'});ì„ ì²œì¬.push({tag:'ì¬ë¬¼ ë°œìƒ',c:'blue'});}
  if(ss.ê²ì¬>=2){ì„ ì²œì¬.push({t:'ê²ì¬ê°€ í¬ì‹  ì‘ìš©í•˜ì—¬ ì¬ë¬¼ë¡œ ì¸í•œ ë¶ˆê±°ì›€ì´ ë§ìœ¼ë©° ì–´ë ¤ì›€ì„ ê²ªì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'});ì„ ì²œì¬.push({tag:'ì¬ë¬¼ ì†ì‹¤',c:'red'});}
  ì„ ì²œì¬.push({type:'h4',text:'ì‹ ì‚´ ë° ê¸°íƒ€'});
  if(a.í•©.length>0)ì„ ì²œì¬.push({t:`í•©(${a.í•©.join(',')})ì´ ì¬ë¬¼ì— ê¸ì •ì  ì˜í–¥.`});
  if(a.ì¶©.length>0)ì„ ì²œì¬.push({t:'ì¶©ì´ ìˆì–´ ì¬ë¬¼ ë³€ë™ì´ í¼. ì•ˆì •ì  ê´€ë¦¬ í•„ìš”.'});
  if(a.í•©.length===0&&a.ì¶©.length===0)ì„ ì²œì¬.push({t:'íŠ¹ì´ ì‚¬í•­ ì—†ìŒ'});

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ëŒ€ìš´ë³„ ì¬ë¬¼ (8ê°œ)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let gi2=ì²œê°„.indexOf(saju.mg),ji2=ì§€ì§€.indexOf(saju.mj);
  const ëŒ€ìš´ì¬=[];
  for(let i=0;i<8;i++){
    gi2=((gi2+dir)%10+10)%10;ji2=((ji2+dir)%12+12)%12;
    const g=ì²œê°„[gi2],j=ì§€ì§€[ji2],age=4+i*10,yr=birthYear+age;
    const gSS=ì‹­ì„±(ì¼ê°„,g),jSS=ì‹­ì„±(ì¼ê°„,ì •ê¸°T[j]);
    const ev=[],tags=[];let sc=50;
    if(gSS==='ì •ì¬'){ev.push(`ëŒ€ìš´ì²œê°„ ì •ì¬ ì—­ë¶€í¬ì‹  [ì†Œë“ ìƒìŠ¹]`);tags.push({t:'ì†Œë“ ìƒìŠ¹',c:'blue'});sc+=15;}
    if(gSS==='í¸ì¬'){ev.push(`ëŒ€ìš´ì²œê°„ í¸ì¬ ì—­ë¶€í¬ì‹  [ì‚¬ì—… ë°œì „]`);tags.push({t:'ì‚¬ì—… ë°œì „',c:'blue'});sc+=12;}
    if(gSS==='ì‹ì‹ '){ev.push(`ëŒ€ìš´ ì‹ì‹ ì´ ìˆœìš© ì„±ê²©ë¨ [ì¬ë¬¼ ì¦ê°€]`);tags.push({t:'ì¬ë¬¼ ì¦ê°€',c:'green'});sc+=10;}
    if(gSS==='ìƒê´€'){ev.push(`ëŒ€ìš´ ìƒê´€ ê²©êµ­ì—­í•  ì¦ê°€ [ì¬ë¬¼ ì¦ê°€]`);tags.push({t:'ì¬ë¬¼ ì¦ê°€',c:'green'});sc+=5;}
    if(gSS==='ê²ì¬'){ev.push(`ëŒ€ìš´ ê²ì¬ ìƒê·¹ íŒŒê·¹ [ì¬ë¬¼ ê°ì†Œ]`);tags.push({t:'ì¬ë¬¼ ê°ì†Œ',c:'red'});sc-=15;}
    if(gSS==='ë¹„ê²¬'){ev.push(`ëŒ€ìš´ ë¹„ê²¬ â€” ê²½ìŸ ì‹¬í™”`);sc-=5;}
    if(gSS==='ì •ê´€'){ev.push(`ëŒ€ìš´ ì •ê´€ ì—­ë¶€í¬ì‹  [ì†Œë“ ìƒìŠ¹]`);tags.push({t:'ì†Œë“ ìƒìŠ¹',c:'blue'});sc+=8;}
    if(gSS==='í¸ê´€'){ev.push(`ëŒ€ìš´ í¸ê´€ â€” ì™¸ë¶€ ì••ë°• [ì¬ë¬¼ ë³€ë™]`);sc-=3;}
    if(gSS==='ì •ì¸'){ev.push(`ëŒ€ìš´ ì •ì¸ ì—­ë¶€í¬ì‹  [ì•ˆì •]`);sc+=5;}
    if(gSS==='í¸ì¸'){ev.push(`ëŒ€ìš´ í¸ì¸ â€” í•™ë¬¸Â·íˆ¬ìê¸°`);sc+=2;}
    if(['ì •ì¬','í¸ì¬'].includes(jSS)){ev.push(`ì§€ì§€ ì¬ì„± ê°•í™” [ì¬ë¬¼ ì¦ê°€]`);tags.push({t:'ì¬ë¬¼ ì¦ê°€',c:'green'});sc+=10;}
    if(jSS==='ì‹ì‹ '){ev.push(`ì§€ì§€ ì‹ì‹ ìƒì¬ [ì¬ë¬¼ ì¦ê°€]`);tags.push({t:'ì¬ë¬¼ ì¦ê°€',c:'green'});sc+=8;}
    if(jSS==='ê²ì¬'){ev.push(`ì§€ì§€ ê²ì¬ê·¹ì¬ [ì¬ë¬¼ ê°ì†Œ]`);tags.push({t:'ì¬ë¬¼ ê°ì†Œ',c:'red'});sc-=10;}
    [saju.yj,saju.mj,saju.dj,saju.hj].forEach((z,idx)=>{ì¶©ìŒ.forEach(([aa,bb])=>{
      if((j===aa&&z===bb)||(j===bb&&z===aa)){ev.push(`${j}${z}ì¶©(ëŒ€ìš´â†”${['ì—°','ì›”','ì¼','ì‹œ'][idx]}ì§€) ì¬ë¬¼ ë³€ë™`);tags.push({t:'ì¬ë¬¼ ë³€ë™',c:'orange'});sc-=5;}});});
    sc=Math.min(95,Math.max(10,sc));
    const ì¢…í•©=sc>=75?'ì¬ë¬¼ì´ ëŠ˜ì–´ ë§¤ìš° ì¢‹ìŒ':sc>=60?'ì¬ë¬¼ ë³µ ì¢‹ìœ¼ë‚˜ ìœ„í—˜ìš”ì¸ ìˆìŒ':sc>=45?'ì¬ë¬¼ ê°™ì€ ë³€ë™ ìˆìœ¼ë‚˜ ë¬´ë‚œ':sc>=30?'ì¬ë¬¼ ë³€ë™ì´ ë‚˜ìœ í¸':'ì¬ë¬¼ì´ ì¤„ì–´ ë§¤ìš° ë‚˜ì¨';
    ev.push(`ã€ì¢…í•©ã€‘${ì¢…í•©}`);
    ëŒ€ìš´ì¬.push({ê°„ì§€:g+j,ì‹œì‘:age,ë:age+9,yr,gSS,jSS,sc,ev,tags});
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // â‘¡ ~ â‘¬ ê¸°íƒ€ ì¹´í…Œê³ ë¦¬ (ì¤‘ê°„ ê¹Šì´)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function simpleCategory(title,icon,lines,score){return{title,icon,lines,score:score||50};}
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // â‘¡ ê°œì¸íŠ¹ì„± (ê°•í™”)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const ê±´ê°•sc=Math.min(90,Math.max(15,60-ì˜¤í–‰.ì „ë¬´.length*12-ì˜¤í–‰.ê³¼ë‹¤.length*8-a.ì¶©.filter(c=>c.ìœ„ì¹˜.includes('ì¼')).length*8-a.í˜•.length*5+(ê°•ì•½==='ì‹ ê°•'?10:-5)));
  const ê±´ê°•L=[];
  ê±´ê°•L.push({type:'h3',text:'â—‰ ê±´ê°• / ìˆ˜ëª…'});
  ê±´ê°•L.push({type:'h4',text:'ì˜¤í–‰ê³¼ ì¥ë¶€'});
  ê±´ê°•L.push({t:`ì¼ê°„ ${ì¼ê°„}(${ì¼oh})ì˜ ëŒ€í‘œ ì¥ë¶€: ${(OHL[ì¼oh]||{}).ì¥||''} / ${(OHL[ì¼oh]||{}).ë¶€||''}`});
  ê±´ê°•L.push({t:`${ì¼oh}ì´ ì¼ê°„ì´ë¯€ë¡œ ${(OHL[ì¼oh]||{}).ì²´||''} ê´€ë ¨ ê±´ê°•ì— íŠ¹íˆ ì£¼ì˜í•´ì•¼ í•˜ëŠë‹ˆë¼.`});
  ê±´ê°•L.push({type:'h4',text:'ì˜¤í–‰ ì „ë¬´/ê³¼ë‹¤ ì˜í–¥'});
  if(ì˜¤í–‰.ì „ë¬´.length===0)ê±´ê°•L.push({t:'ì˜¤í–‰ì´ ëª¨ë‘ ê°–ì¶°ì ¸ ìˆì–´ ì„ ì²œì  ê²°í•¨ì´ ì ìœ¼ë‹ˆ ë‹¤í–‰ì´ë¡œë‹¤.'});
  ì˜¤í–‰.ì „ë¬´.forEach(function(oh){ê±´ê°•L.push({t:`âš  ${oh}(${(OHL[oh]||{}).ì¥||''}/${(OHL[oh]||{}).ë¶€||''}) ì „ë¬´ â€” ${(OHL[oh]||{}).ì¥||''} ì„ ì²œ í—ˆì•½. ${(OHL[oh]||{}).ì²´||''} ì§ˆí™˜ì„ ê°ë³„íˆ ì¡°ì‹¬í•˜ê±°ë¼.`,w:1});});
  ì˜¤í–‰.ê³¼ë‹¤.forEach(function(oh){ê±´ê°•L.push({t:`âš  ${oh}(${(OHL[oh]||{}).ë¶€||''}) ê³¼ë‹¤ â€” ${(OHL[oh]||{}).ë¶€||''} ì—´ê³¼ ì—¼ì¦ ê³„í†µì„ ì¡°ì‹¬í•˜ê±°ë¼.`,w:1});});
  ê±´ê°•L.push({type:'h4',text:'ì¶©/í˜•ì˜ ê±´ê°• ì˜í–¥'});
  if(a.ì¶©.length===0&&a.í˜•.length===0)ê±´ê°•L.push({t:'ì‚¬ì£¼ì— ì¶©/í˜•ì´ ì—†ì–´ ê±´ê°• ë³€ë™ì˜ ê¸°ìš´ì´ ì•½í•˜ë‹ˆ ì•ˆì‹¬í•´ë„ ë˜ëŠë‹ˆë¼.'});
  a.ì¶©.filter(function(c){return c.ìœ„ì¹˜.includes('ì¼');}).forEach(function(){ê±´ê°•L.push({t:'âš  ì¼ì£¼ ì¶© â€” ì¤‘ë…„ ì´í›„ ê±´ê°• ë³€ë™ ê°€ëŠ¥. ì •ê¸° ê²€ì§„ì€ í•„ìˆ˜ë‹ˆë¼.',w:1});});
  a.í˜•.forEach(function(h){ê±´ê°•L.push({t:`${h} â€” í•´ë‹¹ ì‹œê¸°ì— ìˆ˜ìˆ ì´ë‚˜ ì‚¬ê³ ë¥¼ ì¡°ì‹¬í•˜ê±°ë¼.`,w:1});});
  ê±´ê°•L.push({type:'h4',text:'ì²´ì§ˆ ì¢…í•©'});
  ê±´ê°•L.push({t:ê°•ì•½==='ì‹ ê°•'?'ì‹ ê°• ì²´ì§ˆë¡œ ê¸°ë³¸ ì²´ë ¥ì´ ì–‘í˜¸í•©ë‹ˆë‹¤. ë‹¤ë§Œ ê³¼ë¡œí•˜ê¸° ì‰¬ìš°ë‹ˆ ìê¸° ê´€ë¦¬ê°€ ì¤‘ìš”í•˜ëŠë‹ˆë¼. í™”(ç«)ê°€ ê°•í•œ ì‚¬ì£¼ëŠ” ì‹¬í˜ˆê´€ê³„, í† (åœŸ)ê°€ ê°•í•˜ë©´ ì†Œí™”ê¸°ì— ì£¼ì˜í•˜ì„¸ìš”.':'ì‹ ì•½ ì²´ì§ˆë¡œ ì—ë„ˆì§€ ì†Œëª¨ê°€ ë¹ ë¦…ë‹ˆë‹¤. ë¬´ë¦¬í•˜ì§€ ë§ê³ , ìš©ì‹  í™˜ê²½('+ìš©ì‹ +')ì„ í™œìš©í•˜ì—¬ ê¸°ìš´ì„ ë³´ì¶©í•˜ì„¸ìš”.'});
  ê±´ê°•L.push({t:`ê±´ê°• ë³´ê°• ë°©ìœ„: ${(OHL[ìš©ì‹ ]||{}).ë°©||''}, ë³´ê°• ìƒ‰ê¹”: ${(OHL[ìš©ì‹ ]||{}).ìƒ‰||''}, ì¢‹ì€ ê³„ì ˆ: ${(OHL[ìš©ì‹ ]||{}).ê³„||''}`});
  const ê±´ê°•=simpleCategory('ê±´ê°• / ìˆ˜ëª…','ğŸ¥',ê±´ê°•L,ê±´ê°•sc);

  const ì„±ê²©sc=Math.min(90,Math.max(15,50+(ê°•ì•½==='ì‹ ê°•'?5:-5)+a.í•©.length*8-a.ì¶©.length*10-a.í˜•.length*8-(ì˜¤í–‰.ì „ë¬´.length>0?-8:0)-(ss.ìƒê´€>=2?-10:0)+(ss.ì •ì¸>=1?5:0)+(ss.ì‹ì‹ >=1?5:0)));
  const ì„±ê²©L=[];
  ì„±ê²©L.push({type:'h3',text:'â—‰ ì„±ê²© ì‹¬ì¸µ'});
  ì„±ê²©L.push({type:'h4',text:'ì¼ê°„ ê¸°ë³¸ ì„±ê²©'});
  ì„±ê²©L.push({t:((OHC[ì¼oh]||{})[yy])||'ì¼ê°„ ì˜¤í–‰ì— ë”°ë¥¸ ê¸°ë³¸ ì„±ê²©ì…ë‹ˆë‹¤.'});
  ì„±ê²©L.push({type:'h4',text:'ì‹­ì„± ì¡°í•© ì„±ê²©'});
  if(ss.ë¹„ê²¬>=2)ì„±ê²©L.push({t:'ë¹„ê²¬ì´ ê°•í•´ì„œ ìì¡´ì‹¬ì´ ì„¸ê³  ë…ë¦½ì‹¬ì´ ê°•í•©ë‹ˆë‹¤. íƒ€ì¸ê³¼ ê²½ìŸí•˜ë ¤ëŠ” ì„±í–¥ì´ ìˆê³ , ì–‘ë³´í•˜ê¸° ì–´ë ¤ìš´ ê¸°ì§ˆì´ë‹ˆë¼.'});
  if(ss.ê²ì¬>=2)ì„±ê²©L.push({t:'ê²ì¬ê°€ ê³¼ë‹¤í•˜ì—¬ í–‰ë™ë ¥ì´ ê°•í•˜ë‚˜ íˆ¬ìŸì ì´ê³  ì´ì¤‘ì ì¸ ë©´ì´ ìˆìŠµë‹ˆë‹¤. ë‹¤í˜ˆì§ˆì  ì„±í–¥ì„ ë‹¤ìŠ¤ë ¤ì•¼ í•˜ëŠë‹ˆë¼.'});
  if(ss.ì‹ì‹ >=1)ì„±ê²©L.push({t:'ì‹ì‹ ì´ ìˆì–´ ì—°êµ¬ì‹¬ì´ ê°•í•˜ê³  ìˆœìˆ˜í•œ ë©´ì´ ìˆìŠµë‹ˆë‹¤. ì´ì§€ì ì´ë©° í˜„ì‹¤ì ì¸ íŒë‹¨ì„ ì˜í•˜ëŠë‹ˆë¼.'});
  if(ss.ìƒê´€>=2)ì„±ê²©L.push({t:'ìƒê´€ì´ ê°•í•´ì„œ ë°˜ê³¨ ê¸°ì§ˆì´ ìˆëŠë‹ˆë¼. ê¶Œìœ„ì— ë„ì „í•˜ê³ , ì°½ì˜ë ¥ì€ ë„˜ì¹˜ì§€ë§Œ ì¸ê°„ê´€ê³„ì—ì„œ ë§ˆì°°ì´ ì¦ì„ ìˆ˜ ìˆëŠë‹ˆë¼.',w:1});
  if(ss.í¸ê´€>=2)ì„±ê²©L.push({t:'í¸ê´€ì´ ê³¼ë‹¤í•˜ì—¬ ì™¸ê°•ë‚´ìœ , ë¦¬ë”ì‹­ì´ ê°•í•˜ì§€ë§Œ ì™¸ê³¨ìˆ˜ì ì´ê³  ì™„ê³ í•œ ë©´ì´ ìˆëŠë‹ˆë¼.'});
  if(ss.ì •ê´€>=1)ì„±ê²©L.push({t:'ì •ê´€ì´ ìˆì–´ ì´ì„±ì ì´ê³  ì ˆì œë ¥ì´ ìˆìŠµë‹ˆë‹¤. ëª¨ë²”ì ì´ë‚˜ ì²´ë©´ì„ ì¤‘ì‹œí•˜ëŠ” ê²½í–¥ì´ ìˆëŠë‹ˆë¼.'});
  if(ss.í¸ì¸>=2)ì„±ê²©L.push({t:'í¸ì¸ì´ ê³¼ë‹¤í•˜ì—¬ ë…íŠ¹í•œ ì‚¬ê³ ë°©ì‹ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. í•™ë¬¸ì  ê¹Šì´ê°€ ìˆì§€ë§Œ ê³ ë…í•˜ê³  ë³€ë•ì´ ì‹¬í•  ìˆ˜ ìˆìœ¼ë‹ˆ ê²½ê³„í•˜ê±°ë¼.'});
  if(ss.ì •ì¸>=1&&ss.ì‹ì‹ >=1)ì„±ê²©L.push({t:'ì‹ì‹ ê³¼ ì •ì¸ì´ í•¨ê»˜ ìˆì–´ í•™ë¬¸ê³¼ í‘œí˜„ë ¥ì„ ê²¸ë¹„í•©ë‹ˆë‹¤. ê°€ë¥´ì¹˜ëŠ” ì¼ì´ë‚˜ ì°½ì‘ í™œë™ì— ì¬ëŠ¥ì´ ìˆëŠë‹ˆë¼.'});
  ì„±ê²©L.push({type:'h4',text:'í•©ì¶©ì— ë”°ë¥¸ ì‹¬ë¦¬'});
  if(a.í•©.length>0)ì„±ê²©L.push({t:`í•©(${a.í•©.join(',')})ì´ ìˆì–´ ì¡°í™”ë¡­ê³  ì‚¬êµì ì¸ ë©´ì´ ìˆìŠµë‹ˆë‹¤. ëŒ€ì¸ê´€ê³„ì—ì„œ ìœ ì—°í•œ í¸ì´ë‹ˆë¼.`});
  if(a.ì¶©.length>0)ì„±ê²©L.push({t:'ì¶©ì´ ìˆì–´ ë‚´ë©´ì˜ ê°ˆë“±ì´ ì¡´ì¬í•©ë‹ˆë‹¤. ê¸‰í•œ ì„±ê²©ê³¼ ë³€í™”ë¥¼ ì¶”êµ¬í•˜ëŠ” ê¸°ì§ˆì´ ìˆëŠë‹ˆë¼.',w:1});
  if(a.í˜•.length>0)ì„±ê²©L.push({t:'í˜•ì‚´ì´ ìˆì–´ ê³ ë‚œì„ í†µí•´ ì„±ì¥í•˜ëŠ” íƒ€ì…ì…ë‹ˆë‹¤. ì¸ë‚´ì‹¬ì„ ê¸°ë¥´ë©´ ëŒ€ì„±í•  ìˆ˜ ìˆëŠë‹ˆë¼.'});
  ì„±ê²©L.push({type:'h4',text:'ì¢…í•© ì„±ê²© í‰ê°€'});
  ì„±ê²©L.push({t:ì„±ê²©sc>=70?'ëŒ€ì²´ë¡œ ì›ë§Œí•˜ë©° ì‚¬êµì„±ì´ ì¢‹ì€ ì„±ê²©ì…ë‹ˆë‹¤.':ì„±ê²©sc>=50?'ë‚´ì„±ì ì´ê³  ìê¸° ì£¼ì¥ì´ ê°•í•œ í¸ì´ì•¼ì´ë‚˜, ì§„ì •ì„± ìˆëŠ” ê´€ê³„ë¥¼ í˜•ì„±í•©ë‹ˆë‹¤.':'ê¹Œë‹¤ë¡­ê³  ë…ë¦½ì ì¸ ì„±ê²©ìœ¼ë¡œ, ì†Œìˆ˜ì˜ ê¹Šì€ ê´€ê³„ë¥¼ ì„ í˜¸í•©ë‹ˆë‹¤.'});
  const ì„±ê²©=simpleCategory('ì„±ê²© ì‹¬ì¸µ','ğŸ§ ',ì„±ê²©L,ì„±ê²©sc);

  const ìš©ëª¨sc=Math.min(85,Math.max(25,50+(ê°•ì•½==='ì‹ ê°•'?8:-3)+(ss.ì‹ì‹ >=1?5:0)+(ss.ì •ê´€>=1?5:0)-(ss.í¸ê´€>=2?5:0)));
  const ìš©ëª¨L=[];
  ìš©ëª¨L.push({type:'h3',text:'â—‰ ìš©ëª¨ / ì¸ìƒ'});
  ìš©ëª¨L.push({type:'h4',text:'ì˜¤í–‰ë³„ ì™¸í˜• íŠ¹ì„±'});
  ìš©ëª¨L.push({t:OHV[ì¼oh]||'ì¼ê°„ ì˜¤í–‰ì— ë”°ë¥¸ ì™¸í˜•ì…ë‹ˆë‹¤.'});
  ìš©ëª¨L.push({type:'h4',text:'ì²´í˜•ê³¼ ì¸ìƒ'});
  ìš©ëª¨L.push({t:ê°•ì•½==='ì‹ ê°•'?'ì‹ ê°•ì´ë¼ ì²´ê²©ì´ ê±´ì¥í•˜ê³  ì¡´ì¬ê°ì´ ê°•í•©ë‹ˆë‹¤. ì–´ê¹¨ê°€ ë„“ê³  ëˆˆë¹›ì— í˜ì´ ìˆëŠ” íƒ€ì…ì…ë‹ˆë‹¤.':'ì‹ ì•½ì´ë¼ ë§ˆë¥¸ í¸ì´ê±°ë‚˜ ë¶€ë“œëŸ¬ìš´ ì¸ìƒì…ë‹ˆë‹¤. ì„¬ì„¸í•˜ê³  ì§€ì ì¸ ë¶„ìœ„ê¸°ë¥¼ í’ê¹ë‹ˆë‹¤.'});
  if(ss.ì‹ì‹ >=1)ìš©ëª¨L.push({t:'ì‹ì‹ ì´ ìˆì–´ ë¨¹ì„ ë³µì´ ìˆê³ , í’ì±„ê°€ ì¢‹ì€ í¸ì…ë‹ˆë‹¤. ì‚´ì´ ì˜ ì°ŒëŠ” ì²´ì§ˆì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'});
  if(ss.í¸ê´€>=2)ìš©ëª¨L.push({t:'í¸ê´€ì´ ê°•í•´ ë‚ ì¹´ë¡œìš´ ì¸ìƒì´ ìˆìœ¼ë©°, ì¹´ë¦¬ìŠ¤ë§ˆê°€ ëŠê»´ì§€ëŠ” ì™¸ëª¨ì…ë‹ˆë‹¤.'});
  if(ss.ì •ì¸>=1)ìš©ëª¨L.push({t:'ì •ì¸ì´ ìˆì–´ ì§€ì ì´ê³  ë‹¨ì •í•œ ì¸ìƒì„ ì¤ë‹ˆë‹¤.'});
  ìš©ëª¨L.push({type:'h4',text:'ë³´ì™„ í¬ì¸íŠ¸'});
  ìš©ëª¨L.push({t:`í–‰ìš´ìƒ‰ ${(OHL[ìš©ì‹ ]||{}).ìƒ‰||''}ì„ í™œìš©í•œ íŒ¨ì…˜ì´ ì¸ìƒì„ ì¢‹ê²Œ ë§Œë“­ë‹ˆë‹¤.`});
  const ìš©ëª¨=simpleCategory('ìš©ëª¨ / ì¸ìƒ','ğŸ‘¤',ìš©ëª¨L,ìš©ëª¨sc);

  const ì‚¬ê±´sc=Math.min(90,Math.max(20,75-a.ì¶©.length*12-a.í˜•.length*10));
  const ì‚¬ê±´L=[];
  ì‚¬ê±´L.push({type:'h3',text:'â—‰ ì‚¬ê±´ì‚¬ê³  ì£¼ì˜'});
  ì‚¬ê±´L.push({type:'h4',text:'ì¶©(æ²–)ì— ì˜í•œ ì‚¬ê±´'});
  if(a.ì¶©.length===0)ì‚¬ê±´L.push({t:'ì‚¬ì£¼ì— ì¶©ì´ ì—†ì–´ ëŒë°œ ì‚¬ê±´ì‚¬ê³  ìœ„í—˜ì´ ë¹„êµì  ë‚®ìŠµë‹ˆë‹¤.'});
  a.ì¶©.forEach(function(c){ì‚¬ê±´L.push({t:`${c.ì§€1}${c.ì§€2}ì¶©(${c.ìœ„ì¹˜}): ${ì¶©í•´[c.ìœ„ì¹˜]||'ë³€ë™ ì£¼ì˜'}`,w:1});});
  ì‚¬ê±´L.push({type:'h4',text:'í˜•(åˆ‘)ì— ì˜í•œ ì‚¬ê±´'});
  if(a.í˜•.length===0)ì‚¬ê±´L.push({t:'ì‚¬ì£¼ì— í˜•ì‚´ì´ ì—†ì–´ ë²•ì  ë¬¸ì œë‚˜ ìˆ˜ìˆ  ìœ„í—˜ì´ ë‚®ì€ í¸ì…ë‹ˆë‹¤.'});
  a.í˜•.forEach(function(h){ì‚¬ê±´L.push({t:`${h}: ë²•ì  ë¬¸ì œ, ìˆ˜ìˆ , ì‚¬ê³  ì•”ì‹œ. í•´ë‹¹ ì‹œê¸° ë¬¸ì„œÂ·ê³„ì•½ ì‚¼ê°€.`,w:1});});
  ì‚¬ê±´L.push({type:'h4',text:'ì˜ˆë°© ì¡°ì–¸'});
  ì‚¬ê±´L.push({t:ì‚¬ê±´sc>=60?'ì „ë°˜ì ìœ¼ë¡œ ì•ˆì •ì ì´ë‚˜, ëŒ€ìš´/ì„¸ìš´ì—ì„œ ì¶©Â·í˜•ì´ ê²¹ì¹˜ëŠ” í•´ì— ê°ë³„íˆ ì£¼ì˜í•˜ê±°ë¼.':'ì¶©/í˜•ì´ ë§ì•„ ì‚¬ê±´ì‚¬ê³  ìœ„í—˜ì´ ë†’ìŠµë‹ˆë‹¤. ë³´í—˜ ê°€ì…, ê±´ê°•ê²€ì§„, ë²•ë¥  ìë¬¸ì„ ì ê·¹ í™œìš©í•˜ì„¸ìš”.'});
  const ì‚¬ê±´=simpleCategory('ì‚¬ê±´ì‚¬ê³  ì£¼ì˜','âš¡',ì‚¬ê±´L,ì‚¬ê±´sc);

  const o=OHL[ìš©ì‹ ]||{};
  const ê¸°ì‹ =Object.keys(ìƒê·¹).find(function(k){return ìƒê·¹[k]===ìš©ì‹ ;});
  const í™˜ê²½L=[];
  í™˜ê²½L.push({type:'h3',text:'â—‰ ì¢‹ì€ í™˜ê²½ / í–‰ìš´ ìƒ‰ê¹”'});
  í™˜ê²½L.push({type:'h4',text:'ìš©ì‹  í™˜ê²½'});
  í™˜ê²½L.push({t:`ìš©ì‹  ${ìš©ì‹ } â†’ ê¸¸ë°©: ${o.ë°©||''}, í–‰ìš´ìƒ‰: ${o.ìƒ‰||''}, ìœ ë¦¬í•œ ê³„ì ˆ: ${o.ê³„||''}`});
  í™˜ê²½L.push({type:'h4',text:'ì ì„± ì—…ì¢…'});
  í™˜ê²½L.push({t:`${OHJ[ìš©ì‹ ]||''}`});
  í™˜ê²½L.push({type:'h4',text:'í”¼í•´ì•¼ í•  í™˜ê²½'});
  if(ê¸°ì‹ )í™˜ê²½L.push({t:`ê¸°ì‹  ${ê¸°ì‹ }(${(OHL[ê¸°ì‹ ]||{}).ìƒ‰||''}, ${(OHL[ê¸°ì‹ ]||{}).ë°©||''}) ë°©í–¥ê³¼ í™˜ê²½ì€ í”¼í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.`,w:1});
  else í™˜ê²½L.push({t:'íŠ¹ë³„íˆ í”¼í•´ì•¼ í•  í™˜ê²½ì€ ë‘ë“œëŸ¬ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.'});
  const í™˜ê²½=simpleCategory('ì¢‹ì€ í™˜ê²½ / í–‰ìš´ìƒ‰','ğŸ¨',í™˜ê²½L,65);

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // â‘¢ ê°€ì¡±ê´€ê³„ (ì ìˆ˜ í¬í•¨)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function relExt(label,icon,ss1,ss2,ì¶©ìœ„,score,extraLines){
    var cnt=ss[ss1]+ss[ss2];
    var L=[];
    L.push({type:'h3',text:'â—‰ '+label});
    L.push({type:'h4',text:ss1+'/'+ss2+' ì„¸ë ¥ ë¶„ì„'});
    L.push({t:ss1+'/'+ss2+'ì´ '+cnt+'ê°œ â€” '+(cnt>=2?'ì¸ì—°ì´ ê¹Šê³  ë„ì›€ì„ ë°›ê¸° ì‰¬ìš´ ëª…ì´ë‹ˆë¼.':cnt===1?'í‰ë²”í•œ ì¸ì—°ì…ë‹ˆë‹¤. ì„œë¡œ ë§ì¶°ê°€ëŠ” ë…¸ë ¥ì´ í•„ìš”í•˜ë‹ˆë¼.':'ì¸ì—°ì´ ì•½í•©ë‹ˆë‹¤. ë…ë¦½ì  ì„±ì¥ì´ í•„ìš”í•˜ë‹ˆë¼.')});
    L.push({type:'h4',text:'ì¶©/í˜• ì˜í–¥'});
    var hasChung=a.ì¶©.some(function(c){return c.ìœ„ì¹˜===ì¶©ìœ„;});
    if(hasChung)L.push({t:'âš  '+ì¶©ìœ„+'ì¶© â€” ê°ˆë“±/ì´ë³„ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤. ê´€ê³„ ê´€ë¦¬ì— ê°ë³„íˆ ì£¼ì˜í•˜ê±°ë¼.',w:1});
    else L.push({t:'í•´ë‹¹ ê¶ìœ„ì— ì¶©ì´ ì—†ì–´ ê´€ê³„ê°€ ë¹„êµì  ì•ˆì •ì ì´ë‹ˆë¼.'});
    L.push({type:'h4',text:'ì¢…í•© ê°ì •'});
    (extraLines||[]).forEach(function(el){L.push(el);});
    return simpleCategory(label,icon,L,score);
  }

  var ë¶€ëª¨sc=Math.min(85,Math.max(20,50+(ss.í¸ì¬+ss.ì •ì¬)*8+(ss.í¸ì¸+ss.ì •ì¸)*6-(a.ì¶©.some(function(c){return c.ìœ„ì¹˜==='ì—°ì›”';})?15:0)));
  const ë¶€ëª¨=relExt('ë¶€ëª¨ ê´€ê³„','ğŸ‘ª','í¸ì¬','ì •ì¬','ì—°ì›”',ë¶€ëª¨sc,[
    {type:'h4',text:'ì–´ë¨¸ë‹ˆ(ì¸ì„±) ë¶„ì„'},
    {t:'í¸ì¸/ì •ì¸ì´ '+(ss.í¸ì¸+ss.ì •ì¸)+'ê°œ â€” '+((ss.í¸ì¸+ss.ì •ì¸)>=2?'ì–´ë¨¸ë‹ˆì˜ ì‚¬ë‘ì„ ë§ì´ ë°›ìŠµë‹ˆë‹¤.':(ss.í¸ì¸+ss.ì •ì¸)>=1?'ì–´ë¨¸ë‹ˆì™€ ì ë‹¹í•œ ê´€ê³„ì…ë‹ˆë‹¤.':'ì–´ë¨¸ë‹ˆì˜ ë„ì›€ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.')}
  ]);

  var í˜•ì œsc=Math.min(85,Math.max(20,50+(ss.ë¹„ê²¬+ss.ê²ì¬)*5-(ss.ê²ì¬>=2?15:0)-(a.ì¶©.some(function(c){return c.ìœ„ì¹˜==='ì›”ì¼';})?10:0)));
  const í˜•ì œ=relExt('í˜•ì œ / ë™ë£Œ','ğŸ¤','ë¹„ê²¬','ê²ì¬','ì›”ì¼',í˜•ì œsc,
    ss.ê²ì¬>=2?[{t:'âš  ê²ì¬ ê³¼ë‹¤ â€” ê°€ê¹Œìš´ ì‚¬ëŒì—ê²Œ ì¬ë¬¼ ë¹¼ì•—ê¹€ ì£¼ì˜. ë™ì—…Â·ë³´ì¦ ì ˆëŒ€ ê¸ˆë¬¼.',w:1}]:[]
  );

  var ë°°ìš°ìSS=gender==='ë‚¨'?['ì •ì¬','í¸ì¬']:['ì •ê´€','í¸ê´€'];
  var ë°°ìš°ìsc=Math.min(85,Math.max(20,50+(ss[ë°°ìš°ìSS[0]]+ss[ë°°ìš°ìSS[1]])*10-(a.ì¶©.some(function(c){return c.ìœ„ì¹˜==='ì¼ì‹œ';})?15:0)-(gender==='ë‚¨'&&ss.ê²ì¬>=2?10:0)-(gender==='ì—¬'&&ss.ìƒê´€>=2?10:0)));
  const ë°°ìš°ì=relExt('ë°°ìš°ì / ì´ì„±','ğŸ’•',ë°°ìš°ìSS[0],ë°°ìš°ìSS[1],'ì¼ì‹œ',ë°°ìš°ìsc,[
    {t:'ì¼ì§€(ë°°ìš°ìê¶)ì— '+ì‹­ì„±(ì¼ê°„,ì •ê¸°T[ì¼ì§€])+' â€” '+(['ì •ì¬','ì •ê´€'].includes(ì‹­ì„±(ì¼ê°„,ì •ê¸°T[ì¼ì§€]))?'ì•ˆì •ì  ë°°ìš°ìê¶ì…ë‹ˆë‹¤.':'ë³€ë™ì„±ì´ ìˆëŠ” ë°°ìš°ìê¶ì…ë‹ˆë‹¤.')},
    ...(gender==='ë‚¨'&&ss.ê²ì¬>=2?[{t:'âš  ê²ì¬ê°€ ì¬ì„±ì„ ê·¹ â€” ì•„ë‚´ ê°ˆë“±/ì™¸ë„ ì£¼ì˜.',w:1}]:[]),
    ...(gender==='ì—¬'&&ss.ìƒê´€>=2?[{t:'âš  ìƒê´€ì´ ê´€ì„±ì„ ê·¹ â€” ë‚¨í¸ ì¶©ëŒ ì¦ìŒ. ë§ì¡°ì‹¬.',w:1}]:[]),
  ]);

  var ìì‹sc=Math.min(85,Math.max(20,50+(ss.ì‹ì‹ +ss.ìƒê´€)*8-(ss.í¸ì¸>=2?15:0)-(a.ì¶©.some(function(c){return c.ìœ„ì¹˜==='ì¼ì‹œ';})?8:0)));
  const ìì‹=relExt('ìì‹ ê´€ê³„','ğŸ‘¶','ì‹ì‹ ','ìƒê´€','ì¼ì‹œ',ìì‹sc,
    ss.í¸ì¸>=2?[{t:'âš  í¸ì¸ì´ ì‹ì‹ ì„ ê·¹(ë„ì‹) â€” ìë…€ ê±´ê°•Â·êµìœ¡ ë¬¸ì œ ê°€ëŠ¥.',w:1}]:[]
  );

  // ì§ì¥
  const ì§ì¥sc=Math.min(85,Math.max(20,50+(ss.ì •ê´€)*12+(ss.í¸ê´€)*5-(ss.ìƒê´€>=1&&ss.ì •ê´€>=1?15:0)+(ss.ì •ì¸>=1&&ss.ì •ê´€>=1?10:0)));
  const ì§ì¥=simpleCategory('ì§ì¥ / ì¶œì„¸ìš´','ğŸ¢',[
    {type:'h3',text:'â—‰ ì§ì¥ / ì¶œì„¸ìš´'},
    ...(ss.ì •ê´€>=1?[{t:'ì •ê´€ì´ ìˆì–´ ì¡°ì§ ë‚´ ìŠ¹ì§„ìš´ì´ ì¢‹ìŠµë‹ˆë‹¤. ì•ˆì •ì ì¸ ì§ì¥ ìƒí™œì— ì í•©í•˜ë‹ˆë¼.'}]:[]),
    ...(ss.í¸ê´€>=2?[{t:'í¸ê´€ì´ ê³¼ë‹¤í•˜ì—¬ ì§ì¥ ë‚´ ì••ë°•ì´ í¬ê³ , ì™¸ë¶€ ê²½ìŸì´ ì¹˜ì—´í•©ë‹ˆë‹¤. ê·¹ë³µí•˜ë©´ í¬ê²Œ ì¶œì„¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'}]:[]),
    ...(ss.ì •ê´€+ss.í¸ê´€===0?[{t:'ê´€ì„±ì´ ì—†ì–´ ì¡°ì§ë³´ë‹¤ ììœ ì—…ì´ ë§ìŠµë‹ˆë‹¤. í”„ë¦¬ëœì„œ, ì˜ˆìˆ ê°€, ì‚¬ì—…ê°€ ìª½ì´ ìœ ë¦¬í•˜ë‹ˆë¼.'}]:[]),
    ...(ss.ìƒê´€>=1&&ss.ì •ê´€>=1?[{t:'âš  ìƒê´€ê²¬ê´€ â€” ì§ì¥ì—ì„œ ìƒì‚¬ì™€ ì¶©ëŒí•˜ê¸° ì‰½ìŠµë‹ˆë‹¤. ì´ì§ì´ ì¦ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',w:1}]:[]),
    ...(ss.ì •ì¸>=1&&ss.ì •ê´€>=1?[{t:'ê´€ì¸ìƒìƒ â€” ê³µë¬´ì›, ëŒ€ê¸°ì—…, í•™ê³„ì—ì„œ ë‘ê°ì„ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'}]:[]),
  ],ì§ì¥sc);
  
  const í•™ë¬¸sc=Math.min(85,Math.max(20,50+(ss.ì •ì¸)*12+(ss.í¸ì¸)*6+(ss.ì‹ì‹ )*5-(ss.í¸ì¸>=2?10:0)));
  const í•™ë¬¸=simpleCategory('í•™ë¬¸ / ìì•„ì‹¤í˜„','ğŸ“š',[
    {type:'h3',text:'â—‰ í•™ë¬¸ / ìì•„ì‹¤í˜„'},
    ...(ss.ì •ì¸>=1?[{t:'ì •ì¸ì´ ìˆì–´ í•™ë¬¸ì  ì¬ëŠ¥ì´ ìˆëŠë‹ˆë¼. ìê²©ì¦, í•™ìœ„, ì „ë¬¸ì§ì— ìœ ë¦¬í•˜ë‹ˆë¼.'}]:[]),
    ...(ss.í¸ì¸>=2?[{t:'í¸ì¸ì´ ê³¼ë‹¤í•˜ì—¬ í•™ë¬¸ì€ ê¹Šì§€ë§Œ í•œ ë¶„ì•¼ì— ì˜¤ë˜ ë¨¸ë¬¼ê¸° ì–´ë µìŠµë‹ˆë‹¤. ì¡í•™ë‹¤ì‹í˜•ì´ë‹ˆë¼.'}]:[]),
    ...(ss.ì •ì¸+ss.í¸ì¸===0?[{t:'ì¸ì„±ì´ ì—†ì–´ ë…í•™ìœ¼ë¡œ ì„±ì·¨í•´ì•¼ í•©ë‹ˆë‹¤. í•™ì—°ë³´ë‹¤ ì‹¤ë ¥ìœ¼ë¡œ ì¸ì •ë°›ëŠ” íƒ€ì…ì…ë‹ˆë‹¤.'}]:[]),
    ...(ss.ì‹ì‹ >=1?[{t:'ì‹ì‹ ì´ ìˆì–´ í‘œí˜„ë ¥ê³¼ ì¬ì£¼ê°€ ìˆìŠµë‹ˆë‹¤. ì˜ˆì²´ëŠ¥, ê¸€ì“°ê¸°, ê°•ì—° ë“±ì—ì„œ ìì•„ì‹¤í˜„ì´ ê°€ëŠ¥í•˜ë‹ˆë¼.'}]:[]),
  ],í•™ë¬¸sc);
  
  const ì ì„±=simpleCategory('ì§ì—… / ì ì„±','ğŸ¯',[
    {type:'h3',text:'â—‰ ì§ì—… / ì ì„±'},
    {t:`ìš©ì‹  ${ìš©ì‹ } ê¸°ì¤€ ì ì„±: ${OHJ[ìš©ì‹ ]||''}`},
    ...(a.ê²©êµ­.includes('ì‹ì‹ ')?[{t:'ì‹ì‹ ê²© â€” ê¸°ìˆ ì§, ìš”ë¦¬, ì˜ˆìˆ , í”„ë¦¬ëœì„œì— ì í•©í•˜ë‹ˆë¼.'}]:[]),
    ...(a.ê²©êµ­.includes('ìƒê´€')?[{t:'ìƒê´€ê²© â€” ì°½ì˜ì  ì§ì—…, ì—°ì˜ˆ, ë³€í˜¸ì‚¬, ê¸°íšì— ì í•©í•˜ë‹ˆë¼.'}]:[]),
    ...(a.ê²©êµ­.includes('ì •ê´€')?[{t:'ì •ê´€ê²© â€” ê³µë¬´ì›, ëŒ€ê¸°ì—…, ê´€ë¦¬ì§ì— ìµœì í™”ëœ ê²©ì…ë‹ˆë‹¤.'}]:[]),
    ...(a.ê²©êµ­.includes('í¸ê´€')?[{t:'í¸ê´€ê²© â€” êµ°ì¸, ê²½ì°°, ê²€ì°°, ìŠ¤í¬ì¸  ë“± ê°•í•œ ì§ì—…ì´ ë§ìŠµë‹ˆë‹¤.'}]:[]),
    ...(a.ê²©êµ­.includes('ì •ì¬')?[{t:'ì •ì¬ê²© â€” ê²½ë¦¬, íšŒê³„, ê¸ˆìœµ, ì•ˆì •ì  ì‚¬ì—…ì´ ë§ìŠµë‹ˆë‹¤.'}]:[]),
    ...(a.ê²©êµ­.includes('í¸ì¬')?[{t:'í¸ì¬ê²© â€” íˆ¬ì, ë¬´ì—­, ëŒ€ê·œëª¨ ì‚¬ì—…ì— ì í•©í•˜ë‹ˆë¼.'}]:[]),
  ],60);

  // ë…„ìš´/ì›”ìš´
  function getYGJ(y){return{g:ì²œê°„[((y-4)%10+10)%10],j:ì§€ì§€[((y-4)%12+12)%12]};}
  const cy=2026;
  const ë…„ìš´=[];
  for(let y=cy;y<=cy+10;y++){
    const yg=getYGJ(y);const gSS=ì‹­ì„±(ì¼ê°„,yg.g);const jSS=ì‹­ì„±(ì¼ê°„,ì •ê¸°T[yg.j]);
    const í•´ì„=[],tags=[];let sc=50;
    const ssD={ë¹„ê²¬:['ë…ë¦½ì‹¬â†‘ ê²½ìŸ ì¹˜ì—´',-5],ê²ì¬:['ì¬ë¬¼ ë¶„ì‚° ì£¼ì˜. ë³´ì¦ ê¸ˆë¬¼',-12],ì‹ì‹ :['ë¨¹ì„ ë³µ, ìˆ˜ìµ ì¦ê°€ ê¸°íšŒ',10],ìƒê´€:['ë³€í™”ì™€ ë°˜í•­. ì´ì§ ê°€ëŠ¥',3],í¸ì¬:['í°ëˆ ì˜¤ê°. íˆ¬ì ê¸°íšŒ+ë¦¬ìŠ¤í¬',12],ì •ì¬:['ì•ˆì •ì  ì¬ë¬¼ìš´. ì €ì¶• ìœ ë¦¬',15],í¸ê´€:['ì™¸ë¶€ ì••ë°•. ê·¹ë³µì‹œ ì„±ì¥',-3],ì •ê´€:['ìŠ¹ì§„Â·í•©ê²©Â·ì¸ì •',10],í¸ì¸:['í•™ë¬¸Â·ìê²©ì¦ ìœ ë¦¬',5],ì •ì¸:['ê·€ì¸ ì¶œí˜„',8]};
    if(ssD[gSS]){í•´ì„.push(ssD[gSS][0]);sc+=ssD[gSS][1];}
    [saju.yj,saju.mj,saju.dj,saju.hj].forEach((z,idx)=>{ì¶©ìŒ.forEach(([aa,bb])=>{
      if((yg.j===aa&&z===bb)||(yg.j===bb&&z===aa)){í•´ì„.push(`âš  ${yg.j}${z}ì¶©(ì„¸ìš´â†”${['ì—°','ì›”','ì¼','ì‹œ'][idx]}ì§€) â€” ë³€ë™ ì£¼ì˜`);tags.push({t:'ë³€ë™',c:'orange'});sc-=5;}});});
    sc=Math.min(95,Math.max(10,sc));
    ë…„ìš´.push({ì—°ë„:y,ë‚˜ì´:y-birthYear,ê°„ì§€:yg.g+yg.j,gSS,jSS,í•´ì„,tags,sc});
  }

  const ì›”ê±´B={'ç”²':2,'å·±':2,'ä¹™':4,'åºš':4,'ä¸™':6,'è¾›':6,'ä¸':8,'å£¬':8,'æˆŠ':0,'ç™¸':0};
  const ygC=getYGJ(cy);const mbase=ì›”ê±´B[ygC.g];
  const ì›”ëª…=['ì¸(2~3)','ë¬˜(3~4)','ì§„(4~5)','ì‚¬(5~6)','ì˜¤(6~7)','ë¯¸(7~8)','ì‹ (8~9)','ìœ (9~10)','ìˆ (10~11)','í•´(11~12)','ì(12~1)','ì¶•(1~2)'];
  const ì›”ìš´=[];
  for(let i=0;i<12;i++){const mg=ì²œê°„[(mbase+i)%10],mj=ì§€ì§€[(i+2)%12];const mss=ì‹­ì„±(ì¼ê°„,mg);
    let h='';if(['ì •ì¬','í¸ì¬'].includes(mss))h='ì¬ë¬¼ìš´â†‘';else if(['ì •ê´€','í¸ê´€'].includes(mss))h='ì‚¬íšŒìš´â†‘';
    else if(mss==='ì‹ì‹ ')h='ë³µë¡â†‘';else if(mss==='ìƒê´€')h='ë³€ë™Â·êµ¬ì„¤ìˆ˜';else if(['ì •ì¸','í¸ì¸'].includes(mss))h='í•™ì—…Â·ê·€ì¸';
    else if(mss==='ë¹„ê²¬')h='ê²½ìŸÂ·ë…ë¦½';else if(mss==='ê²ì¬')h='ì†ì‹¤ ì£¼ì˜';
    ì›”ìš´.push({ì›”:ì›”ëª…[i],ê°„ì§€:mg+mj,ss:mss,í•œì¤„:h});}

  return{
    ì¬ë¬¼:{ì •ì¬:{lines:ì •ì¬L,score:ss.ì •ì¬>0?55+ss.ì •ì¬*15:25},í¸ì¬:{lines:í¸ì¬L,score:ss.í¸ì¬>0?50+ss.í¸ì¬*15:20},ì„ ì²œ:{lines:ì„ ì²œì¬,score:ì¬ì },ëŒ€ìš´:ëŒ€ìš´ì¬},
    ê°œì¸íŠ¹ì„±:[ê±´ê°•,ì„±ê²©,ìš©ëª¨,ì‚¬ê±´,í™˜ê²½],
    ê°€ì¡±ê´€ê³„:[ë¶€ëª¨,í˜•ì œ,ë°°ìš°ì,ìì‹],
    ì‚¬íšŒìƒí™œ:[ì§ì¥,í•™ë¬¸,ì ì„±],
    ë…„ìš´,ì›”ìš´,
  };
}

// ============================================================
// í”„ë¦¬ë¯¸ì—„ UI ì»´í¬ë„ŒíŠ¸
// ============================================================
function Tag({text,color}){
  const colors={blue:'#3060c0',red:'#c04040',green:'#408040',orange:'#c08030'};
  return <span style={{display:'inline-block',fontSize:10,fontWeight:600,color:'#fff',background:colors[color]||'#666',borderRadius:3,padding:'1px 6px',margin:'1px 2px'}}>{text}</span>;
}

function ScoreBar({score,label}){
  const good=Math.max(0,Math.min(100,score)),bad=100-good;
  return(
    <div style={{marginBottom:4}}>
      {label&&<div style={{fontSize:10,color:'#8a7e6d',marginBottom:2}}>{label}</div>}
      <div style={{display:'flex',height:16,borderRadius:3,overflow:'hidden',border:'1px solid rgba(180,140,80,0.1)'}}>
        <div style={{width:`${bad}%`,background:'linear-gradient(90deg,#c44040,#d07060)',display:'flex',alignItems:'center',justifyContent:'flex-start',paddingLeft:2}}>
          {bad>=15&&<span style={{fontSize:8,color:'rgba(255,255,255,0.7)'}}>{bad}%</span>}
        </div>
        <div style={{width:`${good}%`,background:'linear-gradient(90deg,#408040,#60a060)',display:'flex',alignItems:'center',justifyContent:'flex-end',paddingRight:2}}>
          {good>=15&&<span style={{fontSize:8,color:'rgba(255,255,255,0.7)'}}>{good}%</span>}
        </div>
      </div>
    </div>
  );
}

function DetailLines({lines}){
  if(!lines||!lines.length)return null;
  return(<>
    {lines.map((l,i)=>{
      if(l.type==='h3')return <div key={i} style={{fontSize:14,fontWeight:700,color:'#d0c0a0',borderLeft:'3px solid #b48c50',paddingLeft:8,marginTop:i>0?16:0,marginBottom:4,fontFamily:"'Noto Serif KR',serif"}}>{l.text}</div>;
      if(l.type==='h4')return <div key={i} style={{fontSize:11,fontWeight:600,color:'#b48c50',marginTop:10,marginBottom:2,letterSpacing:1}}>â˜… {l.text}</div>;
      if(l.tag)return <Tag key={i} text={l.tag} color={l.c}/>;
      if(l.type==='subheader')return <div key={i} style={{fontSize:11,fontWeight:600,color:'#b48c50',marginTop:8,marginBottom:2}}>â— {l.text}</div>;
      return <div key={i} style={{fontSize:11.5,lineHeight:1.8,color:l.w?'#c06050':'#b8b0a0',paddingLeft:l.dim?12:0,marginBottom:1}}>{l.dim?'â–¸ ':''}{toMansin(l.t||l.text||'')}</div>;
    })}
  </>);
}

// AI í•´ì„¤ í‘œì‹œ ë¸”ë¡
function AiBlock({text,loading,loadingKey,currentKey}){
  if(loading&&loadingKey===currentKey)return(
    <div style={{padding:16,textAlign:'center'}}>
      <div style={{fontSize:12,color:'#a090d0'}}>ë°”ë¦¬ë§Œì‹ ì´ ì²œê¸°ë¥¼ ì½ê³  ìˆìŠµë‹ˆë‹¤...</div>
      <style>{'.aiPulse{animation:aiP 1.5s infinite}@keyframes aiP{0%,100%{opacity:.4}50%{opacity:1}}'}</style>
      <div className="aiPulse" style={{marginTop:8,fontSize:20}}>ğŸ”®</div>
    </div>
  );
  if(!text)return null;
  return(
    <div style={{marginTop:12,padding:'12px 10px',background:'rgba(130,100,200,0.06)',borderRadius:8,border:'1px solid rgba(160,120,200,0.1)'}}>
      <div style={{fontSize:10,color:'#8060c0',fontWeight:700,marginBottom:6,letterSpacing:2}}>ğŸ”® ë°”ë¦¬ë§Œì‹  í•´ì„¤</div>
      {text.split('\n').map(function(line,i){
        if(!line.trim())return <div key={i} style={{height:6}}/>;
        var isBold=line.startsWith('**')||line.startsWith('##')||line.startsWith('â—‰')||line.startsWith('â˜…')||line.startsWith('â—');
        var isWarn=line.includes('ì£¼ì˜')||line.includes('âš ')||line.includes('ê²½ê³ ');
        return <div key={i} style={{fontSize:isBold?12:11.5,fontWeight:isBold?700:400,lineHeight:1.85,color:isWarn?'#d08060':isBold?'#d0b0ff':'#c0b8d0',marginBottom:isBold?4:1}}>{line.replace(/^\*\*|\*\*$/g,'').replace(/^##\s*/,'')}</div>;
      })}
    </div>
  );
}

// ============================================================
// ê¶í•© ë§¤ì¹­ ì—”ì§„
// ============================================================
var í•©ìŒM={'ç”²å·±':{n:'ì¤‘ì •ì§€í•©',s:20},'ä¹™åºš':{n:'ì¸ì˜ì§€í•©',s:20},'ä¸™è¾›':{n:'ìœ„ì—„ì§€í•©',s:18},'ä¸å£¬':{n:'ìŒìš•ì§€í•©',s:16},'æˆŠç™¸':{n:'ë¬´ì •ì§€í•©',s:17}};
var ìœ¡í•©M={'å­ä¸‘':1,'ä¸‘å­':1,'å¯…äº¥':1,'äº¥å¯…':1,'å¯æˆŒ':1,'æˆŒå¯':1,'è¾°é…‰':1,'é…‰è¾°':1,'å·³ç”³':1,'ç”³å·³':1,'åˆæœª':1,'æœªåˆ':1};
var ì¶©M=[['å­','åˆ'],['ä¸‘','æœª'],['å¯…','ç”³'],['å¯','é…‰'],['è¾°','æˆŒ'],['å·³','äº¥']];
function matchScore(A,B,gA,gB){var sc=0;var p=A.dg+B.dg,p2=B.dg+A.dg;if(í•©ìŒM[p]||í•©ìŒM[p2])sc+=(í•©ìŒM[p]||í•©ìŒM[p2]).s;else{var ao=ì²œê°„ì˜¤í–‰[A.dg],bo=ì²œê°„ì˜¤í–‰[B.dg];if(ao===bo)sc+=10;else if(ìƒìƒ[ao]===bo||ìƒìƒ[bo]===ao)sc+=14;else if(ìƒê·¹[ao]===bo||ìƒê·¹[bo]===ao)sc+=5;else sc+=8;}var dA=A.dj,dB=B.dj;if(ìœ¡í•©M[dA+dB])sc+=22;else{var a2=ì§€ì§€ì˜¤í–‰[dA],b2=ì§€ì§€ì˜¤í–‰[dB];if(ìƒìƒ[a2]===b2||ìƒìƒ[b2]===a2)sc+=12;else sc+=6;}for(var i=0;i<ì¶©M.length;i++){if((dA===ì¶©M[i][0]&&dB===ì¶©M[i][1])||(dA===ì¶©M[i][1]&&dB===ì¶©M[i][0]))sc-=15;}function cnt(s){var r={ëª©:0,í™”:0,í† :0,ê¸ˆ:0,ìˆ˜:0};[s.yg,s.mg,s.dg,s.hg].forEach(function(g){if(ì²œê°„ì˜¤í–‰[g])r[ì²œê°„ì˜¤í–‰[g]]++;});[s.yj,s.mj,s.dj,s.hj].forEach(function(j){if(ì§€ì§€ì˜¤í–‰[j])r[ì§€ì§€ì˜¤í–‰[j]]++;});return r;}var ca=cnt(A),cb=cnt(B),comp=0;['ëª©','í™”','í† ','ê¸ˆ','ìˆ˜'].forEach(function(o){if(ca[o]===0&&cb[o]>=1)comp++;if(cb[o]===0&&ca[o]>=1)comp++;});sc+=comp>=4?15:comp>=2?11:comp>=1?8:5;sc+=7;if(gA!==gB){var ml=gA==='ë‚¨'?A:B,fm=gA==='ì—¬'?A:B;var m2f=ì‹­ì„±(ml.dg,fm.dg),f2m=ì‹­ì„±(fm.dg,ml.dg);if((m2f==='ì •ì¬'||m2f==='í¸ì¬')&&(f2m==='ì •ê´€'||f2m==='í¸ê´€'))sc+=10;else if(m2f==='ì •ì¬'||m2f==='í¸ì¬'||f2m==='ì •ê´€'||f2m==='í¸ê´€')sc+=8;else sc+=5;}else sc+=6;var cls=0,aZ=[A.yj,A.mj,A.dj,A.hj],bZ=[B.yj,B.mj,B.dj,B.hj];for(var x=0;x<4;x++)for(var y=0;y<4;y++)for(var z=0;z<ì¶©M.length;z++){if((aZ[x]===ì¶©M[z][0]&&bZ[y]===ì¶©M[z][1])||(aZ[x]===ì¶©M[z][1]&&bZ[y]===ì¶©M[z][0]))cls++;}sc+=cls===0?10:cls<=3?6:2;return Math.max(5,Math.min(100,sc));}

function matchDetail(A,B,gA,gB){var d=[],tags=[],sc=0;var p=A.dg+B.dg,p2=B.dg+A.dg,h=í•©ìŒM[p]||í•©ìŒM[p2];if(h){sc+=h.s;d.push('ì¼ê°„ '+A.dg+'â†”'+B.dg+' ì²œê°„í•©('+h.n+') â€” ê°•í•˜ê²Œ ëŒë¦¬ëŠ” ì¸ì—°!');tags.push({t:'ì²œê°„í•©',c:'green'});}else{var ao=ì²œê°„ì˜¤í–‰[A.dg],bo=ì²œê°„ì˜¤í–‰[B.dg];if(ìƒìƒ[ao]===bo||ìƒìƒ[bo]===ao){sc+=14;d.push('ì¼ê°„ ìƒìƒ('+ao+'â†”'+bo+') â€” ìì—°ìŠ¤ëŸ¬ìš´ ì¡°í™”.');}else if(ìƒê·¹[ao]===bo||ìƒê·¹[bo]===ao){sc+=5;d.push('ì¼ê°„ ìƒê·¹('+ao+'â†”'+bo+') â€” ê°ˆë“± ìš”ì†Œ, ì„±ì¥ ìê·¹.');tags.push({t:'ìƒê·¹',c:'red'});}else{sc+=8;d.push('ì¼ê°„ ë¬´ë‚œí•œ ê´€ê³„.');}}var dA=A.dj,dB=B.dj;if(ìœ¡í•©M[dA+dB]){sc+=22;d.push('ì¼ì§€ '+dA+'â†”'+dB+' ìœ¡í•© â€” ë°°ìš°ìê¶ í•©!');tags.push({t:'ìœ¡í•©',c:'green'});}else{var ck=false;for(var i=0;i<ì¶©M.length;i++){if((dA===ì¶©M[i][0]&&dB===ì¶©M[i][1])||(dA===ì¶©M[i][1]&&dB===ì¶©M[i][0])){sc-=15;d.push('âš  ì¼ì§€ '+dA+'â†”'+dB+' ì¶©! ë°°ìš°ìê¶ ì¶©ëŒ.');tags.push({t:'ì¼ì§€ì¶©',c:'red'});ck=true;}}if(!ck){var a2=ì§€ì§€ì˜¤í–‰[dA],b2=ì§€ì§€ì˜¤í–‰[dB];if(ìƒìƒ[a2]===b2||ìƒìƒ[b2]===a2){sc+=12;d.push('ì¼ì§€ ìƒìƒ â€” ê°€ì • ì¡°í™”.');}else{sc+=6;d.push('ì¼ì§€ ë¬´ë‚œ.');}}}function cnt(s){var r={ëª©:0,í™”:0,í† :0,ê¸ˆ:0,ìˆ˜:0};[s.yg,s.mg,s.dg,s.hg].forEach(function(g){if(ì²œê°„ì˜¤í–‰[g])r[ì²œê°„ì˜¤í–‰[g]]++;});[s.yj,s.mj,s.dj,s.hj].forEach(function(j){if(ì§€ì§€ì˜¤í–‰[j])r[ì§€ì§€ì˜¤í–‰[j]]++;});return r;}var ca=cnt(A),cb=cnt(B),cp2=0,cd=[];['ëª©','í™”','í† ','ê¸ˆ','ìˆ˜'].forEach(function(o){if(ca[o]===0&&cb[o]>=1){cp2++;cd.push(A.dg+'ì˜ '+o+'â†’'+B.dg+'ê°€ ë³´ì™„');}if(cb[o]===0&&ca[o]>=1){cp2++;cd.push(B.dg+'ì˜ '+o+'â†’'+A.dg+'ê°€ ë³´ì™„');}});if(cp2>=3){sc+=15;d.push('ì˜¤í–‰ ì™„ë²½ ë³´ì™„! '+cd.join(', '));tags.push({t:'ì™„ë²½ë³´ì™„',c:'green'});}else if(cp2>=1){sc+=8+cp2*2;d.push('ì˜¤í–‰ ë³´ì™„: '+cd.join(', '));}else{sc+=5;d.push('ì˜¤í–‰ ë³´ì™„ ì•½í•¨.');}sc+=7;if(gA!==gB){var ml=gA==='ë‚¨'?A:B,fm=gA==='ì—¬'?A:B;var m2f=ì‹­ì„±(ml.dg,fm.dg),f2m=ì‹­ì„±(fm.dg,ml.dg);d.push('ë‚¨('+ml.dg+')â†’ì—¬('+fm.dg+'): '+m2f+' / ì—¬â†’ë‚¨: '+f2m);if((m2f==='ì •ì¬'||m2f==='í¸ì¬')&&(f2m==='ì •ê´€'||f2m==='í¸ê´€')){sc+=10;d.push('ì¬ê´€êµí™˜ â€” ë¶€ë¶€ê¶í•© ìµœìƒ!');tags.push({t:'ì¬ê´€êµí™˜',c:'green'});}else if(m2f==='ì •ì¬'||m2f==='í¸ì¬'){sc+=8;d.push('ë‚¨â†’ì—¬ ì¬ì„± â€” í˜¸ê°.');}else sc+=5;}var cls=0,aZ=[A.yj,A.mj,A.dj,A.hj],bZ=[B.yj,B.mj,B.dj,B.hj];for(var x=0;x<4;x++)for(var y=0;y<4;y++)for(var z=0;z<ì¶©M.length;z++){if((aZ[x]===ì¶©M[z][0]&&bZ[y]===ì¶©M[z][1])||(aZ[x]===ì¶©M[z][1]&&bZ[y]===ì¶©M[z][0]))cls++;}sc+=cls===0?10:cls<=3?6:2;if(cls===0){d.push('ì¶©ê·¹ ì—†ìŒ â€” í‰í™”.');tags.push({t:'ë¬´ì¶©',c:'green'});}else d.push('ì¶© '+cls+'ê°œ â€” ê°ˆë“± ìš”ì†Œ.');sc=Math.max(5,Math.min(100,sc));var gr=sc>=85?'ì²œìƒì—°ë¶„':sc>=75?'ìƒí•©':sc>=65?'ê¸¸í•©':sc>=50?'ë³´í†µ':sc>=35?'ì†Œí‰':'í‰í•©';return{score:sc,grade:gr,details:d,tags:tags};}

var MOCK_USERS=[
{id:1,name:'ìˆ˜ë¹ˆ',age:28,gender:'ì—¬',bio:'ì»¤í”¼ì™€ ê³ ì–‘ì´',saju:{yg:'å·±',yj:'å·³',mg:'ä¸',mj:'å¯',dg:'è¾›',dj:'æœª',hg:'æˆŠ',hj:'å­'}},
{id:2,name:'ë¯¼ì¤€',age:30,gender:'ë‚¨',bio:'ê°œë°œì, ë“±ì‚°íŒŒ',saju:{yg:'ä¹™',yj:'ä¸‘',mg:'å·±',mj:'å¯',dg:'ç”²',dj:'å­',hg:'ç”²',hj:'å­'}},
{id:3,name:'ì„œì—°',age:26,gender:'ì—¬',bio:'ê·¸ë¦¼ ê·¸ë ¤ìš”',saju:{yg:'ç™¸',yj:'äº¥',mg:'ä¹™',mj:'å¯',dg:'å·±',dj:'ä¸‘',hg:'ä¸™',hj:'å¯…'}},
{id:4,name:'ì§€í˜¸',age:32,gender:'ë‚¨',bio:'ìš”ë¦¬ ì¦ê²¨ìš”',saju:{yg:'å£¬',yj:'æˆŒ',mg:'å£¬',mj:'å­',dg:'ä¸™',dj:'åˆ',hg:'åºš',hj:'å¯…'}},
{id:5,name:'í•˜ì€',age:27,gender:'ì—¬',bio:'ì—¬í–‰ê³¼ ë…ì„œ',saju:{yg:'ä¸',yj:'å¯',mg:'ç™¸',mj:'ä¸‘',dg:'åºš',dj:'ç”³',hg:'ä¸',hj:'äº¥'}},
{id:6,name:'ë„ìœ¤',age:29,gender:'ë‚¨',bio:'ìŒì•… ì‘ê³¡',saju:{yg:'è¾›',yj:'æœª',mg:'ç”²',mj:'åˆ',dg:'ä¸',dj:'é…‰',hg:'å£¬',hj:'å­'}},
{id:7,name:'ì§€ìœ ',age:25,gender:'ì—¬',bio:'ìŠ¤íƒ€íŠ¸ì—… ê·¼ë¬´',saju:{yg:'æˆŠ',yj:'å¯…',mg:'åºš',mj:'ç”³',dg:'å£¬',dj:'è¾°',hg:'ç”²',hj:'è¾°'}},
{id:8,name:'ì‹œìš°',age:31,gender:'ë‚¨',bio:'ì‚¬ì§„ì‘ê°€',saju:{yg:'åºš',yj:'è¾°',mg:'ä¸™',mj:'æˆŒ',dg:'æˆŠ',dj:'åˆ',hg:'å·±',hj:'æœª'}},
{id:9,name:'ì±„ì›',age:24,gender:'ì—¬',bio:'ëŒ€í•™ì›ìƒ',saju:{yg:'å£¬',yj:'åˆ',mg:'ä¸',mj:'æœª',dg:'ä¹™',dj:'å¯',hg:'ä¸',hj:'ä¸‘'}},
{id:10,name:'ì˜ˆì¤€',age:33,gender:'ë‚¨',bio:'ë³€í˜¸ì‚¬',saju:{yg:'ç™¸',yj:'ä¸‘',mg:'ç”²',mj:'å¯…',dg:'è¾›',dj:'é…‰',hg:'åºš',hj:'å¯…'}},
{id:11,name:'ìœ¤ì„œ',age:28,gender:'ì—¬',bio:'í”Œë¡œë¦¬ìŠ¤íŠ¸',saju:{yg:'ä¸™',yj:'è¾°',mg:'æˆŠ',mj:'æˆŒ',dg:'ç™¸',dj:'äº¥',hg:'ç”²',hj:'å­'}},
{id:12,name:'ê±´ìš°',age:27,gender:'ë‚¨',bio:'ì¶•êµ¬ ì¢‹ì•„ìš”',saju:{yg:'å·±',yj:'å¯',mg:'ä¸',mj:'ä¸‘',dg:'åºš',dj:'è¾°',hg:'è¾›',hj:'å·³'}},
];

// ============================================================
// ë©”ì¸ ì•±
// ============================================================
const CY=2026;
const YEARS=Array.from({length:80},(_,i)=>({v:CY-10-i,l:`${CY-10-i}`}));
const MONTHS=Array.from({length:12},(_,i)=>({v:i+1,l:`${i+1}ì›”`}));
const DAYS=Array.from({length:31},(_,i)=>({v:i+1,l:`${i+1}ì¼`}));
const HOURS=[...Array.from({length:24},(_,i)=>{const ì‹œ=['å­','ä¸‘','ä¸‘','å¯…','å¯…','å¯','å¯','è¾°','è¾°','å·³','å·³','åˆ','åˆ','æœª','æœª','ç”³','ç”³','é…‰','é…‰','æˆŒ','æˆŒ','äº¥','äº¥','å­'][i];return{v:i,l:`${i}ì‹œ(${ì‹œ})`};}),{v:-1,l:'ëª¨ë¦„'}];

export default function App(){
  const[phase,setPhase]=useState('intro');
  const[form,setForm]=useState({year:1995,month:5,day:15,hour:12,gender:'ë‚¨',city:127});
  const[result,setResult]=useState(null);

  const[premium,setPremium]=useState(null);
  const[paidTab,setPaidTab]=useState('ê°œì¸íŠ¹ì„±');
  const[aiCache,setAiCache]=useState({});
  const[aiLoading,setAiLoading]=useState('');
  const[aiError,setAiError]=useState('');
  const[aiDetailKey,setAiDetailKey]=useState(null);
  const[aiDetailTitle,setAiDetailTitle]=useState('');
  const[aiDetailRule,setAiDetailRule]=useState('');
  const[transStep,setTransStep]=useState(0);
  const[introStep,setIntroStep]=useState(0);
  const[loadStep,setLoadStep]=useState(0);
  const[matches,setMatches]=useState([]);
  const[chatTarget,setChatTarget]=useState(null);
  const[chatMsgs,setChatMsgs]=useState({});
  const[chatInput,setChatInput]=useState('');
  const[detailTarget,setDetailTarget]=useState(null);
  const chatRef=useRef(null);
  useEffect(function(){if(chatRef.current)chatRef.current.scrollTop=chatRef.current.scrollHeight;},[chatMsgs,chatTarget]);
  useEffect(function(){if(phase!=='transition')return;if(transStep>=6)return;var delays=[800,2200,2000,2200,2400,0];var d=delays[transStep]||2000;var t=setTimeout(function(){setTransStep(function(s){return s+1;});},d);return function(){clearTimeout(t);};},[phase,transStep]);
  useEffect(function(){if(phase!=='intro')return;if(introStep>=4)return;var delays=[300,1000,1200,1200];var d=delays[introStep]||1000;var t=setTimeout(function(){setIntroStep(function(s){return s+1;});},d);return function(){clearTimeout(t);};},[phase,introStep]);
  useEffect(function(){if(phase!=='loading')return;if(loadStep>=4)return;var delays=[500,1800,2000,1500];var d=delays[loadStep]||1500;var t=setTimeout(function(){setLoadStep(function(s){return s+1;});},d);return function(){clearTimeout(t);};},[phase,loadStep]);

  // ê¸€ë¡œë²Œ CSS ì£¼ì… â€” SVG/ì»´í¬ë„ŒíŠ¸ í…Œë‘ë¦¬ ì™„ì „ ì œê±°
  useEffect(function(){
    var id='saju-global-css';
    if(document.getElementById(id))return;
    var style=document.createElement('style');
    style.id=id;
    style.textContent=[
      'svg,svg *{border:0!important;outline:0!important;box-shadow:none!important;-webkit-tap-highlight-color:transparent!important}',
      '*:focus{outline:none!important}',
      'div>svg,span>svg{border:0!important;outline:0!important}',
      'img,svg{-webkit-user-select:none;user-select:none}',
    ].join('');
    document.head.appendChild(style);
    return function(){var el=document.getElementById(id);if(el)el.remove();};
  },[]);

  // ì‚¬ì£¼ ìš”ì•½ ë¬¸ìì—´ (AI í”„ë¡¬í”„íŠ¸ìš©)
  const sajuSummary=()=>{
    if(!result)return'';
    const s=result.saju;
    return `ì‚¬ì£¼ì›êµ­: ${s.yg}${s.yj}(ë…„) ${s.mg}${s.mj}(ì›”) ${s.dg}${s.dj}(ì¼) ${s.hg}${s.hj}(ì‹œ), ${s.gender}ì„±, ${result.ì¼ê°„}${result.ì¼ì§€}ì¼ì£¼, ${result.ê²©êµ­}, ${result.ê°•ì•½}, ìš©ì‹ :${result.ìš©ì‹ }, ì˜¤í–‰ì „ë¬´:${result.ì˜¤í–‰.ì „ë¬´.join(',')||'ì—†ìŒ'}, ì˜¤í–‰ê³¼ë‹¤:${result.ì˜¤í–‰.ê³¼ë‹¤.join(',')||'ì—†ìŒ'}`;
  };

  // AI í˜¸ì¶œ â€” ìì²´ ë°±ì—”ë“œ(/api/enrich) ê²½ìœ  â†’ Gemini
  var enrichWithAI = async function(key, ruleText) {
    if(aiCache[key] || aiLoading) return;
    setAiLoading(key);
    setAiError('');
    var saju = sajuSummary();

    try {
      var controller = new AbortController();
      var timeout = setTimeout(function(){ controller.abort(); }, 35000);
      var response = await fetch("/api/enrich", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ruleText: ruleText, sajuSummary: saju }),
        signal: controller.signal
      });
      clearTimeout(timeout);
      var data = await response.json();
      if (!response.ok) {
        throw new Error(data.error || 'HTTP ' + response.status);
      }
      if (!data.text) throw new Error('ë¹ˆ ì‘ë‹µ');
      var text = cleanAiText(data.text);
      setAiCache(function(prev) { var next = Object.assign({}, prev); next[key] = text; return next; });
    } catch(err) {
      console.error('AI enrichment error:', err);
      var msg = String(err.message || err);
      if (err.name === 'AbortError') msg = 'ì‘ë‹µ ì‹œê°„ ì´ˆê³¼ (30ì´ˆ). ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
      setAiError(msg);
    }
    setAiLoading('');
  };

  // AI ì‘ë‹µ í›„ì²˜ë¦¬ â€” ì² ì €íˆ ì •ë¦¬ (ë”°ì˜´í‘œ, ë§ˆí¬ë‹¤ìš´, AIë§ë²„ë¦‡ ì „ë¶€ ì œê±°)
  function cleanAiText(t) {
    if(!t) return t;
    // ëª¨ë“  ì¢…ë¥˜ì˜ ë”°ì˜´í‘œ ì œê±°
    t = t.replace(/[\u201C\u201D\u2018\u2019\u300C\u300D\u300E\u300F\u0022\u0027]/g, '');
    // ë°±í‹± ì œê±°
    t = t.replace(/`/g, '');
    // ë§ˆí¬ë‹¤ìš´ ë³¼ë“œ â†’ ã€ã€‘ë¡œ ë³€í™˜
    t = t.replace(/\*\*([^*]+)\*\*/g, '\u3010$1\u3011');
    // ë§ˆí¬ë‹¤ìš´ ì´íƒ¤ë¦­ ì œê±°
    t = t.replace(/\*([^*]+)\*/g, '$1');
    // ë§ˆí¬ë‹¤ìš´ í—¤ë”© ì œê±°
    t = t.replace(/^#{1,4}\s*/gm, '');
    // ë¦¬ìŠ¤íŠ¸ ë§ˆì»¤ ì œê±°
    t = t.replace(/^[\-\u2022\u25CF\u25C6\u25B8\u25B9\u25B6\u25A0\u25C7\u00B7]\s*/gm, '');
    // ë²ˆí˜¸ ë¦¬ìŠ¤íŠ¸ ì œê±°
    t = t.replace(/^\d+\.\s*/gm, '');
    t = t.replace(/^\d+\)\s*/gm, '');
    // ì´ëª¨ì§€ ì¤„ ì‹œì‘ ì œê±°
    t = t.replace(/^[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]\s*/gmu, '');
    // ì½œë¡  ë¼ë²¨ ìŠ¤íƒ€ì¼ ì •ë¦¬
    t = t.replace(/^[ê°€-í£A-Za-z\s]+:\s*/gm, function(m) {
      return m.length > 15 ? m : '';
    });
    // --- êµ¬ë¶„ì„  ì œê±°
    t = t.replace(/^[\-=]{3,}\s*$/gm, '');
    // AI ë§ë²„ë¦‡ ì œê±°
    t = t.replace(/^(ì,?\s*|ê·¸ë ‡ë‹¤ë©´\s*|ë‹¤ìŒìœ¼ë¡œ\s*|ë§ˆì§€ë§‰ìœ¼ë¡œ\s*|ê²°ë¡ ì ìœ¼ë¡œ\s*|ìš”ì•½í•˜ìë©´\s*|ì •ë¦¬í•˜ìë©´\s*|ì¢…í•©í•˜ë©´\s*|ì¦‰,?\s*|ë”°ë¼ì„œ\s*|í•œë§ˆë””ë¡œ\s*)/gm, '');
    // "~ì´ë‹¤." ê°™ì€ ì„¤ëª…ì²´ â†’ ë°”ë¦¬ë§Œì‹  ë§íˆ¬ë¡œ êµì •
    t = t.replace(/ì…ë‹ˆë‹¤\./g, 'ì´ë‹ˆë¼.');
    t = t.replace(/í•©ë‹ˆë‹¤\./g, 'í•˜ëŠë‹ˆë¼.');
    t = t.replace(/ë©ë‹ˆë‹¤\./g, 'ë˜ëŠë‹ˆë¼.');
    t = t.replace(/ìŠµë‹ˆë‹¤\./g, 'ëŠë‹ˆë¼.');
    t = t.replace(/ì„¸ìš”\./g, 'ê±°ë¼.');
    t = t.replace(/í•˜ì„¸ìš”/g, 'í•˜ê±°ë¼');
    t = t.replace(/ì‹­ì‹œì˜¤/g, 'ê±°ë¼');
    t = t.replace(/ë³´ì„¸ìš”/g, 'ë³´ê±°ë¼');
    t = t.replace(/ë“œë¦½ë‹ˆë‹¤/g, 'ì£¼ë§ˆ');
    t = t.replace(/ê² ìŠµë‹ˆë‹¤/g, 'ê² ëŠë‹ˆë¼');
    t = t.replace(/ìˆìŠµë‹ˆë‹¤/g, 'ìˆëŠë‹ˆë¼');
    t = t.replace(/ì—†ìŠµë‹ˆë‹¤/g, 'ì—†ëŠë‹ˆë¼');
    t = t.replace(/ë©ë‹ˆë‹¤/g, 'ë˜ëŠë‹ˆë¼');
    // ë‚¨ì€ í™‘ë”°ì˜´í‘œ/ìŒë”°ì˜´í‘œ í•œë²ˆ ë”
    t = t.replace(/[\u0022\u0027\u201C\u201D\u2018\u2019\u0060\u00AB\u00BB]/g, '');
    // AI íŠ¹ìœ  ì´ëª¨ì§€ ì œê±° (ë¬¸ì¥ ë‚´ í¬í•¨)
    t = t.replace(/[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{FE00}-\u{FE0F}]/gu, '');
    // ë¹ˆ ê´„í˜¸ ì •ë¦¬
    t = t.replace(/\(\s*\)/g, '');
    // ì—°ì† ë¹ˆì¤„ ì •ë¦¬
    t = t.replace(/\n{3,}/g, '\n\n');
    // ë¹ˆ ì¤„ë§Œ ë‚¨ì€ ë¬¸ë‹¨ ì œê±°
    t = t.replace(/^\s*\n/gm, '\n');
    t = t.replace(/\n{3,}/g, '\n\n');
    return t.trim();
  }

  // ã€ã€‘ë¥¼ React ì—˜ë¦¬ë¨¼íŠ¸ë¡œ ë³€í™˜í•˜ëŠ” ë Œë”ëŸ¬
  function renderBoldText(text) {
    if (!text) return null;
    var parts = text.split(/ã€|ã€‘/);
    return parts.map(function(part, i) {
      // í™€ìˆ˜ ì¸ë±ìŠ¤ = ã€ã€‘ ì•ˆì˜ ë‚´ìš© = bold
      if (i % 2 === 1) {
        return React.createElement('b', { key: i, style: { color: '#d0b0ff', fontWeight: 700 } }, part);
      }
      return part;
    });
  }

  // AI í…ìŠ¤íŠ¸ë¥¼ ëŒ€í™” ë§í’ì„  ë°°ì—´ë¡œ ë³€í™˜
  function makeBubbles(rawText, title) {
    if (!rawText) return [];
    var rawParts = rawText.split(/\n\n+/).filter(function(s) { return s.trim(); });
    var parts = [];
    for (var i = 0; i < rawParts.length; i++) {
      var p = rawParts[i].trim();
      if (p.length < 20 && parts.length > 0) {
        parts[parts.length - 1] += '\n' + p;
      } else {
        parts.push(p);
      }
    }

    var bubbles = [];
    bubbles.push({ who: 'bari', text: 'ì... ' + title + 'ì— ëŒ€í•´ í’€ì–´ë³´ë§ˆ.' });
    for (var j = 0; j < parts.length; j++) {
      bubbles.push({ who: 'bari', text: parts[j] });
    }
    bubbles.push({ who: 'bari', text: 'ì´ê²ƒì´ ê³ ì„œì˜ ì´ì¹˜ë¡œ ë³¸ í’€ì´ë‹ˆë¼.\nì²œê¸°ë€ ë°”ë€ŒëŠ” ê²ƒì´ë‹ˆ, ëŒ€ìš´ê³¼ ì„¸ìš´ì˜ íë¦„ë„ í•¨ê»˜ ì‚´í”¼ê±°ë¼.' });
    return bubbles;
  }

  // ë£°ì—”ì§„ linesë¥¼ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ (AI í”„ë¡¬í”„íŠ¸ìš©)
  const linesToText=function(lines){
    if(!lines)return'';
    return lines.map(function(l){
      if(l.type==='h3')return '\nâ—‰ '+l.text;
      if(l.type==='h4')return '\nâ˜… '+l.text;
      if(l.tag)return '['+l.tag+']';
      if(l.type==='subheader')return '\nâ— '+l.text;
      return (l.t||l.text||'');
    }).filter(Boolean).join('\n');
  };

  // AI ì‹¬ì¸µí•´ì„¤ í˜ì´ì§€ ì—´ê¸°
  var openAiDetail = function(key, title, ruleText) {
    setAiDetailKey(key);
    setAiDetailTitle(title);
    setAiDetailRule(ruleText);
    setAiError('');
    enrichWithAI(key, ruleText);
    setPhase('aiDetail');
  };

  var retryAiDetail = function() {
    if(aiDetailKey && aiDetailRule) {
      // ìºì‹œì—ì„œ ì œê±°í•´ì„œ ë‹¤ì‹œ í˜¸ì¶œ ê°€ëŠ¥í•˜ê²Œ
      setAiCache(function(prev) { var next = Object.assign({}, prev); delete next[aiDetailKey]; return next; });
      setAiError('');
      enrichWithAI(aiDetailKey, aiDetailRule);
    }
  };

  // ì±„íŒ… ì „ì†¡
  function doSend(){
    if(!chatInput.trim()||!chatTarget)return;
    var key=chatTarget.id;
    var prev=chatMsgs[key]||[];
    var now=new Date();var t=String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
    var newList=prev.concat([{from:'me',text:chatInput,time:t}]);
    var next=Object.assign({},chatMsgs);next[key]=newList;setChatMsgs(next);setChatInput('');
    var ct=chatTarget;
    setTimeout(function(){
      var replies=['ë°˜ê°€ì›Œìš”!','ì˜¤ ì‚¬ì£¼ ê¶í•©ì´ ì¢‹ë‹¤ë‹ˆ ì‹ ê¸°í•˜ë„¤ìš”','ì €ë„ ê´€ì‹¬ ìˆì–´ìš”!','ì¬ë°Œë„¤ìš” ã…ã…','ì¹´í˜ í•œë²ˆ ê°ˆê¹Œìš”?','ì¢‹ì•„ìš”~','ë„¤ ì—°ë½í•´ìš”!','ì²œê°„í•©ì´ë¼ë‹ˆ ìš´ëª…ì¸ê°€ë´ìš”'];
      var reply=replies[Math.floor(Math.random()*replies.length)];
      var now2=new Date();var t2=String(now2.getHours()).padStart(2,'0')+':'+String(now2.getMinutes()).padStart(2,'0');
      var newList2=newList.concat([{from:ct.id,text:reply,time:t2}]);
      var next2=Object.assign({},chatMsgs);next2[key]=newList2;setChatMsgs(next2);
    },800+Math.random()*2000);
  }

  const doAnalyze=()=>{
    setLoadStep(0);
    setPhase('loading');
    setTimeout(()=>{
      const s=birthToSaju(form.year,form.month,form.day,form.hour,form.gender,form.city);
      const a=analyze(s);
      setResult({...a,birthYear:form.year,birthMonth:form.month,birthDay:form.day});
      setPhase('result');
    },6500);
  };

  const unlockPremium=()=>{
    if(!result)return;
    const p=genPremium(result,result.birthYear);
    setPremium(p);
  };

  // INTRO
  if(phase==='intro')return(
    <div style={{minHeight:'100vh',background:'radial-gradient(ellipse at 50% 15%,#221c14 0%,#14110c 65%)',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',color:'#e8d5a8',fontFamily:"'Noto Sans KR',sans-serif",padding:20,overflow:'hidden',position:'relative'}}>
      {/* ë°°ê²½ íŒŒí‹°í´ */}
      <div style={{position:'absolute',top:0,left:0,right:0,bottom:0,pointerEvents:'none'}}>
        <div style={{position:'absolute',top:'15%',left:'20%',width:4,height:4,borderRadius:2,background:'rgba(180,140,80,0.2)',animation:'float1 5s ease infinite'}}/>
        <div style={{position:'absolute',top:'40%',right:'15%',width:3,height:3,borderRadius:2,background:'rgba(180,140,80,0.15)',animation:'float2 4s ease infinite'}}/>
        <div style={{position:'absolute',bottom:'20%',left:'30%',width:5,height:5,borderRadius:3,background:'rgba(180,140,80,0.1)',animation:'float1 6s ease infinite'}}/>
      </div>

      <div style={{fontSize:10,letterSpacing:6,color:'#5a5040',marginBottom:20,opacity:introStep>=0?1:0,transition:'opacity 0.6s'}}>ê³ ì–‘ì´ ì‚¬ì£¼ ëª…ë‹¹</div>

      {/* Step 0: ê³ ì–‘ì´ ìŠ¥ ì˜¬ë¼ì˜´ */}
      <div style={{opacity:introStep>=1?1:0,transform:introStep>=1?'translateY(0) scale(1)':'translateY(60px) scale(0.7)',transition:'opacity 0.8s cubic-bezier(0.34,1.56,0.64,1),transform 0.8s cubic-bezier(0.34,1.56,0.64,1)'}}>
        <CatFace size={140}/>
      </div>

      {/* Step 1: ì²« ë§ˆë”” */}
      {introStep>=2&&(
        <div style={{animation:'fadeUp 0.5s ease',marginTop:20,textAlign:'center'}}>
          <div style={{background:'rgba(180,140,80,0.06)',border:'1px solid rgba(180,140,80,0.12)',borderRadius:14,padding:'12px 20px',display:'inline-block',position:'relative'}}>
            <div style={{position:'absolute',top:-7,left:'50%',marginLeft:-7,width:0,height:0,borderLeft:'7px solid transparent',borderRight:'7px solid transparent',borderBottom:'7px solid rgba(180,140,80,0.12)'}}/>
            <p style={{fontSize:14,color:'#c0b8a0',lineHeight:1.9,margin:0}}>ì–´? ì†ë‹˜ì´ë„¤?</p>
          </div>
        </div>
      )}

      {/* Step 2: ì¶”ê°€ ëŒ€ì‚¬ */}
      {introStep>=3&&(
        <div style={{animation:'fadeUp 0.5s ease',marginTop:12,textAlign:'center'}}>
          <div style={{background:'rgba(180,140,80,0.06)',border:'1px solid rgba(180,140,80,0.12)',borderRadius:14,padding:'12px 20px',display:'inline-block'}}>
            <p style={{fontSize:14,color:'#c0b8a0',lineHeight:1.9,margin:0}}>ìë„¤ ì–¼êµ´ì— ìš´ê¸°ê°€ ì¢€ ê¼¬ì—¬ìˆêµ°.<br/>ìƒë…„ì›”ì¼ì‹œë¥¼ ì•Œë ¤ì£¼ë©´ ì‚¬ì£¼ë¥¼ ë´ì¤„ê²Œ.</p>
          </div>
        </div>
      )}

      {/* Step 3: ë²„íŠ¼ */}
      {introStep>=4&&(
        <div style={{animation:'fadeUp 0.6s ease',marginTop:20}}>
          <button onClick={function(){setPhase('form');}} style={{background:'linear-gradient(135deg,#b48c50,#8a6830)',border:'none',borderRadius:22,padding:'13px 36px',fontSize:15,fontWeight:700,color:'#14110c',cursor:'pointer',boxShadow:'0 4px 16px rgba(180,140,80,0.3)'}}>ì‚¬ì£¼ ë´ì¤˜</button>
        </div>
      )}

      <style>{'svg{border:none!important;outline:none!important;box-shadow:none!important}@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}@keyframes float1{0%,100%{transform:translateY(0)}50%{transform:translateY(-20px)}}@keyframes float2{0%,100%{transform:translateY(0) translateX(0)}50%{transform:translateY(-15px) translateX(8px)}}'}</style>
    </div>
  );

  // FORM
  if(phase==='form'){
    const ì‹œì§„ëª…=h=>{if(h<0)return'ëª¨ë¦„';const n=['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];return n[Math.floor(((h+1)%24)/2)];};
    const cityLabel=CITIES.find(c=>c.v===form.city);
    return(
    <div style={{minHeight:'100vh',background:'radial-gradient(ellipse at 50% 15%,#221c14 0%,#14110c 65%)',color:'#e8d5a8',fontFamily:"'Noto Sans KR',sans-serif",padding:'40px 20px'}}>
      <div style={{textAlign:'center',marginBottom:16}}><CatFace size={70}/><p style={{fontSize:13,color:'#b48c50',marginTop:8}}>ìƒë…„ì›”ì¼ì‹œë¥¼ ì•Œë ¤ì¤˜.</p></div>
      <div style={{textAlign:'center',marginBottom:16,padding:'12px 16px',background:'rgba(180,140,80,0.06)',border:'1px solid rgba(180,140,80,0.15)',borderRadius:10}}>
        <span style={{fontSize:20,fontWeight:800,color:'#e8d5a8',letterSpacing:1,textShadow:'0 0 12px rgba(180,140,80,0.3)'}}>{form.year}ë…„ {form.month}ì›” {form.day}ì¼ {form.hour>=0?`${form.hour}ì‹œ(${ì‹œì§„ëª…(form.hour)})`:'ëª¨ë¦„'}</span>
        <div style={{fontSize:11,color:'#b48c50',marginTop:4}}>{form.gender==='ë‚¨'?'ğŸ‘¨ ë‚¨ì':'ğŸ‘© ì—¬ì'} Â· {cityLabel?cityLabel.l.split(' ')[0]:'ì„œìš¸'}</div>
      </div>
      <div style={{display:'flex',gap:4,marginBottom:16}}>
        {['ë‚¨','ì—¬'].map(g=>(<button key={g} onClick={()=>setForm({...form,gender:g})} style={{flex:1,padding:'10px',borderRadius:8,border:`1px solid ${form.gender===g?'#b48c50':'rgba(180,140,80,0.1)'}`,background:form.gender===g?'rgba(180,140,80,0.08)':'#1a1510',color:form.gender===g?'#e8d5a8':'#5a5040',fontWeight:600,fontSize:14,cursor:'pointer'}}>{g==='ë‚¨'?'ğŸ‘¨ ë‚¨':'ğŸ‘© ì—¬'}</button>))}
      </div>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,marginBottom:8}}>
        {[{l:'ì—°ë„',items:YEARS,k:'year'},{l:'ì›”',items:MONTHS,k:'month'},{l:'ì¼',items:DAYS,k:'day'},{l:'íƒœì–´ë‚œ ì‹œ',items:HOURS,k:'hour'}].map(({l,items,k})=>(
          <div key={k} style={{background:'#1a1510',borderRadius:8,padding:8,border:'1px solid rgba(180,140,80,0.06)'}}>
            <div style={{fontSize:10,color:'#b48c50',textAlign:'center',marginBottom:4,fontWeight:600}}>{l}</div>
            <Picker items={items} value={form[k]} onChange={v=>setForm({...form,[k]:v})}/>
          </div>
        ))}
      </div>
      <div style={{background:'#1a1510',borderRadius:8,padding:8,border:'1px solid rgba(180,140,80,0.06)',marginBottom:16}}>
        <div style={{fontSize:10,color:'#b48c50',textAlign:'center',marginBottom:4,fontWeight:600}}>íƒœì–´ë‚œ ì§€ì—­ (ì‹œê°„ ë³´ì •)</div>
        <Picker items={CITIES} value={form.city} onChange={v=>setForm({...form,city:v})}/>
      </div>
      <button onClick={doAnalyze} style={{width:'100%',background:'linear-gradient(135deg,#b48c50,#8a6830)',border:'none',borderRadius:10,padding:'14px',fontSize:15,fontWeight:700,color:'#14110c',cursor:'pointer'}}>ì‚¬ì£¼ í’€ì–´ì¤˜ ğŸ”®</button>
    </div>);
  }

  // LOADING
  if(phase==='loading')return(
    <div style={{minHeight:'100vh',background:'radial-gradient(ellipse at 50% 15%,#221c14 0%,#14110c 65%)',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',color:'#e8d5a8',fontFamily:"'Noto Sans KR',sans-serif",padding:'24px 20px',overflow:'hidden',position:'relative'}}>
      {/* ë°°ê²½ íŒŒí‹°í´ */}
      <div style={{position:'absolute',top:0,left:0,right:0,bottom:0,pointerEvents:'none'}}>
        <div style={{position:'absolute',top:'10%',left:'15%',width:4,height:4,borderRadius:2,background:'rgba(180,140,80,0.2)',animation:'float1 4s ease infinite'}}/>
        <div style={{position:'absolute',top:'50%',right:'20%',width:3,height:3,borderRadius:2,background:'rgba(180,140,80,0.15)',animation:'float2 5s ease infinite'}}/>
      </div>

      {/* ê³ ì–‘ì´ */}
      <div style={{opacity:loadStep>=0?1:0,transform:loadStep>=0?'translateY(0) scale(1)':'translateY(40px) scale(0.7)',transition:'opacity 0.7s cubic-bezier(0.34,1.56,0.64,1),transform 0.7s cubic-bezier(0.34,1.56,0.64,1)',marginBottom:16}}>
        <CatFace size={100}/>
      </div>

      {/* ëŒ€ì‚¬ 1 */}
      {loadStep>=1&&(
        <div style={{animation:'fadeUp 0.5s ease',textAlign:'center',marginBottom:12,maxWidth:300}}>
          <div style={{background:'rgba(180,140,80,0.06)',border:'1px solid rgba(180,140,80,0.12)',borderRadius:14,padding:'12px 18px',position:'relative'}}>
            <div style={{position:'absolute',top:-7,left:'50%',marginLeft:-7,width:0,height:0,borderLeft:'7px solid transparent',borderRight:'7px solid transparent',borderBottom:'7px solid rgba(180,140,80,0.12)'}}/>
            <p style={{fontSize:13,lineHeight:1.8,color:'#c0b8a0',margin:0}}>
              {form.year}ë…„ {form.month}ì›” {form.day}ì¼ìƒ...<br/>
              ì–´ë”” í•œë²ˆ ì‚´í´ë³¼ê¹Œ.
            </p>
          </div>
        </div>
      )}

      {/* ëŒ€ì‚¬ 2 */}
      {loadStep>=2&&(
        <div style={{animation:'fadeUp 0.5s ease',textAlign:'center',marginBottom:12,maxWidth:300}}>
          <div style={{background:'rgba(180,140,80,0.06)',border:'1px solid rgba(180,140,80,0.12)',borderRadius:14,padding:'12px 18px'}}>
            <p style={{fontSize:13,lineHeight:1.8,color:'#c0b8a0',margin:0}}>
              ì²œê°„ê³¼ ì§€ì§€ë¥¼ í¼ì¹˜ê³ ...<br/>
              ì˜¤í–‰ì˜ íë¦„ì„ ì½ëŠ” ì¤‘ì´ì•¼.
            </p>
          </div>
        </div>
      )}

      {/* ëŒ€ì‚¬ 3 + ë¡œë”© */}
      {loadStep>=3&&(
        <div style={{animation:'fadeUp 0.5s ease',textAlign:'center',maxWidth:300}}>
          <div style={{background:'rgba(180,140,80,0.06)',border:'1px solid rgba(180,140,80,0.12)',borderRadius:14,padding:'12px 18px'}}>
            <p style={{fontSize:13,lineHeight:1.8,color:'#c0b8a0',margin:0}}>
              ì˜¤! ê½¤ ì¬ë¯¸ìˆëŠ” ì‚¬ì£¼ì¸ê±¸?<br/>
              ê³§ ë³´ì—¬ì¤„ê²Œ, ì ê¹ë§Œ...
            </p>
          </div>
          <div style={{marginTop:16}}>
            <div style={{width:120,height:3,background:'rgba(180,140,80,0.1)',borderRadius:2,margin:'0 auto',overflow:'hidden'}}>
              <div style={{width:'100%',height:'100%',background:'linear-gradient(90deg,#b48c50,#e8d5a8)',animation:'loadBar 1.5s ease infinite'}}/>
            </div>
          </div>
        </div>
      )}

      <style>{'@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}@keyframes float1{0%,100%{transform:translateY(0)}50%{transform:translateY(-20px)}}@keyframes float2{0%,100%{transform:translateY(0) translateX(0)}50%{transform:translateY(-15px) translateX(8px)}}@keyframes loadBar{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}'}</style>
    </div>
  );

  // RESULT
  if(phase==='result'&&result)return(
    <div style={{minHeight:'100vh',background:'radial-gradient(ellipse at 50% 15%,#221c14 0%,#14110c 65%)',color:'#e8d5a8',fontFamily:"'Noto Sans KR',sans-serif",padding:'20px 16px 60px',maxWidth:440,margin:'0 auto'}}>
      
      <div style={{textAlign:'center',marginBottom:8}}>
        <CatFace size={60}/>
        <h2 style={{fontSize:16,fontWeight:700,fontFamily:"'Noto Serif KR',serif",margin:'4px 0'}}>{result.ì¼ê°„}{result.ì¼ì§€} ì¼ì£¼ Â· {result.ê²©êµ­}</h2>
        <p style={{fontSize:11,color:'#5a5040'}}>{result.ê°•ì•½} Â· ìš©ì‹  {result.ìš©ì‹ } Â· {result.saju.gender}</p>
      </div>

      <SajuTable saju={result.saju} ì¼ê°„={result.ì¼ê°„}/>
      <OhBar ì¹´ìš´íŠ¸={result.ì˜¤í–‰.ì¹´ìš´íŠ¸}/>
      {result.ì˜¤í–‰.ì „ë¬´.length>0&&<div style={{fontSize:10,color:'#c44040',textAlign:'center'}}>âš  ì „ë¬´: {result.ì˜¤í–‰.ì „ë¬´.join(', ')}</div>}

      <SectionHeader title="ê°œì¸ì„±í–¥ ìš”ì•½" icon="ğŸ§¬" note="ëŒ€ìš´Â·ë…„ìš´ì— ë”°ë¼ ë³€í™”í•´"/>
      <div style={{background:'#1a1510',borderRadius:8,padding:'10px 12px',marginBottom:6,border:'1px solid rgba(180,140,80,0.06)'}}>
        <div style={{fontSize:12,fontWeight:600,color:'#e8d5a8',marginBottom:6}}>â— ì„±ê²© ì›ë§Œì„±</div>
        <DualBar score={result.ì„±ê²©.ì ìˆ˜}/><FeatureList items={result.ì„±ê²©.íŠ¹ì§•} type="info"/>
      </div>
      <div style={{background:'#1a1510',borderRadius:8,padding:'10px 12px',marginBottom:6,border:'1px solid rgba(180,140,80,0.06)'}}>
        <div style={{fontSize:12,fontWeight:600,color:'#e8d5a8',marginBottom:6}}>â— ì²´ë ¥ê³¼ ê±´ê°•</div>
        <DualBar score={result.ê±´ê°•.ì ìˆ˜}/>{result.ê±´ê°•.ê²½ê³ .length>0?<FeatureList items={result.ê±´ê°•.ê²½ê³ } type="warn"/>:<FeatureList items={['ì „ë°˜ì ìœ¼ë¡œ ì–‘í˜¸í•œ ê±´ê°•ìš´ì´ì•¼']} type="good"/>}
      </div>

      <SectionHeader title="ê°€ì¡±ê´€ê³„ ìš”ì•½" icon="ğŸ‘ª" note="ëŒ€ìš´Â·ë…„ìš´ì— ë”°ë¼ ë³€í™”í•´"/>
      <RelationCard name="ì•„ë²„ì§€" ì¸ì—°={result.ê°€ì¡±.ì•„ë²„ì§€.ì¸ì—°} ë³µë•={result.ê°€ì¡±.ì•„ë²„ì§€.ë³µë•}/>
      <RelationCard name="ì–´ë¨¸ë‹ˆ" ì¸ì—°={result.ê°€ì¡±.ì–´ë¨¸ë‹ˆ.ì¸ì—°} ë³µë•={result.ê°€ì¡±.ì–´ë¨¸ë‹ˆ.ë³µë•}/>
      <RelationCard name="ë°°ìš°ì" ì¸ì—°={result.ê°€ì¡±.ë°°ìš°ì.ì¸ì—°} ë³µë•={result.ê°€ì¡±.ë°°ìš°ì.ë³µë•}/>
      <RelationCard name="ìì‹" ì¸ì—°={result.ê°€ì¡±.ìì‹.ì¸ì—°} ë³µë•={result.ê°€ì¡±.ìì‹.ë³µë•}/>

      <SectionHeader title="ì‚¬íšŒìƒí™œ ìš”ì•½" icon="ğŸ’¼" note="ëŒ€ìš´Â·ë…„ìš´ì— ë”°ë¼ ë³€í™”í•´"/>
      {[{n:'ì¬ë¬¼ê³¼ ì‚¬ì—…',d:result.ì‚¬íšŒ.ì¬ë¬¼},{n:'ì§ì¥ê³¼ ëª…ì˜ˆ',d:result.ì‚¬íšŒ.ì§ì¥},{n:'ì¸ê²©ê³¼ í•™ë¬¸',d:result.ì‚¬íšŒ.í•™ë¬¸}].map(({n,d})=>(
        <div key={n} style={{background:'#1a1510',borderRadius:8,padding:'10px 12px',marginBottom:6,border:'1px solid rgba(180,140,80,0.06)'}}>
          <div style={{fontSize:12,fontWeight:600,color:'#e8d5a8',marginBottom:6}}>â— {n}</div>
          <DualBar score={d.ì ìˆ˜}/><FeatureList items={d.íŠ¹ì§•} type="info"/>
        </div>
      ))}

      {result.íŠ¹ì´.length>0&&(<><SectionHeader title="íŠ¹ì´ ì‚¬í•­" icon="âš¡"/><div style={{background:'#1a1510',borderRadius:8,padding:'10px 12px',border:'1px solid rgba(180,140,80,0.06)'}}><FeatureList items={result.íŠ¹ì´} type="warn"/></div></>)}


      {/* ===== ìœ ë£Œ ì˜ì—­ ì§„ì… ===== */}
      <div style={{marginTop:28,background:'linear-gradient(145deg,#1a1028,#0e0a18)',border:'1px solid rgba(160,120,200,0.2)',borderRadius:14,padding:'24px 16px',textAlign:'center'}}>
        <CatFace size={50}/>
        <p style={{fontSize:12,color:'#c0b8a0',lineHeight:1.8,margin:'8px 0 12px'}}>
          ì—¬ê¸°ê¹Œì§€ê°€ ë‚´ ì‹¤ë ¥ì´ì•¼...<br/>ë” ê¹Šì€ ê±´ ë‚´ ìŠ¤ìŠ¹ë‹˜ì´ ì§ì ‘ ë´ì£¼ì‹¤ ê±°ì•¼.
        </p>
        <button onClick={function(){setTransStep(0);setPhase('transition');}} style={{width:'100%',background:'linear-gradient(135deg,#8060c0,#5030a0)',border:'none',borderRadius:8,padding:'14px',fontSize:14,fontWeight:700,color:'#fff',cursor:'pointer',boxShadow:'0 4px 16px rgba(100,60,180,0.3)'}}>
          ìŠ¤ìŠ¹ë‹˜ ë§Œë‚˜ëŸ¬ ê°€ê¸° ğŸ”®
        </button>
        <p style={{fontSize:9,color:'#4a3a60',marginTop:8}}>* ë°ëª¨: ê²°ì œ ì—†ì´ ì²´í—˜</p>
      </div>

      <button onClick={function(){setPhase('form');setResult(null);setPremium(null);setAiCache({});}} style={{width:'100%',marginTop:16,background:'transparent',border:'1px solid rgba(180,140,80,0.1)',borderRadius:8,padding:'10px',fontSize:12,color:'#5a5040',cursor:'pointer'}}>ë‹¤ë¥¸ ì‚¬ì£¼ ë³´ê¸°</button>

      <style>{`@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}div::-webkit-scrollbar{width:0;height:0;display:none;}`}</style>
    </div>
  );


  // ============================================================
  // ë°”ë¦¬ë§Œì‹  ì‹¬ì¸µ í•´ì„ â€” í’€í˜ì´ì§€ (phase='premium')
  // ============================================================
  if(phase==='premium'&&premium&&result)return(
    <div style={{minHeight:'100vh',background:'radial-gradient(ellipse at 50% 10%,#1a1028,#0a0610)',color:'#e8d5ff',fontFamily:"'Noto Sans KR',sans-serif",padding:'20px 16px 60px',maxWidth:440,margin:'0 auto'}}>
      {/* í—¤ë” */}
      <div style={{textAlign:'center',marginBottom:20}}>
        <BariMansin size={70}/>
        <h2 style={{fontSize:18,fontWeight:800,fontFamily:"'Noto Serif KR',serif",margin:'8px 0 2px',background:'linear-gradient(135deg,#d0b0ff,#8060c0)',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent'}}>ë°”ë¦¬ë§Œì‹ ì˜ ì‹¬ì¸µ í•´ì„</h2>
        <p style={{fontSize:11,color:'#6050a0',margin:0}}>{result.ì¼ê°„}{result.ì¼ì§€}ì¼ì£¼ Â· {result.ê²©êµ­} Â· {result.ê°•ì•½}</p>
      </div>

      {/* 4íƒ­ */}
      <div style={{display:'flex',gap:3,marginBottom:16,position:'sticky',top:0,zIndex:10,background:'#0a0610',padding:'8px 0'}}>
        {['ê°œì¸íŠ¹ì„±','ê°€ì¡±ê´€ê³„','ì‚¬íšŒìƒí™œ','ìš´ì„¸íë¦„'].map(function(tab){return(
          <button key={tab} onClick={function(){setPaidTab(tab);}} style={{flex:1,padding:'9px 2px',borderRadius:8,border:paidTab===tab?'1.5px solid rgba(160,120,200,0.5)':'1px solid rgba(160,120,200,0.1)',background:paidTab===tab?'linear-gradient(135deg,rgba(160,120,200,0.15),rgba(100,60,180,0.08))':'transparent',color:paidTab===tab?'#d0b0ff':'#6050a0',fontSize:11,fontWeight:paidTab===tab?700:400,cursor:'pointer',transition:'all 0.2s'}}>{tab}</button>
        );})}
      </div>

      {/* â”â”â” íƒ­1: ê°œì¸íŠ¹ì„± â”â”â” */}
      {paidTab==='ê°œì¸íŠ¹ì„±'&&premium.ê°œì¸íŠ¹ì„±.map(function(cat,i){return(
        <div key={i} style={{marginBottom:16,background:'rgba(160,120,200,0.04)',border:'1px solid rgba(160,120,200,0.08)',borderRadius:10,padding:'14px 12px',animation:'fadeUp 0.4s ease'}}>
          <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
            <span style={{fontSize:18}}>{cat.icon}</span>
            <span style={{fontWeight:700,fontSize:14,color:'#d0b0ff'}}>{cat.title}</span>
          </div>
          <ScoreBar score={cat.score} label={cat.title+' ì ìˆ˜'}/>
          <div style={{marginTop:8}}>
            {cat.lines.map(function(l,j){
              if(l.type==='h3')return <div key={j} style={{fontSize:13,fontWeight:700,color:'#e8d5ff',margin:'10px 0 4px',borderBottom:'1px solid rgba(160,120,200,0.1)',paddingBottom:4}}>{l.text}</div>;
              if(l.type==='h4')return <div key={j} style={{fontSize:11,fontWeight:600,color:'#a090c0',margin:'8px 0 3px'}}>{'â˜… '+l.text}</div>;
              if(l.tag)return <Tag key={j} text={l.tag} color={l.c}/>;
              return <div key={j} style={{fontSize:11,lineHeight:1.8,color:l.w?'#e0a060':'#b0a8c0',margin:'2px 0',paddingLeft:8}}>{toMansin(l.t)}</div>;
            })}
          </div>
          {aiCache[cat.title]&&<div style={{fontSize:10,color:"#8060c0",marginTop:6,fontStyle:"italic"}}>âœ“ í•´ì„¤ ì™„ë£Œ</div>}
          <button onClick={function(){openAiDetail(cat.title,cat.title,linesToText(cat.lines));}} style={{marginTop:8,background:"rgba(130,100,200,0.08)",border:"1px solid rgba(160,120,200,0.15)",borderRadius:6,padding:"8px 14px",fontSize:11,color:"#8070a0",cursor:"pointer",display:"block",width:"100%"}}>{aiCache[cat.title]?"ğŸ”® í•´ì„¤ ë‹¤ì‹œ ë³´ê¸°":"ğŸ”® ë°”ë¦¬ë§Œì‹  ì‹¬ì¸µ í•´ì„¤"}</button>
        </div>
      );})}

      {/* â”â”â” íƒ­2: ê°€ì¡±ê´€ê³„ â”â”â” */}
      {paidTab==='ê°€ì¡±ê´€ê³„'&&premium.ê°€ì¡±ê´€ê³„.map(function(cat,i){return(
        <div key={i} style={{marginBottom:16,background:'rgba(160,120,200,0.04)',border:'1px solid rgba(160,120,200,0.08)',borderRadius:10,padding:'14px 12px',animation:'fadeUp 0.4s ease'}}>
          <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
            <span style={{fontSize:18}}>{cat.icon}</span>
            <span style={{fontWeight:700,fontSize:14,color:'#d0b0ff'}}>{cat.title}</span>
          </div>
          <ScoreBar score={cat.score} label={cat.title+' ì ìˆ˜'}/>
          <div style={{marginTop:8}}>
            {cat.lines.map(function(l,j){
              if(l.type==='h3')return <div key={j} style={{fontSize:13,fontWeight:700,color:'#e8d5ff',margin:'10px 0 4px',borderBottom:'1px solid rgba(160,120,200,0.1)',paddingBottom:4}}>{l.text}</div>;
              if(l.type==='h4')return <div key={j} style={{fontSize:11,fontWeight:600,color:'#a090c0',margin:'8px 0 3px'}}>{'â˜… '+l.text}</div>;
              if(l.tag)return <Tag key={j} text={l.tag} color={l.c}/>;
              return <div key={j} style={{fontSize:11,lineHeight:1.8,color:l.w?'#e0a060':'#b0a8c0',margin:'2px 0',paddingLeft:8}}>{toMansin(l.t)}</div>;
            })}
          </div>
          {aiCache[cat.title]&&<div style={{fontSize:10,color:"#8060c0",marginTop:6,fontStyle:"italic"}}>âœ“ í•´ì„¤ ì™„ë£Œ</div>}
          <button onClick={function(){openAiDetail(cat.title,cat.title,linesToText(cat.lines));}} style={{marginTop:8,background:"rgba(130,100,200,0.08)",border:"1px solid rgba(160,120,200,0.15)",borderRadius:6,padding:"8px 14px",fontSize:11,color:"#8070a0",cursor:"pointer",display:"block",width:"100%"}}>{aiCache[cat.title]?"ğŸ”® í•´ì„¤ ë‹¤ì‹œ ë³´ê¸°":"ğŸ”® ë°”ë¦¬ë§Œì‹  ì‹¬ì¸µ í•´ì„¤"}</button>
        </div>
      );})}

      {/* â”â”â” íƒ­3: ì‚¬íšŒìƒí™œ â”â”â” */}
      {paidTab==='ì‚¬íšŒìƒí™œ'&&(
        <div style={{animation:'fadeUp 0.4s ease'}}>
          {/* ì¬ë¬¼ ìƒì„¸ */}
          <div style={{marginBottom:16,background:'rgba(160,120,200,0.04)',border:'1px solid rgba(160,120,200,0.08)',borderRadius:10,padding:'14px 12px'}}>
            <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:10}}><span style={{fontSize:18}}>ğŸ’°</span><span style={{fontWeight:700,fontSize:14,color:'#d0b0ff'}}>ì¬ë¬¼Â·ì‚¬ì—…ìš´ ì¢…í•©</span></div>
            {['ì •ì¬','í¸ì¬','ì„ ì²œ'].map(function(key){var d=premium.ì¬ë¬¼[key];return(
              <div key={key} style={{marginBottom:10,background:'rgba(160,120,200,0.04)',borderRadius:8,padding:'10px'}}>
                <div style={{fontWeight:700,fontSize:12,color:'#c0a0e0',marginBottom:4}}>{key==='ì •ì¬'?'ğŸ’µ ì •ì¬ (ì•ˆì • ì†Œë“)':key==='í¸ì¬'?'ğŸ’ í¸ì¬ (íˆ¬ìÂ·ì‚¬ì—…)':'ğŸ“Š ì„ ì²œ ì¬ë¬¼ë³µ ì¢…í•©'}</div>
                <ScoreBar score={d.score} label={key+' ì ìˆ˜'}/>
                {d.lines.map(function(l,j){
                  if(l.type==='h3')return <div key={j} style={{fontSize:13,fontWeight:700,color:'#e8d5ff',margin:'8px 0 4px'}}>{l.text}</div>;
                  if(l.type==='h4')return <div key={j} style={{fontSize:11,fontWeight:600,color:'#a090c0',margin:'6px 0 2px'}}>{'â˜… '+l.text}</div>;
                  if(l.tag)return <Tag key={j} text={l.tag} color={l.c}/>;
                  return <div key={j} style={{fontSize:11,lineHeight:1.8,color:l.w?'#e0a060':'#b0a8c0',margin:'2px 0',paddingLeft:8}}>{toMansin(l.t)}</div>;
                })}
              </div>
            );})}
            <div style={{marginTop:8}}><div style={{fontWeight:700,fontSize:12,color:'#c0a0e0',marginBottom:8}}>ğŸ“ˆ ëŒ€ìš´ë³„ ì¬ë¬¼ íë¦„</div>
              {premium.ì¬ë¬¼.ëŒ€ìš´.map(function(d,i){return(
                <div key={i} style={{marginBottom:8,background:'rgba(160,120,200,0.04)',borderRadius:6,padding:'8px'}}>
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:4}}>
                    <span style={{fontSize:11,fontWeight:700,color:'#d0b0ff'}}>{d.ê°„ì§€}ìš´ ({d.ì‹œì‘}~{d.ë}ì„¸)</span>
                    <span style={{fontSize:10,color:'#8a7e9d'}}>{d.yr}ë…„~</span>
                  </div>
                  <ScoreBar score={d.sc}/>
                  {d.tags.map(function(t,j){return <Tag key={j} text={t.t} color={t.c}/>;})}{d.ev.map(function(e,j){return <div key={j} style={{fontSize:10,lineHeight:1.6,color:'#a098b0'}}>{e}</div>;})}
                </div>
              );})}
            </div>
            {aiCache["ì¬ë¬¼"]&&<div style={{fontSize:10,color:"#8060c0",marginTop:6,fontStyle:"italic"}}>âœ“ í•´ì„¤ ì™„ë£Œ</div>}
            <button onClick={function(){openAiDetail("ì¬ë¬¼","ì¬ë¬¼Â·ì‚¬ì—…ìš´",linesToText(premium.ì¬ë¬¼.ì •ì¬.lines)+"\n"+linesToText(premium.ì¬ë¬¼.í¸ì¬.lines)+"\n"+linesToText(premium.ì¬ë¬¼.ì„ ì²œ.lines));}} style={{marginTop:8,background:"rgba(130,100,200,0.08)",border:"1px solid rgba(160,120,200,0.15)",borderRadius:6,padding:"8px 14px",fontSize:11,color:"#8070a0",cursor:"pointer",display:"block",width:"100%"}}>{aiCache["ì¬ë¬¼"]?"ğŸ”® í•´ì„¤ ë‹¤ì‹œ ë³´ê¸°":"ğŸ”® ë°”ë¦¬ë§Œì‹  ì¬ë¬¼ìš´ ì‹¬ì¸µ í•´ì„¤"}</button>
          </div>
          {/* ì§ì¥/í•™ë¬¸/ì ì„± */}
          {premium.ì‚¬íšŒìƒí™œ.map(function(cat,i){return(
            <div key={i} style={{marginBottom:16,background:'rgba(160,120,200,0.04)',border:'1px solid rgba(160,120,200,0.08)',borderRadius:10,padding:'14px 12px'}}>
              <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}><span style={{fontSize:18}}>{cat.icon}</span><span style={{fontWeight:700,fontSize:14,color:'#d0b0ff'}}>{cat.title}</span></div>
              <ScoreBar score={cat.score} label={cat.title+' ì ìˆ˜'}/>
              <div style={{marginTop:8}}>{cat.lines.map(function(l,j){
                if(l.type==='h3')return <div key={j} style={{fontSize:13,fontWeight:700,color:'#e8d5ff',margin:'10px 0 4px',borderBottom:'1px solid rgba(160,120,200,0.1)',paddingBottom:4}}>{l.text}</div>;
                if(l.type==='h4')return <div key={j} style={{fontSize:11,fontWeight:600,color:'#a090c0',margin:'8px 0 3px'}}>{'â˜… '+l.text}</div>;
                if(l.tag)return <Tag key={j} text={l.tag} color={l.c}/>;
                return <div key={j} style={{fontSize:11,lineHeight:1.8,color:l.w?'#e0a060':'#b0a8c0',margin:'2px 0',paddingLeft:8}}>{toMansin(l.t)}</div>;
              })}</div>
          {aiCache[cat.title]&&<div style={{fontSize:10,color:"#8060c0",marginTop:6,fontStyle:"italic"}}>âœ“ í•´ì„¤ ì™„ë£Œ</div>}
          <button onClick={function(){openAiDetail(cat.title,cat.title,linesToText(cat.lines));}} style={{marginTop:8,background:"rgba(130,100,200,0.08)",border:"1px solid rgba(160,120,200,0.15)",borderRadius:6,padding:"8px 14px",fontSize:11,color:"#8070a0",cursor:"pointer",display:"block",width:"100%"}}>{aiCache[cat.title]?"ğŸ”® í•´ì„¤ ë‹¤ì‹œ ë³´ê¸°":"ğŸ”® ë°”ë¦¬ë§Œì‹  ì‹¬ì¸µ í•´ì„¤"}</button>
            </div>
          );})}
        </div>
      )}

      {/* â”â”â” íƒ­4: ìš´ì„¸íë¦„ â”â”â” */}
      {paidTab==='ìš´ì„¸íë¦„'&&(
        <div style={{animation:'fadeUp 0.4s ease'}}>
          <div style={{fontSize:15,fontWeight:700,color:'#d0b0ff',fontFamily:"'Noto Serif KR',serif",marginBottom:10}}>ğŸ“… í–¥í›„ 10ë…„ ë…„ìš´</div>
          <button onClick={function(){var ys=premium.ë…„ìš´.map(function(y){return y.ì—°ë„+"ë…„("+y.ë‚˜ì´+"ì„¸) "+y.ê°„ì§€+" "+y.gSS+"/"+y.jSS+" "+y.í•´ì„.join(", ");}).join("\n");openAiDetail("ë…„ìš´","10ë…„ ìš´ì„¸ ì´í‰","í–¥í›„ 10ë…„ ë…„ìš´:\n"+ys);}} style={{width:"100%",marginBottom:12,background:"rgba(130,100,200,0.08)",border:"1px solid rgba(160,120,200,0.15)",borderRadius:6,padding:"10px",fontSize:12,fontWeight:600,color:"#a090d0",cursor:"pointer"}}>{aiCache["ë…„ìš´"]?"ğŸ”® 10ë…„ ì´í‰ ë‹¤ì‹œ ë³´ê¸°":"ğŸ”® ë°”ë¦¬ë§Œì‹ ì˜ 10ë…„ ì´í‰"}</button>
          {aiCache["ë…„ìš´"]&&<div style={{fontSize:10,color:"#8060c0",marginBottom:8,fontStyle:"italic"}}>âœ“ 10ë…„ ì´í‰ í•´ì„¤ ì™„ë£Œ</div>}
          {premium.ë…„ìš´.map(function(y,i){return(
            <div key={i} style={{marginBottom:8,background:'rgba(160,120,200,0.04)',border:'1px solid rgba(160,120,200,0.06)',borderRadius:8,padding:'10px'}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:4}}>
                <span style={{fontSize:12,fontWeight:700,color:'#d0b0ff'}}>{y.ì—°ë„}ë…„ ({y.ë‚˜ì´}ì„¸)</span>
                <span style={{fontSize:10,color:'#8a7e9d'}}>{y.ê°„ì§€} ({y.gSS}/{y.jSS})</span>
              </div>
              <ScoreBar score={y.sc} label="ë…„ìš´"/>
              {y.tags.map(function(t,j){return <Tag key={j} text={t.t} color={t.c}/>;})}{y.í•´ì„.map(function(h,j){return <div key={j} style={{fontSize:10,lineHeight:1.6,color:'#a098b0'}}>{h}</div>;})}
            </div>
          );})}
          <div style={{fontSize:15,fontWeight:700,color:'#d0b0ff',fontFamily:"'Noto Serif KR',serif",margin:'24px 0 10px'}}>ğŸ—“ï¸ 2026ë…„ ì›”ìš´</div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:6}}>
            {premium.ì›”ìš´.map(function(m,i){return(
              <div key={i} style={{background:'rgba(160,120,200,0.05)',border:'1px solid rgba(160,120,200,0.06)',borderRadius:8,padding:'10px',textAlign:'center'}}>
                <div style={{fontSize:10,fontWeight:700,color:'#c0a0e0'}}>{m.ì›”}</div>
                <div style={{fontSize:12,color:'#d0b0ff',fontWeight:600}}>{m.ê°„ì§€}</div>
                <div style={{fontSize:10,color:'#a098b0'}}>{m.ss}</div>
                <div style={{fontSize:10,color:'#e8d5a8',fontWeight:600,marginTop:2}}>{m.í•œì¤„}</div>
              </div>
            );})}
          </div>
        </div>
      )}

      {/* í•˜ë‹¨ ë²„íŠ¼ */}
      <div style={{marginTop:24,display:'flex',flexDirection:'column',gap:8}}>
        <button onClick={function(){
          var scored=MOCK_USERS.filter(function(u){return u.gender!==form.gender;}).map(function(u){return Object.assign({},u,{score:matchScore(result.saju,u.saju,form.gender,u.gender)});}).sort(function(a,b){return b.score-a.score;});
          setMatches(scored);setPhase('matches');
        }} style={{width:'100%',background:'linear-gradient(135deg,#8060c0,#5030a0)',border:'none',borderRadius:8,padding:'14px',fontSize:14,fontWeight:700,color:'#fff',cursor:'pointer',boxShadow:'0 4px 16px rgba(100,60,180,0.3)'}}>ì¸ì—° ë§¤ì¹­ ì‹œì‘í•˜ê¸° ğŸ’œ</button>
        <button onClick={function(){setPhase('result');}} style={{width:'100%',background:'transparent',border:'1px solid rgba(160,120,200,0.15)',borderRadius:8,padding:'10px',fontSize:11,color:'#6050a0',cursor:'pointer'}}>ë¬´ë£Œ ì‚¬ì£¼ ê²°ê³¼ë¡œ ëŒì•„ê°€ê¸°</button>
        <button onClick={function(){setPhase('form');setResult(null);setPremium(null);setAiCache({});}} style={{width:'100%',background:'transparent',border:'1px solid rgba(160,120,200,0.08)',borderRadius:8,padding:'10px',fontSize:11,color:'#4a3a60',cursor:'pointer'}}>ë‹¤ë¥¸ ì‚¬ì£¼ ë³´ê¸°</button>
      </div>

      <style>{`@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}div::-webkit-scrollbar{width:0;height:0;display:none;}`}</style>
    </div>
  );


  // ============================================================
  // AI ì‹¬ì¸µí•´ì„¤ í˜ì´ì§€ â€” í’€ìŠ¤í¬ë¦° í€˜ìŠ¤íŠ¸ ëŒ€í™”
  // ============================================================
  if(phase==='aiDetail'){
    var rawText=aiCache[aiDetailKey]||'';
    var isLoading=!!aiLoading&&!rawText;
    var bubbles=makeBubbles(rawText, aiDetailTitle);

    return(
    <div style={{height:'100vh',overflowY:'auto',scrollSnapType:'y mandatory',WebkitOverflowScrolling:'touch',background:'radial-gradient(ellipse at 50% 10%,#1a1028,#08040a)',fontFamily:"'Noto Sans KR',sans-serif"}}>

      {/* ë¡œë”© í™”ë©´ */}
      {isLoading&&(
        <div style={{height:'100vh',scrollSnapAlign:'start',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',padding:32}}>
          <BariMansin size={90}/>
          <div style={{marginTop:20,textAlign:'center'}}>
            <p style={{fontSize:14,lineHeight:1.9,color:'#c0b8d0'}}>í ... ì²œê¸°ë¥¼ ì‚´í”¼ëŠ” ì¤‘ì´ë‹ˆ<br/>ì ì‹œ ê¸°ë‹¤ë ¤ë¼.</p>
            <div style={{marginTop:12,width:80,height:3,background:'rgba(160,120,200,0.1)',borderRadius:2,overflow:'hidden',margin:'12px auto 0'}}>
              <div style={{width:'100%',height:'100%',background:'linear-gradient(90deg,#8060c0,#d0b0ff)',animation:'loadBar 1.5s ease infinite'}}/>
            </div>
          </div>
          <button onClick={function(){setPhase('premium');}} style={{marginTop:32,background:'transparent',border:'1px solid rgba(160,120,200,0.12)',borderRadius:8,padding:'8px 20px',fontSize:11,color:'#6050a0',cursor:'pointer'}}>ëŒì•„ê°€ê¸°</button>
        </div>
      )}

      {/* ì—ëŸ¬ í™”ë©´ */}
      {!isLoading&&!rawText&&(
        <div style={{height:'100vh',scrollSnapAlign:'start',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',padding:32}}>
          <BariMansin size={70}/>
          <p style={{fontSize:14,color:'#a090c0',margin:'16px 0 6px'}}>ì²œê¸°ë¥¼ ì½ëŠ” ë° ë°©í•´ê°€ ìˆì—ˆëŠë‹ˆë¼.</p>
          {aiError&&<p style={{fontSize:10,color:'#6050a0',margin:'4px 24px 16px',wordBreak:'break-all',textAlign:'center',lineHeight:1.6}}>{aiError}</p>}
          <div style={{display:'flex',gap:8}}>
            <button onClick={retryAiDetail} style={{background:'linear-gradient(135deg,#8060c0,#5030a0)',border:'none',borderRadius:8,padding:'10px 20px',fontSize:12,fontWeight:600,color:'#fff',cursor:'pointer'}}>ë‹¤ì‹œ ì‹œë„</button>
            <button onClick={function(){setPhase('premium');}} style={{background:'transparent',border:'1px solid rgba(160,120,200,0.15)',borderRadius:8,padding:'10px 20px',fontSize:12,color:'#8070a0',cursor:'pointer'}}>ëŒì•„ê°€ê¸°</button>
          </div>
        </div>
      )}

      {/* ëŒ€í™” ì”¬ */}
      {bubbles.map(function(b, i) {
        var isBari = b.who === 'bari';
        var isLast = i === bubbles.length - 1;
        return (
          <div key={i} style={{
            minHeight:'100vh',
            scrollSnapAlign:'start',
            display:'flex',
            flexDirection:'column',
            alignItems:'center',
            justifyContent:'center',
            padding:'40px 24px',
            boxSizing:'border-box',
            position:'relative',
          }}>
            {/* ë°°ê²½ íŒŒí‹°í´ */}
            {i<3&&<div style={{position:'absolute',top:0,left:0,right:0,bottom:0,pointerEvents:'none'}}>
              <div style={{position:'absolute',top:'12%',left:'15%',width:4,height:4,borderRadius:2,background:isBari?'rgba(160,120,200,0.12)':'rgba(180,140,80,0.12)',animation:'float1 5s ease infinite'}}/>
              <div style={{position:'absolute',bottom:'20%',right:'12%',width:3,height:3,borderRadius:2,background:isBari?'rgba(160,120,200,0.08)':'rgba(180,140,80,0.08)',animation:'float2 4s ease infinite'}}/>
            </div>}

            {/* ìºë¦­í„° */}
            <div style={{marginBottom:20,animation:'fadeUp 0.5s ease'}}>
              {isBari ? <BariMansin size={80}/> : <CatFace size={70}/>}
            </div>

            {/* ë§í’ì„  */}
            <div style={{
              maxWidth:340,
              width:'100%',
              background: isBari ? 'rgba(160,120,200,0.06)' : 'rgba(180,140,80,0.06)',
              border: '1px solid ' + (isBari ? 'rgba(160,120,200,0.12)' : 'rgba(180,140,80,0.12)'),
              borderRadius:16,
              padding:'18px 20px',
              position:'relative',
              animation:'fadeUp 0.6s ease',
            }}>
              {/* ê¼¬ë¦¬ */}
              <div style={{position:'absolute',top:-8,left:'50%',marginLeft:-8,width:0,height:0,borderLeft:'8px solid transparent',borderRight:'8px solid transparent',borderBottom:'8px solid '+(isBari?'rgba(160,120,200,0.12)':'rgba(180,140,80,0.12)')}}/>
              <div style={{
                whiteSpace:'pre-wrap',
                fontSize:13,
                lineHeight:2.0,
                color: isBari ? '#c8c0d8' : '#c0b8a0',
                textAlign:'center',
              }}>{isBari ? renderBoldText(b.text) : b.text}</div>
            </div>

            {/* í•˜ë‹¨ ì•ˆë‚´ */}
            {!isLast&&(
              <div style={{marginTop:24,animation:'fadeUp 0.8s ease',opacity:0.4}}>
                <div style={{fontSize:10,color:isBari?'#6050a0':'#5a5040',textAlign:'center'}}>â†“ ìŠ¤í¬ë¡¤</div>
              </div>
            )}

            {/* ë§ˆì§€ë§‰: ì¶œì²˜ + ëŒì•„ê°€ê¸° */}
            {isLast&&(
              <div style={{marginTop:24,textAlign:'center'}}>
                <p style={{fontSize:9,color:'#4a3a60',fontStyle:'italic',margin:'0 0 16px'}}>
                  ìí‰ì§„ì „ Â· ì ì²œìˆ˜ Â· ê¶í†µë³´ê° ë“± ê³ ì „ ëª…ë¦¬ì„œì˜ ì´ë¡ ì— ê·¼ê±°
                </p>
                <button onClick={function(){setPhase('premium');}} style={{background:'linear-gradient(135deg,#8060c0,#5030a0)',border:'none',borderRadius:10,padding:'12px 32px',fontSize:13,fontWeight:600,color:'#fff',cursor:'pointer'}}>ëŒì•„ê°€ê¸°</button>
              </div>
            )}
          </div>
        );
      })}

      <style>{'@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}@keyframes float1{0%,100%{transform:translateY(0)}50%{transform:translateY(-20px)}}@keyframes float2{0%,100%{transform:translateY(0) translateX(0)}50%{transform:translateY(-15px) translateX(8px)}}@keyframes loadBar{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}'}</style>
    </div>
  );}




  // ============================================================
  // ì»·ì”¬: ê³ ì–‘ì´ â†’ ë°”ë¦¬ë§Œì‹  ë°”í†¤í„°ì¹˜
  // ============================================================

  if(phase==='transition'&&result)return(
    <div style={{minHeight:'100vh',background:'radial-gradient(ellipse at 50% 20%,#12080c,#08040a)',fontFamily:"'Noto Sans KR',sans-serif",padding:'60px 20px 40px',maxWidth:440,margin:'0 auto',textAlign:'center',overflowY:'auto'}}>

      {/* Step 0: ê³ ì–‘ì´ ë“±ì¥ */}
      <div style={{opacity:transStep>=0?1:0,transform:transStep>=0?'translateY(0) scale(1)':'translateY(60px) scale(0.5)',transition:'opacity 0.8s cubic-bezier(0.34,1.56,0.64,1),transform 0.8s cubic-bezier(0.34,1.56,0.64,1)',marginBottom:16}}>
        <CatFace size={80}/>
      </div>

      {/* Step 1: ê³ ì–‘ì´ ëŒ€ì‚¬ */}
      {transStep>=1&&(
        <div style={{animation:'fadeUp 0.6s ease',marginBottom:32,maxWidth:320,margin:'0 auto 32px'}}>
          <div style={{background:'rgba(180,140,80,0.06)',border:'1px solid rgba(180,140,80,0.15)',borderRadius:16,padding:'14px 18px',position:'relative'}}>
            <div style={{position:'absolute',top:-8,left:'50%',marginLeft:-8,width:0,height:0,borderLeft:'8px solid transparent',borderRight:'8px solid transparent',borderBottom:'8px solid rgba(180,140,80,0.15)'}}/>
            <p style={{fontSize:13,lineHeight:1.9,color:'#c0b8a0',margin:0}}>
              ìŠ¤ìŠ¹ë‹˜! ì´ ë¶„ì˜ ì‚¬ì£¼ë¥¼ ë´ë“œë ¸ëŠ”ë°ìš”...<br/>
              <b style={{color:'#e8d5a8'}}>{result.ì¼ê°„}{result.ì¼ì§€}ì¼ì£¼</b>, <b style={{color:'#e8d5a8'}}>{result.ê²©êµ­}</b>ì— <b style={{color:'#e8d5a8'}}>{result.ê°•ì•½}</b>ì´ì—ìš”.<br/>
              ì œ ì‹¤ë ¥ìœ¼ë¡  ì—¬ê¸°ê¹Œì§€ê°€ í•œê³„ì—ìš”...
            </p>
          </div>
        </div>
      )}

      {/* Step 2: ë°”ë¦¬ë§Œì‹  ë“±ì¥ */}
      {transStep>=2&&(
        <div style={{opacity:transStep>=2?1:0,transform:transStep>=2?'translateX(0) scale(1)':'translateX(80px) scale(0.5)',transition:'opacity 1s cubic-bezier(0.34,1.56,0.64,1),transform 1s cubic-bezier(0.34,1.56,0.64,1)',marginBottom:16,position:'relative'}}>
          <div style={{position:'absolute',top:-20,left:'50%',marginLeft:-60,width:120,height:120,borderRadius:60,background:'radial-gradient(circle,rgba(160,120,200,0.15),transparent)',animation:'pulse 2s ease infinite'}}/>
          <BariMansin size={100}/>
        </div>
      )}

      {/* Step 3: ë°”ë¦¬ë§Œì‹  ëŒ€ì‚¬ 1 */}
      {transStep>=3&&(
        <div style={{animation:'fadeUp 0.6s ease',marginBottom:16,maxWidth:320,margin:'0 auto 16px'}}>
          <div style={{background:'rgba(160,120,200,0.06)',border:'1px solid rgba(160,120,200,0.15)',borderRadius:16,padding:'14px 18px',position:'relative'}}>
            <div style={{position:'absolute',top:-8,left:'50%',marginLeft:-8,width:0,height:0,borderLeft:'8px solid transparent',borderRight:'8px solid transparent',borderBottom:'8px solid rgba(160,120,200,0.15)'}}/>
            <p style={{fontSize:13,lineHeight:1.9,color:'#c0b8d0',margin:0}}>
              í—ˆí—ˆ, ì–´ë”” ë³´ìê¾¸ë‚˜...<br/>
              <b style={{color:'#d0b0ff'}}>{result.ì¼ê°„}{result.ì¼ì§€}</b>ë¼.
              {result.ê°•ì•½==='ì‹ ê°•'?' ê¸°ìš´ì´ ë„˜ì¹˜ëŠ” ëª…ì‹ì´ë¡œêµ¬ë‚˜. ì„¤ê¸°(æ´©æ°£)ì™€ ê·¹ì œ(å…‹åˆ¶)ì˜ ê· í˜•ì´ ê´€ê±´ì´ê² ì–´.':' ê¸°ìš´ì´ ì•½í•œ ëª…ì‹ì´ë‹ˆ, ì¸ì„±ê³¼ ë¹„ê²ì˜ ë„ì›€ì´ ì ˆì‹¤í•˜ê² êµ¬ë‚˜.'}
            </p>
          </div>
        </div>
      )}

      {/* Step 4: ë°”ë¦¬ë§Œì‹  ëŒ€ì‚¬ 2 â€” ì „ë¬¸ì„± */}
      {transStep>=4&&(
        <div style={{animation:'fadeUp 0.6s ease',marginBottom:20,maxWidth:340,margin:'0 auto 20px'}}>
          <div style={{background:'rgba(160,120,200,0.06)',border:'1px solid rgba(160,120,200,0.12)',borderRadius:16,padding:'14px 18px'}}>
            <p style={{fontSize:13,lineHeight:1.9,color:'#c0b8d0',margin:0}}>
              ì¢‹ë‹¤. <b style={{color:'#d0b0ff'}}>ìí‰ì§„ì „(å­å¹³çœè©®)</b>ê³¼ <b style={{color:'#d0b0ff'}}>ì ì²œìˆ˜(æ»´å¤©é«“)</b>ì˜ ì´ì¹˜ë¡œ,<br/>
              í•©ì¶©í˜•í•´íŒŒ(åˆæ²–åˆ‘å®³ç ´)ë¥¼ ë‚±ë‚±ì´ ì‚´í”¼ê³ <br/>
              <b style={{color:'#d0b0ff'}}>ì™•ìì¶©ì‡ (æ—ºè€…æ²–è¡°)</b>ì˜ ì›ë¦¬ë¡œ ëŒ€ìš´ì˜ íë¦„ê¹Œì§€...<br/>
              ì¬ë¬¼Â·ê±´ê°•Â·ì¸ì—° ëª¨ë“  ê²ƒì„ ë°í˜€ì£¼ë§ˆ.
            </p>
            <p style={{fontSize:9,color:'#6050a0',marginTop:8,marginBottom:0,fontStyle:'italic'}}>
              ìí‰ì§„ì „ Â· ì ì²œìˆ˜ Â· ê¶í†µë³´ê° ë“± ê³ ì „ ëª…ë¦¬ì„œì˜ ì´ë¡ ì— ê·¼ê±°
            </p>
          </div>
        </div>
      )}

      {/* Step 5: ë²„íŠ¼ */}
      {transStep>=5&&(
        <div style={{animation:'fadeUp 0.8s ease',margin:'20px auto 0',maxWidth:320}}>
          <div style={{fontSize:11,color:'#9080b0',lineHeight:1.7,margin:'0 0 12px'}}>
            ê±´ê°•Â·ì„±ê²©Â·ìš©ëª¨Â·ì‚¬ê±´ì‚¬ê³ Â·ê°€ì¡±ê´€ê³„<br/>
            ì¬ë¬¼Â·ì§ì—…Â·ì ì„± Â· ëŒ€ìš´ë³„ ì¬ë¬¼ íë¦„<br/>
            <b>10ë…„ ë…„ìš´ + ì›”ìš´</b> ì´ 16ê°œ í•­ëª©
          </div>
          <button onClick={function(){
            if(!result)return;
            var p=genPremium(result,result.birthYear);
            setPremium(p);
            setPaidTab('ê°œì¸íŠ¹ì„±');
            setPhase('premium');
          }} style={{width:'100%',background:'linear-gradient(135deg,#8060c0,#5030a0)',border:'none',borderRadius:10,padding:'15px',fontSize:15,fontWeight:700,color:'#fff',cursor:'pointer',boxShadow:'0 4px 20px rgba(100,60,180,0.4)',letterSpacing:1}}>
            ë°”ë¦¬ë§Œì‹ ì˜ ì‹¬ì¸µ í•´ì„ ì—´ê¸° ğŸ”®
          </button>
          <p style={{fontSize:9,color:'#4a3a60',marginTop:8}}>* ë°ëª¨: ê²°ì œ ì—†ì´ ì²´í—˜ Â· ì‹¤ì„œë¹„ìŠ¤ â‚©3,000~â‚©10,000</p>
          <button onClick={function(){setPhase('result');}} style={{marginTop:8,background:'transparent',border:'none',color:'#4a3a60',fontSize:10,cursor:'pointer',textDecoration:'underline'}}>ëŒì•„ê°€ê¸°</button>
        </div>
      )}

      <style>{
        '@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}'
        +'@keyframes float1{0%,100%{transform:translateY(0)}50%{transform:translateY(-20px)}}'
        +'@keyframes float2{0%,100%{transform:translateY(0) translateX(0)}50%{transform:translateY(-15px) translateX(10px)}}'
        +'@keyframes pulse{0%,100%{opacity:0.3;transform:scale(1)}50%{opacity:0.6;transform:scale(1.1)}}'
      }</style>
    </div>
  );

  // ============================================================
  // ë§¤ì¹­ ëª©ë¡ í™”ë©´
  // ============================================================
  if(phase==='matches')return(
    <div style={{minHeight:'100vh',background:'radial-gradient(ellipse at 50% 15%,#1a1028,#0e0a18)',color:'#e8d5a8',fontFamily:"'Noto Sans KR',sans-serif",padding:'20px 16px 60px',maxWidth:440,margin:'0 auto'}}>
      <div style={{textAlign:'center',marginBottom:16}}>
        <BariMansin size={50}/>
        <h2 style={{fontSize:16,fontWeight:700,fontFamily:"'Noto Serif KR',serif",margin:'8px 0'}}><span style={{background:'linear-gradient(135deg,#d0b0ff,#8060c0)',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent'}}>ì¸ì—° ë§¤ì¹­ ê²°ê³¼</span></h2>
        <p style={{fontSize:11,color:'#8070a0'}}>{result.ì¼ê°„}{result.ì¼ì§€}ì¼ì£¼({form.gender}) Â· ê¶í•© ë†’ì€ ìˆœ</p>
      </div>

      {matches.map(function(u,i){
        var gc=u.score>=75?'#60a060':u.score>=60?'#a0a060':u.score>=45?'#c0a040':'#a06060';
        var gr=u.score>=85?'ì²œìƒì—°ë¶„':u.score>=75?'ìƒí•©':u.score>=65?'ê¸¸í•©':u.score>=50?'ë³´í†µ':'ì†Œí‰';
        return(
          <div key={u.id} style={{background:'rgba(160,120,200,0.04)',border:'1px solid rgba(160,120,200,0.1)',borderRadius:12,padding:'12px',marginBottom:8,display:'flex',gap:12,alignItems:'center'}}>
            <div style={{minWidth:44,textAlign:'center'}}>
              <div style={{width:44,height:44,borderRadius:22,background:'linear-gradient(135deg,'+gc+',#2a2040)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:20,fontWeight:700,color:'#fff',fontFamily:'serif'}}>{u.saju.dg}</div>
              <div style={{fontSize:8,color:gc,fontWeight:700,marginTop:2}}>{gr}</div>
            </div>
            <div style={{flex:1}}>
              <div style={{display:'flex',alignItems:'center',gap:6}}>
                <span style={{fontSize:14,fontWeight:700,color:'#d0b0ff'}}>{u.name}</span>
                <span style={{fontSize:10,color:'#6050a0'}}>{u.age}ì„¸ Â· {u.saju.dg}{u.saju.dj}</span>
              </div>
              <div style={{fontSize:10,color:'#8070a0',marginTop:2}}>{u.bio}</div>
              <div style={{display:'flex',alignItems:'center',gap:6,marginTop:4}}>
                <div style={{flex:1,height:10,borderRadius:3,overflow:'hidden',background:'#201830'}}><div style={{width:u.score+'%',height:'100%',background:'linear-gradient(90deg,'+gc+',#4a3a60)',borderRadius:3}}/></div>
                <span style={{fontSize:12,fontWeight:700,color:gc}}>{u.score}</span>
              </div>
            </div>
            <div style={{display:'flex',flexDirection:'column',gap:4}}>
              <button onClick={function(){setDetailTarget(u);}} style={{padding:'5px 10px',borderRadius:6,border:'1px solid rgba(160,120,200,0.2)',background:'transparent',color:'#a090d0',fontSize:10,cursor:'pointer'}}>ìƒì„¸</button>
              <button onClick={function(){setChatTarget(u);setPhase('chat');}} style={{padding:'5px 10px',borderRadius:6,border:'none',background:'linear-gradient(135deg,#8060c0,#5030a0)',color:'#fff',fontSize:10,fontWeight:700,cursor:'pointer'}}>ì±„íŒ…</button>
            </div>
          </div>
        );
      })}

      {/* ê¶í•© ìƒì„¸ ëª¨ë‹¬ */}
      {detailTarget&&(
        <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.85)',zIndex:100,display:'flex',alignItems:'center',justifyContent:'center',padding:16}} onClick={function(){setDetailTarget(null);}}>
          <div style={{background:'#1a1028',borderRadius:16,padding:'20px 16px',maxWidth:400,width:'100%',maxHeight:'80vh',overflowY:'auto',border:'1px solid rgba(160,120,200,0.2)'}} onClick={function(e){e.stopPropagation();}}>
            {(function(){
              var md=matchDetail(result.saju,detailTarget.saju,form.gender,detailTarget.gender);
              return(<div>
                <div style={{textAlign:'center',marginBottom:12}}>
                  <div style={{fontSize:11,color:'#8070a0'}}>{result.ì¼ê°„}{result.ì¼ì§€} vs {detailTarget.saju.dg}{detailTarget.saju.dj}</div>
                  <div style={{fontSize:36,fontWeight:800,color:md.score>=75?'#60a060':md.score>=50?'#c0a040':'#c06060'}}>{md.score}<span style={{fontSize:14}}>ì </span></div>
                  <div style={{fontSize:14,fontWeight:700,color:'#d0b0ff'}}>{md.grade}</div>
                  <div style={{display:'flex',gap:3,justifyContent:'center',marginTop:6,flexWrap:'wrap'}}>{md.tags.map(function(t,j){return <Tag key={j} text={t.t} color={t.c}/>;})}</div>
                </div>
                {md.details.map(function(line,j){
                  var w=line.indexOf('âš ')===0;
                  return <div key={j} style={{fontSize:12,lineHeight:1.8,color:w?'#d08060':'#c0b8d0',marginBottom:3,paddingLeft:8,borderLeft:w?'2px solid #c06050':'2px solid rgba(160,120,200,0.1)'}}>{line}</div>;
                })}
                <button onClick={function(){setDetailTarget(null);setChatTarget(detailTarget);setPhase('chat');}} style={{width:'100%',marginTop:16,background:'linear-gradient(135deg,#8060c0,#5030a0)',border:'none',borderRadius:8,padding:'12px',fontSize:14,fontWeight:700,color:'#fff',cursor:'pointer'}}>ì±„íŒ… ì‹œì‘í•˜ê¸° ğŸ’¬</button>
              </div>);
            })()}
            <button onClick={function(){setDetailTarget(null);}} style={{width:'100%',marginTop:8,background:'transparent',border:'1px solid rgba(160,120,200,0.15)',borderRadius:8,padding:'8px',fontSize:11,color:'#6050a0',cursor:'pointer'}}>ë‹«ê¸°</button>
          </div>
        </div>
      )}

      <button onClick={function(){setPhase('result');}} style={{width:'100%',marginTop:16,background:'transparent',border:'1px solid rgba(160,120,200,0.15)',borderRadius:8,padding:'10px',fontSize:12,color:'#6050a0',cursor:'pointer'}}>ì‚¬ì£¼ ê²°ê³¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
  );

  // ============================================================
  // ì±„íŒ… í™”ë©´
  // ============================================================
  if(phase==='chat'&&chatTarget)return(
    <div style={{minHeight:'100vh',background:'radial-gradient(ellipse at 50% 15%,#1a1028,#0e0a18)',color:'#e8d5a8',fontFamily:"'Noto Sans KR',sans-serif",display:'flex',flexDirection:'column',maxWidth:440,margin:'0 auto'}}>
      {/* í—¤ë” */}
      <div style={{display:'flex',alignItems:'center',gap:10,padding:'12px 16px',borderBottom:'1px solid rgba(160,120,200,0.1)',background:'rgba(160,120,200,0.04)'}}>
        <button onClick={function(){setPhase('matches');setChatTarget(null);}} style={{background:'transparent',border:'none',color:'#a090d0',fontSize:18,cursor:'pointer',padding:0}}>â†</button>
        <div style={{width:36,height:36,borderRadius:18,background:'linear-gradient(135deg,#8060c0,#4030a0)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:16,fontWeight:700,color:'#fff',fontFamily:'serif'}}>{chatTarget.saju.dg}</div>
        <div style={{flex:1}}>
          <div style={{fontSize:14,fontWeight:700,color:'#d0b0ff'}}>{chatTarget.name}</div>
          <div style={{fontSize:10,color:'#6050a0'}}>{chatTarget.saju.dg}{chatTarget.saju.dj}ì¼ì£¼ Â· ê¶í•© {chatTarget.score}ì </div>
        </div>
        <button onClick={function(){setDetailTarget(chatTarget);}} style={{padding:'4px 10px',borderRadius:12,border:'1px solid rgba(160,120,200,0.2)',background:'transparent',color:'#8070a0',fontSize:10,cursor:'pointer'}}>ê¶í•©</button>
      </div>

      {/* ë©”ì‹œì§€ */}
      <div ref={chatRef} style={{flex:1,overflowY:'auto',padding:'12px 16px',display:'flex',flexDirection:'column',gap:6,minHeight:300}}>
        <div style={{textAlign:'center',padding:'16px 12px',background:'rgba(160,120,200,0.06)',borderRadius:12,marginBottom:8}}>
          <div style={{fontSize:11,color:'#8070a0'}}>ë°”ë¦¬ë§Œì‹ ì´ ë§ºì–´ì¤€ ì¸ì—°</div>
          <div style={{fontSize:24,fontWeight:800,color:'#d0b0ff',margin:'4px 0'}}>{chatTarget.score}ì </div>
          {(function(){var md=matchDetail(result.saju,chatTarget.saju,form.gender,chatTarget.gender);return <div style={{display:'flex',gap:3,justifyContent:'center',flexWrap:'wrap'}}>{md.tags.map(function(t,j){return <Tag key={j} text={t.t} color={t.c}/>;})}</div>;})()}
          <div style={{fontSize:10,color:'#6050a0',marginTop:6}}>ì„œë¡œ ì¸ì‚¬ë¥¼ ë‚˜ëˆ ë³´ì„¸ìš”!</div>
        </div>
        {(chatMsgs[chatTarget.id]||[]).map(function(msg,i){
          var isMe=msg.from==='me';
          return(
            <div key={i} style={{display:'flex',justifyContent:isMe?'flex-end':'flex-start'}}>
              <div style={{maxWidth:'75%',padding:'8px 12px',borderRadius:isMe?'12px 12px 0 12px':'12px 12px 12px 0',background:isMe?'linear-gradient(135deg,#5030a0,#3020a0)':'rgba(160,120,200,0.08)',border:isMe?'none':'1px solid rgba(160,120,200,0.1)'}}>
                <div style={{fontSize:13,lineHeight:1.6,color:isMe?'#fff':'#c0b8d0'}}>{msg.text}</div>
                <div style={{fontSize:8,color:isMe?'rgba(255,255,255,0.4)':'#6050a0',marginTop:2,textAlign:isMe?'right':'left'}}>{msg.time}</div>
              </div>
            </div>
          );
        })}
      </div>

      {/* ì…ë ¥ */}
      <div style={{display:'flex',gap:8,padding:'12px 16px',borderTop:'1px solid rgba(160,120,200,0.1)',background:'rgba(160,120,200,0.02)'}}>
        <input value={chatInput} onChange={function(e){setChatInput(e.target.value);}} onKeyDown={function(e){if(e.key==='Enter')doSend();}} placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." style={{flex:1,padding:'10px 14px',borderRadius:20,border:'1px solid rgba(160,120,200,0.2)',background:'rgba(160,120,200,0.04)',color:'#d0b0ff',fontSize:13,outline:'none'}}/>
        <button onClick={doSend} style={{padding:'10px 16px',borderRadius:20,border:'none',background:chatInput.trim()?'linear-gradient(135deg,#8060c0,#5030a0)':'rgba(160,120,200,0.1)',color:chatInput.trim()?'#fff':'#6050a0',fontSize:13,fontWeight:700,cursor:'pointer'}}>ì „ì†¡</button>
      </div>

      {/* ê¶í•© ìƒì„¸ ëª¨ë‹¬ (ì±„íŒ… ë‚´) */}
      {detailTarget&&(
        <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.85)',zIndex:100,display:'flex',alignItems:'center',justifyContent:'center',padding:16}} onClick={function(){setDetailTarget(null);}}>
          <div style={{background:'#1a1028',borderRadius:16,padding:'20px 16px',maxWidth:400,width:'100%',maxHeight:'80vh',overflowY:'auto',border:'1px solid rgba(160,120,200,0.2)'}} onClick={function(e){e.stopPropagation();}}>
            {(function(){var md=matchDetail(result.saju,detailTarget.saju,form.gender,detailTarget.gender);return(<div><div style={{textAlign:'center',marginBottom:12}}><div style={{fontSize:36,fontWeight:800,color:md.score>=75?'#60a060':md.score>=50?'#c0a040':'#c06060'}}>{md.score}<span style={{fontSize:14}}>ì </span></div><div style={{fontSize:14,fontWeight:700,color:'#d0b0ff'}}>{md.grade}</div><div style={{display:'flex',gap:3,justifyContent:'center',marginTop:6,flexWrap:'wrap'}}>{md.tags.map(function(t,j){return <Tag key={j} text={t.t} color={t.c}/>;})}</div></div>{md.details.map(function(line,j){return <div key={j} style={{fontSize:12,lineHeight:1.8,color:line.indexOf('âš ')===0?'#d08060':'#c0b8d0',marginBottom:3,paddingLeft:8,borderLeft:'2px solid rgba(160,120,200,0.1)'}}>{line}</div>;})}</div>);})()}
            <button onClick={function(){setDetailTarget(null);}} style={{width:'100%',marginTop:12,background:'transparent',border:'1px solid rgba(160,120,200,0.15)',borderRadius:8,padding:'8px',fontSize:11,color:'#6050a0',cursor:'pointer'}}>ë‹«ê¸°</button>
          </div>
        </div>
      )}
    </div>
  );

  return null;
}
